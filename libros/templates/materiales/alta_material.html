{% extends 'components/baseb.html' %}
{% load static %}
{% block extra_styles %}
    <link rel="stylesheet" href="{% static 'css/libros/' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="{% static 'css/style_form.css' %}">
    <link rel="stylesheet" href="{% static 'css/botones.css' %}">
    <link rel="stylesheet" href="{% static 'css/confirmacion_carga_exitosa.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <form id="form_alta_material" action="{% url 'alta_material' %}" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <!-- Fila 1 -->
        <div class="row align-items-start">
            <!-- Formulario principal, columnas 1 a 10 (ahora responsive) -->
            <div class="col-12 col-lg-10">
                <div class="row">
                    <div class="col-12 col-sm-6 col-lg-2 form-group mb-2">
                        <label for="tipo_material" class="text-input" style="color:#25898D;">Tipo de Material:</label>
                        <select class="form-control form-control-sm" id="tipo_material" name="tipo_material" required>
                            <option value="">Selecciona un tipo de material</option>
                            <option value="libro">LIBRO</option>
                            <option value="mapa">MAPA</option>
                            <option value="multimedia">MULTIMEDIA</option>
                            <option value="notebook">NOTEBOOK</option>
                            <option value="programa">PROGRAMA</option>
                            <option value="proyector">PROYECTOR</option>
                            <option value="varios">VARIOS</option>
                        </select>
                    </div>
                    <div class="col-12 col-lg-8 mb-2"></div>
                </div>
                <!-- Aquí siguen las demás filas y el formulario dinámico (col-10) -->
                <div id="formulario-especifico" class="mt-2 row">
                    <!-- Los formularios se cargarán aquí dinámicamente -->
                </div>
            </div>
            <!-- Columna derecha, MANUAL y carga masiva, columnas 11 y 12 (responsive) -->
            <div class="col-12 col-lg-2 d-flex flex-column align-items-end mt-3 mt-lg-0">
                <!-- Fila 1: Botón MANUAL -->
                <div class="w-100 mb-2">
                    <button type="button" class="btn btn-dark btn-sm manual-button w-100" onclick="document.getElementById('manualModal').style.display='flex'">MANUAL</button>
                </div>
                <!-- Sección de carga (solo visible al seleccionar material) -->
                <div id="upload_simple_container" class="w-100 mb-4" style="display: none;">
                    <div class="upload-box w-100">
                        <small class="text-muted">Para carga masiva, suba un archivo CSV o Excel (.csv, .xls, .xlsx):</small>
                        <label for="cargar_archivo" class="d-block my-3">
                            <div class="boton-redondeado">
                                <span>↑</span>
                            </div>
                            <input type="file" id="cargar_archivo" name="cargar_archivo" accept=".csv, .xls, .xlsx" style="display: none;">
                        </label>
                        <div id="nombre_archivo_carga_simple" style="text-align:center;font-size:0.92em;color:#444;margin-top:6px;margin-bottom:2px;word-break:break-all;"></div>
                        <img id="img_simple_preview" style="max-width: 100%; margin-top: 10px; display: none;">
                    </div>
                </div>
                <!-- Fila 4/5: Carga de Imagen -->
                <div id="upload_box_container" class="custom-upload-box-container" style="display: none; width: 100%;">
                    <div class="custom-upload-box w-100">
                        <button class="btn btn-sm custom-upload-btn w-100" type="button" onclick="document.getElementById('file_upload_input').click();">↑</button>
                        <input type="file" id="file_upload_input" name="imagen" accept="image/*" style="display: none;">
                        <input type="text" id="url_upload_input" class="form-control custom-upload-input mb-2" placeholder="O pegue un enlace de imagen aquí..." name="img">
                    </div>
                </div>
            </div>
        </div>

        <!-- Fila de botones -->
        <div id="buttons-container" class="row bg-white px-0 mx-0" style="border:none; box-shadow:none; display: none;">
            <div class="col-12 d-flex justify-content-end gap-5">
                <button type="button" class="btn btn-outline-danger btn-sm boton-cancelar">Cancelar</button>
                <button type="button" class="btn btn-primary btn-sm boton-guardar" data-bs-toggle="modal" data-bs-target="#modalConfirmacionAltaMaterial">Guardar</button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block modals %}
  {% include 'modals/manual_modal.html' %}
  {% include 'modals/confirmacion_alta_material.html' %}
  {% include 'modals/confirmacion_carga_exitosa.html' %}
{% endblock %}

{% block extra_scripts %}
    <script src="{% static 'js/form_controler.js' %}" defer></script>
    <!-- Scripts resueltos sin conflictos -->
    <script src="{% static 'js/modals/confirmacion_alta_material.js' %}" defer></script>
    <script src="{% static 'js/confirmacion_carga_exitosa.js' %}" defer></script>
    
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById('form_alta_material');
        const btnGuardar = document.querySelector('.boton-guardar');
        const resumenDiv = document.getElementById('resumenAltaMaterial');
        const btnConfirmar = document.getElementById('btnConfirmarAltaMaterial');
        const tipoMaterial = document.getElementById('tipo_material');
        const uploadSimple = document.getElementById('upload_simple_container');
        const uploadBox = document.getElementById('upload_box_container');
        const buttonsContainer = document.getElementById('buttons-container');

        // Mostrar resumen al abrir el modal
        if (btnGuardar && resumenDiv && form) {
            btnGuardar.addEventListener('click', function () {
                const formData = new FormData(form);
                let resumen = '<h6 class="mb-2">Resumen de datos ingresados:</h6><ul style="padding-left: 1.1em;">';

                // Imagen (archivo o URL)
                let imagenHtml = '-';
                const imagenFile = formData.get('imagen');
                const urlInput = document.getElementById('url_upload_input');
                const urlValue = urlInput ? urlInput.value.trim() : '';
                
                if (imagenFile && imagenFile.name) {
                    const imgURL = URL.createObjectURL(imagenFile);
                    imagenHtml = `<br><img src="${imgURL}" alt="Previsualización" style="max-width:100px;max-height:100px;"/>`;
                } else if (urlValue) {
                    imagenHtml = `<br><img src="${urlValue}" alt="Previsualización" style="max-width:100px;max-height:100px;"/>`;
                }
                resumen += `<li><b>Imagen:</b> ${imagenHtml}</li>`;
                
                // Campos principales basados en el tipo seleccionado
                resumen += `<li><b>Tipo de material:</b> ${formData.get('tipo_material') || '-'}</li>`;
                
                // Campos específicos según el tipo
                const tipo = formData.get('tipo_material');
                switch(tipo) {
                    case 'libro':
                        resumen += `<li><b>Título:</b> ${formData.get('titulo') || '-'}</li>`;
                        resumen += `<li><b>Autor:</b> ${formData.get('autor') || '-'}</li>`;
                        resumen += `<li><b>Editorial:</b> ${formData.get('editorial') || '-'}</li>`;
                        resumen += `<li><b>Clasificación CDU:</b> ${formData.get('clasificacion_cdu') || '-'}</li>`;
                        resumen += `<li><b>Siglas Autor:</b> ${formData.get('siglas_autor_titulo') || '-'}</li>`;
                        resumen += `<li><b>Palabras clave:</b> ${formData.get('etiqueta_palabra_clave') || '-'}</li>`;
                        resumen += `<li><b>Sede:</b> ${formData.get('sede') || '-'}</li>`;
                        resumen += `<li><b>Disponibilidad:</b> ${formData.get('disponibilidad') || '-'}</li>`;
                        resumen += `<li><b>Observaciones:</b> ${formData.get('observaciones') || '-'}</li>`;
                        break;
                    case 'mapa':
                        resumen += `<li><b>Tipo:</b> ${formData.get('tipo') || '-'}</li>`;
                        break;
                    case 'multimedia':
                        resumen += `<li><b>Materia:</b> ${formData.get('materia') || '-'}</li>`;
                        resumen += `<li><b>Contenido:</b> ${formData.get('contenido') || '-'}</li>`;
                        break;
                    case 'notebook':
                        resumen += `<li><b>Marca:</b> ${formData.get('marca_not') || '-'}</li>`;
                        resumen += `<li><b>Modelo:</b> ${formData.get('modelo_not') || '-'}</li>`;
                        break;
                    case 'proyector':
                        resumen += `<li><b>Marca:</b> ${formData.get('marca_pro') || '-'}</li>`;
                        resumen += `<li><b>Modelo:</b> ${formData.get('modelo_pro') || '-'}</li>`;
                        break;
                    case 'varios':
                        resumen += `<li><b>Tipo:</b> ${formData.get('tipo') || '-'}</li>`;
                        break;
                }
                
                if (formData.get('descripcion')) {
                    resumen += `<li><b>Descripción:</b> ${formData.get('descripcion')}</li>`;
                }
                if (formData.get('num_ejemplar')) {
                    resumen += `<li><b>Número de ejemplar:</b> ${formData.get('num_ejemplar')}</li>`;
                }

                resumen += '</ul>';
                resumenDiv.innerHTML = resumen;
            });
        }

        // Mostrar/ocultar secciones según el tipo de material seleccionado
        if (tipoMaterial && uploadSimple && uploadBox && buttonsContainer) {
            tipoMaterial.addEventListener('change', function() {
                if (tipoMaterial.value) {
                    uploadSimple.style.display = 'block';
                    uploadBox.style.display = 'block';
                    buttonsContainer.style.display = 'flex';
                    
                    // Cargar formulario específico
                    cargarFormularioEspecifico(tipoMaterial.value);
                } else {
                    uploadSimple.style.display = 'none';
                    uploadBox.style.display = 'none';
                    buttonsContainer.style.display = 'none';
                    
                    // Limpiar formulario específico
                    document.getElementById('formulario-especifico').innerHTML = '';
                }
            });
        }

        // Cambiar el action del formulario según el tipo de material seleccionado
        if (form && tipoMaterial) {
            function actualizarAction() {
                switch (tipoMaterial.value) {
                    case 'libro':
                        form.action = '{% url "alta_libro" %}';
                        break;
                    case 'mapa':
                        form.action = '{% url "alta_mapa" %}';
                        break;
                    case 'multimedia':
                        form.action = '{% url "alta_multimedia" %}';
                        break;
                    case 'notebook':
                        form.action = '{% url "alta_notebook" %}';
                        break;
                    case 'proyector':
                        form.action = '{% url "alta_proyector" %}';
                        break;
                    case 'varios':
                        form.action = '{% url "alta_varios" %}';
                        break;
                    case 'programa':
                        form.action = '{% url "alta_programa" %}';
                        break;
                    default:
                        form.action = '{% url "alta_material" %}';
                }
            }
            
            tipoMaterial.addEventListener('change', actualizarAction);
            actualizarAction(); // Inicializa el action al cargar la página
        }
        
        // Manejar carga de archivos CSV/Excel
        const cargarArchivo = document.getElementById('cargar_archivo');
        const nombreArchivo = document.getElementById('nombre_archivo_carga_simple');
        
        if (cargarArchivo && nombreArchivo) {
            cargarArchivo.addEventListener('change', function() {
                if (this.files && this.files.length > 0) {
                    nombreArchivo.textContent = this.files[0].name;
                } else {
                    nombreArchivo.textContent = '';
                }
            });
        }
        
        // Manejar preview de imagen
        const fileUploadInput = document.getElementById('file_upload_input');
        const urlUploadInput = document.getElementById('url_upload_input');
        
        if (fileUploadInput) {
            fileUploadInput.addEventListener('change', function() {
                if (this.files && this.files.length > 0) {
                    const file = this.files[0];
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            // Mostrar preview si hay un elemento para ello
                            const preview = document.getElementById('img_simple_preview');
                            if (preview) {
                                preview.src = e.target.result;
                                preview.style.display = 'block';
                            }
                        };
                        reader.readAsDataURL(file);
                        
                        // Limpiar URL input si se sube archivo
                        if (urlUploadInput) {
                            urlUploadInput.value = '';
                        }
                    }
                }
            });
        }
        
        // Función para cargar formulario específico según tipo de material
        // Estos campos corresponden exactamente a los forms.py que tienes
        function cargarFormularioEspecifico(tipo) {
            const container = document.getElementById('formulario-especifico');
            let html = '';
            
            switch (tipo) {
                case 'libro':
                    // Campos del LibroForm
                    html = `
                        <div class="col-12 col-md-6 col-lg-4 form-group mb-2">
                            <label for="titulo" class="text-input" style="color:#25898D;">Título: <span style="color:red;">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="titulo" name="titulo" required>
                        </div>
                        <div class="col-12 col-md-6 col-lg-4 form-group mb-2">
                            <label for="autor" class="text-input" style="color:#25898D;">Autor: <span style="color:red;">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="autor" name="autor" required>
                        </div>
                        <div class="col-12 col-md-6 col-lg-4 form-group mb-2">
                            <label for="editorial" class="text-input" style="color:#25898D;">Editorial:</label>
                            <input type="text" class="form-control form-control-sm" id="editorial" name="editorial">
                        </div>
                        <div class="col-12 col-md-6 col-lg-4 form-group mb-2">
                            <label for="clasificacion_cdu" class="text-input" style="color:#25898D;">Clasificación CDU:</label>
                            <input type="text" class="form-control form-control-sm" id="clasificacion_cdu" name="clasificacion_cdu">
                        </div>
                        <div class="col-12 col-md-6 col-lg-4 form-group mb-2">
                            <label for="siglas_autor_titulo" class="text-input" style="color:#25898D;">Siglas Autor:</label>
                            <input type="text" class="form-control form-control-sm" id="siglas_autor_titulo" name="siglas_autor_titulo">
                        </div>
                        <div class="col-12 form-group mb-2">
                            <label for="descripcion" class="text-input" style="color:#25898D;">Descripción:</label>
                            <textarea class="form-control form-control-sm" id="descripcion" name="descripcion" rows="3"></textarea>
                        </div>
                        <div class="col-12 col-md-6 form-group mb-2">
                            <label for="etiqueta_palabra_clave" class="text-input" style="color:#25898D;">Palabras Clave:</label>
                            <input type="text" class="form-control form-control-sm" id="etiqueta_palabra_clave" name="etiqueta_palabra_clave" placeholder="Separadas por comas">
                        </div>
                        <div class="col-12 col-md-6 col-lg-3 form-group mb-2">
                            <label for="sede" class="text-input" style="color:#25898D;">Sede:</label>
                            <select class="form-control form-control-sm" id="sede" name="sede" required>
                                <option value="">Seleccione una sede</option>
                                <option value="Abasto">Abasto</option>
                                <option value="La Plata">La Plata</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-6 col-lg-3 form-group mb-2">
                            <label for="disponibilidad" class="text-input" style="color:#25898D;">Disponibilidad:</label>
                            <select class="form-control form-control-sm" id="disponibilidad" name="disponibilidad" required>
                                <option value="">Seleccione disponibilidad</option>
                                <option value="Aula">Aula</option>
                                <option value="Domicilio">Domicilio</option>
                            </select>
                        </div>
                        <div class="col-12 form-group mb-2">
                            <label for="observaciones" class="text-input" style="color:#25898D;">Observaciones:</label>
                            <textarea class="form-control form-control-sm" id="observaciones" name="observaciones" rows="2"></textarea>
                        </div>
                    `;
                    break;
                    
                case 'mapa':
                    // Campos del MapaForm
                    html = `
                        <div class="col-12 col-md-6 form-group mb-2">
                            <label for="tipo" class="text-input" style="color:#25898D;">Tipo de Mapa: <span style="color:red;">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="tipo" name="tipo" required>
                        </div>
                        <div class="col-12 form-group mb-2">
                            <label for="descripcion" class="text-input" style="color:#25898D;">Descripción:</label>
                            <textarea class="form-control form-control-sm" id="descripcion" name="descripcion" rows="3"></textarea>
                        </div>
                        <div class="col-12 col-md-6 form-group mb-2">
                            <label for="num_ejemplar" class="text-input" style="color:#25898D;">Número de Ejemplar:</label>
                            <input type="number" class="form-control form-control-sm" id="num_ejemplar" name="num_ejemplar" value="1" min="1">
                        </div>
                    `;
                    break;
                    
                case 'multimedia':
                    // Campos del MultimediaForm
                    html = `
                        <div class="col-12 col-md-6 form-group mb-2">
                            <label for="materia" class="text-input" style="color:#25898D;">Materia: <span style="color:red;">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="materia" name="materia" required>
                        </div>
                        <div class="col-12 col-md-6 form-group mb-2">
                            <label for="contenido" class="text-input" style="color:#25898D;">Contenido: <span style="color:red;">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="contenido" name="contenido" required>
                        </div>
                        <div class="col-12 form-group mb-2">
                            <label for="descripcion" class="text-input" style="color:#25898D;">Descripción:</label>
                            <textarea class="form-control form-control-sm" id="descripcion" name="descripcion" rows="3"></textarea>
                        </div>
                        <div class="col-12 col-md-6 form-group mb-2">
                            <label for="num_ejemplar" class="text-input" style="color:#25898D;">Número de Ejemplar:</label>
                            <input type="number" class="form-control form-control-sm" id="num_ejemplar" name="num_ejemplar" value="1" min="1">
                        </div>
                    `;
                    break;
                    
                case 'notebook':
                    // Campos del NotebookForm
                    html = `
                        <div class="col-12 col-md-6 form-group mb-2">
                            <label for="marca_not" class="text-input" style="color:#25898D;">Marca: <span style="color:red;">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="marca_not" name="marca_not" required>
                        </div>
                        <div class="col-12 col-md-6 form-group mb-2">
                            <label for="modelo_not" class="text-input" style="color:#25898D;">Modelo: <span style="color:red;">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="modelo_not" name="modelo_not" required>
                        </div>
                        <div class="col-12 form-group mb-2">
                            <label for="descripcion" class="text-input" style="color:#25898D;">Descripción:</label>
                            <textarea class="form-control form-control-sm" id="descripcion" name="descripcion" rows="3"></textarea>
                        </div>
                        <div class="col-12 col-md-6 form-group mb-2">
                            <label for="num_ejemplar" class="text-input" style="color:#25898D;">Número de Ejemplar:</label>
                            <input type="number" class="form-control form-control-sm" id="num_ejemplar" name="num_ejemplar" value="1" min="1">
                        </div>
                    `;
                    break;
                    
                case 'proyector':
                    // Campos del ProyectorForm
                    html = `
                        <div class="col-12 col-md-6 form-group mb-2">
                            <label for="marca_pro" class="text-input" style="color:#25898D;">Marca: <span style="color:red;">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="marca_pro" name="marca_pro" required>
                        </div>
                        <div class="col-12 col-md-6 form-group mb-2">
                            <label for="modelo_pro" class="text-input" style="color:#25898D;">Modelo: <span style="color:red;">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="modelo_pro" name="modelo_pro" required>
                        </div>
                        <div class="col-12 form-group mb-2">
                            <label for="descripcion" class="text-input" style="color:#25898D;">Descripción:</label>
                            <textarea class="form-control form-control-sm" id="descripcion" name="descripcion" rows="3"></textarea>
                        </div>
                        <div class="col-12 col-md-6 form-group mb-2">
                            <label for="num_ejemplar" class="text-input" style="color:#25898D;">Número de Ejemplar:</label>
                            <input type="number" class="form-control form-control-sm" id="num_ejemplar" name="num_ejemplar" value="1" min="1">
                        </div>
                    `;
                    break;
                    
                case 'varios':
                    // Campos del VariosForm
                    html = `
                        <div class="col-12 col-md-6 form-group mb-2">
                            <label for="tipo" class="text-input" style="color:#25898D;">Tipo: <span style="color:red;">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="tipo" name="tipo" required>
                        </div>
                        <div class="col-12 form-group mb-2">
                            <label for="descripcion" class="text-input" style="color:#25898D;">Descripción:</label>
                            <textarea class="form-control form-control-sm" id="descripcion" name="descripcion" rows="3"></textarea>
                        </div>
                        <div class="col-12 col-md-6 form-group mb-2">
                            <label for="num_ejemplar" class="text-input" style="color:#25898D;">Número de Ejemplar:</label>
                            <input type="number" class="form-control form-control-sm" id="num_ejemplar" name="num_ejemplar" value="1" min="1">
                        </div>
                    `;
                    break;
                    
                case 'programa':
                    // Si tienes un form para programa, agrégalo aquí
                    html = `
                        <div class="col-12 col-md-6 form-group mb-2">
                            <label for="nombre_programa" class="text-input" style="color:#25898D;">Nombre del Programa: <span style="color:red;">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="nombre_programa" name="nombre_programa" required>
                        </div>
                        <div class="col-12 col-md-6 form-group mb-2">
                            <label for="version" class="text-input" style="color:#25898D;">Versión:</label>
                            <input type="text" class="form-control form-control-sm" id="version" name="version">
                        </div>
                        <div class="col-12 form-group mb-2">
                            <label for="descripcion" class="text-input" style="color:#25898D;">Descripción:</label>
                            <textarea class="form-control form-control-sm" id="descripcion" name="descripcion" rows="3"></textarea>
                        </div>
                    `;
                    break;
            }
            
            container.innerHTML = html;
        }
        
        // Manejar botón cancelar
        const btnCancelar = document.querySelector('.boton-cancelar');
        if (btnCancelar) {
            btnCancelar.addEventListener('click', function() {
                if (confirm('¿Está seguro que desea cancelar? Se perderán todos los datos ingresados.')) {
                    form.reset();
                    tipoMaterial.value = '';
                    tipoMaterial.dispatchEvent(new Event('change'));
                }
            });
        }
    });
    </script>
    <script src="{% static 'js/form_altas.js' %}" defer></script>
{% endblock %}