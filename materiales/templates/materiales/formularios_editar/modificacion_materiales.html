{% extends 'components/baseb.html' %}
{% load static %}

{% block title %}Modificaci√≥n de Materiales | Biblioteca Digital{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'css/modificacion_material.css' %}">
<link rel="stylesheet" href="{% static 'css/style_form.css' %}">
<link rel="stylesheet" href="{% static 'css/manual_modal.css' %}">
<link rel="stylesheet" href="{% static 'css/main.css' %}">
<link rel="stylesheet" href="{% static 'css/botones.css' %}">
<style>
    .page-header {
        background: linear-gradient(135deg, #4ECDC4, #44A08D);
        color: white;
        padding: 1.5rem 0;
        text-align: center;
        margin-bottom: 2rem;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 600;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .controls-row {
        background: white;
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }

    .buscar {
        position: relative;
        width: 100%;
    }

    .buscar input[type="text"] {
        width: 100%;
        padding: 8px 40px 8px 12px;
        border: 1px solid #ddd;
        border-radius: 20px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.3s ease;
    }

    .buscar input[type="text"]:focus {
        border-color: #4ECDC4;
        box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.2);
    }

    .buscar button {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 15px;
        transition: background-color 0.3s ease;
    }

    .buscar button:hover {
        background-color: #f0f0f0;
    }

    .icono-buscar {
        font-size: 16px;
    }

    .mostrar-no-disponibles {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #555;
    }

    .mostrar-no-disponibles input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: #4ECDC4;
    }

    .manual-button {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 20px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
    }

    .manual-button:hover {
        background: linear-gradient(135deg, #764ba2, #667eea);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .tipo-material-container label {
        font-weight: 600;
        margin-bottom: 5px;
        display: block;
        color: #25898D;
    }

    .tipo-material-container select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        background: white;
    }

    /* Tabla de materiales */
    .tabla-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .libros-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    .libros-table thead {
        background: linear-gradient(135deg, #4ECDC4, #44A08D);
        color: white;
    }

    .libros-table th {
        padding: 15px 10px;
        text-align: left;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .libros-table th.text-center {
        text-align: center;
    }

    .libros-table tbody tr {
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.2s ease;
    }

    .libros-table tbody tr:nth-child(odd) {
        background-color: #f8f9fa;
    }

    .libros-table tbody tr:nth-child(even) {
        background-color: white;
    }

    .libros-table tbody tr:hover {
        background-color: #e8f8f5;
        transform: scale(1.002);
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .libros-table td {
        padding: 12px 10px;
        vertical-align: middle;
        font-size: 13px;
    }

    .titulo-cell {
        font-weight: 600;
        color: #2c3e50;
        max-width: 200px;
        word-wrap: break-word;
    }

    .disponibilidad-cell {
        text-align: center;
    }

    .disponible {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        color: white;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 11px;
        font-weight: 600;
        display: inline-block;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .no-disponible {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 11px;
        font-weight: 600;
        display: inline-block;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .reservado {
        background: linear-gradient(135deg, #f39c12, #e67e22);
        color: white;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 11px;
        font-weight: 600;
        display: inline-block;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .imagen-cell {
        text-align: center;
        padding: 8px;
    }

    .libro-thumbnail {
        width: 50px;
        height: 70px;
        object-fit: cover;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        transition: transform 0.2s ease;
    }

    .libro-thumbnail:hover {
        transform: scale(1.1);
    }

    .acciones-cell {
        text-align: center;
        padding: 8px;
    }

    .btn-icon {
        background: none;
        border: none;
        padding: 8px;
        margin: 0 2px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }

    .btn-icon:hover {
        transform: translateY(-2px);
    }

    .btn-detalle:hover {
        background-color: #3498db;
        color: white;
    }

    .btn-editar {
        text-decoration: none;
        color: inherit;
    }

    .btn-editar:hover {
        background-color: #f39c12;
        color: white;
        text-decoration: none;
    }

    .btn-imprimir:hover {
        background-color: #9b59b6;
        color: white;
    }

    .btn-eliminar:hover {
        background-color: #e74c3c;
        color: white;
    }

    .no-results {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
        font-style: italic;
        font-size: 16px;
    }

    .ordenar-por {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #555;
    }

    .ordenar-por select {
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 13px;
        background: white;
    }

    /* Responsive Design */
    @media screen and (max-width: 1024px) {
        .libros-table {
            font-size: 12px;
        }
        
        .libros-table th, .libros-table td {
            padding: 8px 6px;
        }
        
        .libro-thumbnail {
            width: 40px;
            height: 56px;
        }
    }

    @media screen and (max-width: 768px) {
        .tabla-container {
            overflow-x: auto;
        }
        
        .libros-table {
            min-width: 800px;
        }

        .controls-row .row > div {
            margin-bottom: 1rem;
        }
    }

    @media screen and (max-width: 480px) {
        .page-title {
            font-size: 1.5rem;
        }
        
        .controls-row {
            padding: 0.8rem;
        }
    }
</style>
{% endblock %}

{% block content %}


<div class="container-fluid">
    <!-- Controles principales -->
    <div class="controls-row">
        <div class="row align-items-center">
            <!-- Buscador -->
            <div class="col-12 col-md-3 col-lg-2">
                <form method="get" class="buscar">
                    <input type="text" name="q" placeholder="Buscar por..." value="{{ request.GET.q }}" id="searchInput">
                    <button type="submit" title="Buscar">
                        <span class="icono-buscar">üîç</span>
                    </button>
                </form>
            </div>

            <!-- Espacio en blanco -->
            <div class="col-md-3 col-lg-4 d-none d-md-block"></div>

            <!-- Mostrar no disponibles -->
            <div class="col-12 col-md-3 col-lg-2">
                <div class="mostrar-no-disponibles">
                    <input type="checkbox" id="mostrar_no_disponibles" name="mostrar_no_disponibles">
                    <label for="mostrar_no_disponibles">Mostrar no disponibles</label>
                </div>
            </div>

            <!-- Ordenar por -->
            <div class="col-12 col-md-2 col-lg-2">
                <div class="ordenar-por">
                    <label for="ordenar_por">Ordenar por:</label>
                    <select id="ordenar_por" name="ordenar_por">
                        <option value="titulo">T√≠tulo</option>
                        <option value="autor">Autor</option>
                        <option value="fecha">Fecha</option>
                    </select>
                </div>
            </div>

            <!-- Bot√≥n Manual -->
            <div class="col-12 col-md-1 col-lg-2">
                <button type="button" class="manual-button w-100" onclick="document.getElementById('manualModal').style.display='flex'">
                    MANUAL
                </button>
            </div>
        </div>

        <!-- Segunda fila: Tipo de material -->
        <div class="row mt-3">
            <div class="col-12 col-md-3 col-lg-2">
                <div class="tipo-material-container">
                    <label for="tipo_material">Tipo de Material:</label>
                    <select class="form-control form-control-sm" id="tipo_material" name="tipo_material">
                        <option value="">Selecciona un tipo de material</option>
                        <option value="libro" selected>LIBRO</option>
                        <option value="mapa">MAPA</option>
                        <option value="multimedia">MULTIMEDIA</option>
                        <option value="notebook">NOTEBOOK</option>
                        <option value="programa">PROGRAMA</option>
                        <option value="proyector">PROYECTOR</option>
                        <option value="varios">VARIOS</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de materiales -->
    <div class="tabla-container">
        <table class="libros-table">
            <thead>
                <tr>
                    <th class="text-center">N¬∞ Inv.</th>
                    <th>T√≠tulo</th>
                    <th>Autor</th>
                    <th>Editorial</th>
                    <th class="text-center">CDU</th>
                    <th class="text-center">Siglas</th>
                    <th class="text-center">Sede</th>
                    <th class="text-center">Disponibilidad</th>
                    <th class="text-center">Imagen</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody id="libros-table">
                {% if libros %}
                    {% for libro in libros %}
                    <tr class="libro-row" 
                        data-estado="{{ libro.estado|lower }}"
                        data-titulo="{{ libro.titulo|lower }}"
                        data-autor="{{ libro.autor|lower }}"
                        data-editorial="{{ libro.editorial|lower }}">
                        <td class="text-center">{{ libro.num_inventario|default:'' }}</td>
                        <td class="titulo-cell">{{ libro.titulo }}</td>
                        <td>{{ libro.autor }}</td>
                        <td>{{ libro.editorial }}</td>
                        <td class="text-center">{{ libro.clasificacion_cdu|default:'' }}</td>
                        <td class="text-center">{{ libro.siglas_autor_titulo }}</td>
                        <td class="text-center">{{ libro.sede|default:'LA PLATA' }}</td>
                        <td class="disponibilidad-cell">
                            {% if libro.estado == 'Disponible' %}
                                <span class="disponible">Disponible para pr√©stamo</span>
                            {% elif libro.estado == 'Reservado' %}
                                <span class="reservado">{{ libro.estado }}</span>
                            {% else %}
                                <span class="no-disponible">{{ libro.estado }}</span>
                            {% endif %}
                        </td>
                        <td class="imagen-cell">
                            {% if libro.img %}
                                <img src="{{ libro.img }}" alt="{{ libro.titulo }}" class="libro-thumbnail">
                            {% else %}
                                <img src="https://via.placeholder.com/50x70/95a5a6/ffffff?text=Sin+Imagen" alt="{{ libro.titulo }}" class="libro-thumbnail">
                            {% endif %}
                        </td>
                        <td class="acciones-cell">
                            <button class="btn-icon btn-detalle" title="Ver detalles" onclick="verDetalles({{ libro.id_libro }})">
                                üìã
                            </button>
                            <a href="{% url 'editar_libro' libro.id_libro %}" class="btn-icon btn-editar" title="Editar">
                                ‚úèÔ∏è
                            </a>
                            <button class="btn-icon btn-imprimir" title="Imprimir" onclick="imprimirLibro({{ libro.id_libro }})">
                                üñ®Ô∏è
                            </button>
                            {% if libro.estado == 'Disponible' %}
                                <button class="btn-icon btn-eliminar" title="Dar de baja" 
                                        onclick="darDeBaja({{ libro.id_libro }}, '{{ libro.titulo|escapejs }}')">
                                    üóëÔ∏è
                                </button>
                            {% elif libro.estado == 'No disponible' %}
                                <button class="btn-icon btn-reactivar" title="Reactivar" 
                                        onclick="reactivarLibro({{ libro.id_libro }}, '{{ libro.titulo|escapejs }}')">
                                    ‚Ü©Ô∏è
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="10" class="no-results">No se encontraron libros disponibles.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal para dar de baja -->

<!-- Modal para dar de baja - REEMPLAZAR el modal existente -->
<div class="modal fade" id="bajaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="border: none; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <!-- Header del modal -->
            <div class="modal-header" style="background: linear-gradient(135deg, #4ECDC4, #44A08D); color: white; padding: 1.5rem; border: none;">
                <h5 class="modal-title" style="font-weight: 700; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; margin: 0;">
                    DAR DE BAJA AL MATERIAL SELECCIONADO:
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" 
                        style="filter: brightness(0) invert(1); opacity: 0.8; font-size: 1.2rem;"></button>
            </div>

            <form method="POST" action="{% url 'baja_libro' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body" style="padding: 0; background: #f8f9fa;">
                    <input type="hidden" id="libro_id" name="libro_id">
                    
                    <!-- Informaci√≥n del libro -->
                    <div style="background: linear-gradient(135deg, #e8f4f8, #f0f8ff); padding: 1.5rem; border-bottom: 2px solid #4ECDC4;">
                        <div class="row align-items-center">
                            <div class="col-2 text-center">
                                <div style="width: 80px; height: 100px; background: #ddd; border-radius: 8px; margin: 0 auto; position: relative; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                                    <img id="libro_imagen_modal" src="" alt="Libro" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                    <div id="libro_placeholder" style="width: 100%; height: 100%; background: #bdc3c7; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; text-align: center;">
                                        Sin<br>Imagen
                                    </div>
                                </div>
                            </div>
                            <div class="col-10">
                                <table style="width: 100%; font-size: 14px; color: #2c3e50;">
                                    <tr style="border-bottom: 1px solid #ddd;">
                                        <td style="padding: 8px 12px; font-weight: 600; background: #ecf0f1; width: 15%; text-align: center;">N¬∞ Inv.</td>
                                        <td style="padding: 8px 12px; font-weight: 600; background: #ecf0f1; width: 25%;">T√≠tulo</td>
                                        <td style="padding: 8px 12px; font-weight: 600; background: #ecf0f1; width: 20%;">Autor</td>
                                        <td style="padding: 8px 12px; font-weight: 600; background: #ecf0f1; width: 15%;">Editorial</td>
                                        <td style="padding: 8px 12px; font-weight: 600; background: #ecf0f1; width: 10%; text-align: center;">CDU</td>
                                        <td style="padding: 8px 12px; font-weight: 600; background: #ecf0f1; width: 10%; text-align: center;">Siglas</td>
                                        <td style="padding: 8px 12px; font-weight: 600; background: #ecf0f1; width: 15%; text-align: center;">Sede</td>
                                    </tr>
                                    <tr style="background: rgba(78, 205, 196, 0.1);">
                                        <td style="padding: 12px 12px; text-align: center; font-weight: 600;" id="modal_num_inventario">1</td>
                                        <td style="padding: 12px 12px; font-weight: 600; color: #2c3e50;" id="modal_titulo">T√≠tulo del libro</td>
                                        <td style="padding: 12px 12px;" id="modal_autor">Autor</td>
                                        <td style="padding: 12px 12px;" id="modal_editorial">Editorial</td>
                                        <td style="padding: 12px 12px; text-align: center;" id="modal_cdu">CDU</td>
                                        <td style="padding: 12px 12px; text-align: center; font-weight: 600;" id="modal_siglas">ABC</td>
                                        <td style="padding: 12px 12px; text-align: center;" id="modal_sede">LA PLATA</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n de formulario -->
                    <div style="padding: 1.5rem;">
                        <div class="row">
                            <!-- Motivo de baja -->
                            <div class="col-md-6">
                                <div style="background: white; padding: 1.5rem; border-radius: 10px; border: 2px solid #4ECDC4; height: 100%;">
                                    <h6 style="color: #4ECDC4; font-weight: 700; text-transform: uppercase; margin-bottom: 1rem; font-size: 14px; letter-spacing: 0.5px;">
                                        Motivo de baja*
                                    </h6>
                                    <textarea class="form-control" id="motivo_baja" name="motivo_baja" 
                                              rows="6" required placeholder="Describe el motivo de la baja del material..."
                                              style="border: 1px solid #ddd; border-radius: 8px; font-size: 14px; resize: none; padding: 12px;"></textarea>
                                </div>
                            </div>

                            <!-- Cargar imagen -->
                            <div class="col-md-6">
                                <div style="background: white; padding: 1.5rem; border-radius: 10px; border: 2px solid #f39c12; height: 100%;">
                                    <h6 style="color: #f39c12; font-weight: 700; text-transform: uppercase; margin-bottom: 1rem; font-size: 14px; letter-spacing: 0.5px;">
                                        Cargar imagen de baja
                                    </h6>
                                    
                                    <div style="text-align: center; margin-bottom: 1rem;">
                                        <div style="width: 120px; height: 80px; border: 2px dashed #f39c12; border-radius: 8px; margin: 0 auto; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; background: #fef9e7;" onclick="document.getElementById('imagen_rota').click()">
                                            <div style="text-align: center; color: #f39c12;">
                                                <div style="font-size: 24px; margin-bottom: 4px;">üìÅ</div>
                                                <div style="font-size: 11px; font-weight: 600;">SUBIR ARCHIVO</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <input type="file" class="form-control" id="imagen_rota" name="imagen_rota" 
                                           accept="image/*" style="display: none;">
                                    
                                    <div style="margin-top: 1rem;">
                                        <label style="color: #7B68EE; font-weight: 600; font-size: 12px; text-transform: uppercase; margin-bottom: 0.5rem; display: block;">
                                            Localizaci√≥n
                                        </label>
                                        <input type="text" class="form-control" placeholder="Guardar en..."
                                               style="border: 1px solid #ddd; border-radius: 5px; font-size: 13px; padding: 8px;" readonly value="Galer√≠a de bajas">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer del modal -->
                <div class="modal-footer" style="background: #f8f9fa; padding: 1rem 1.5rem; border: none; justify-content: center; gap: 1rem;">
                    <button type="button" class="btn" data-bs-dismiss="modal" 
                            style="background: #4285F4; color: white; border: none; padding: 10px 30px; border-radius: 25px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 13px; min-width: 120px; transition: all 0.3s ease;">
                        CANCELAR
                    </button>
                    <button type="submit" class="btn"
                            style="background: #ff6b35; color: white; border: none; padding: 10px 30px; border-radius: 25px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 13px; min-width: 120px; transition: all 0.3s ease;">
                        CONFIRMAR
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Estilos adicionales para el modal */
.modal-backdrop {
    background-color: rgba(0, 0, 0, 0.6);
}

#bajaModal .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

#bajaModal .form-control:focus {
    border-color: #4ECDC4;
    box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.2);
}

/* Animaci√≥n de hover para la zona de subida */
#bajaModal .upload-zone:hover {
    background: #fef2e7 !important;
    border-color: #e67e22 !important;
    transform: scale(1.02);
}

/* Responsive */
@media (max-width: 768px) {
    #bajaModal .modal-dialog {
        margin: 1rem;
        max-width: none;
    }
    
    #bajaModal .modal-body .row {
        flex-direction: column;
    }
    
    #bajaModal .modal-body .col-md-6 {
        margin-bottom: 1rem;
    }
}
</style>

{% endblock %}

{% block modals %}
  {% include 'modals/detalles_material.html' %}
  {% include 'modals/manual_modal.html' %}
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Funcionalidad de b√∫squeda en tiempo real
    const searchInput = document.getElementById('searchInput');
    const mostrarNoDisponibles = document.getElementById('mostrar_no_disponibles');
    const ordenarPor = document.getElementById('ordenar_por');
    const rows = document.querySelectorAll('.libro-row');

    function filtrarLibros() {
        const searchTerm = searchInput.value.toLowerCase();
        const showUnavailable = mostrarNoDisponibles.checked;
        let visibleCount = 0;

        rows.forEach(row => {
            const titulo = row.dataset.titulo;
            const autor = row.dataset.autor;
            const editorial = row.dataset.editorial;
            const estado = row.dataset.estado;
            
            const matchesSearch = titulo.includes(searchTerm) || 
                                 autor.includes(searchTerm) || 
                                 editorial.includes(searchTerm);
            
            const isAvailable = estado === 'disponible' || estado === 'reservado';
            const showRow = matchesSearch && (showUnavailable || isAvailable);
            
            row.style.display = showRow ? '' : 'none';
            if (showRow) visibleCount++;
        });

        // Mostrar mensaje si no hay resultados
        updateNoResultsMessage(visibleCount);
    }

    function updateNoResultsMessage(count) {
        const tbody = document.getElementById('libros-table');
        let noResultsRow = document.getElementById('no-results-row');
        
        if (count === 0) {
            if (!noResultsRow) {
                noResultsRow = document.createElement('tr');
                noResultsRow.id = 'no-results-row';
                noResultsRow.innerHTML = '<td colspan="10" class="no-results">No se encontraron resultados con los filtros aplicados.</td>';
                tbody.appendChild(noResultsRow);
            }
        } else {
            if (noResultsRow) {
                noResultsRow.remove();
            }
        }
    }

    // Event listeners
    searchInput.addEventListener('input', filtrarLibros);
    mostrarNoDisponibles.addEventListener('change', filtrarLibros);

    // Funcionalidad de ordenamiento
    ordenarPor.addEventListener('change', function() {
        const tbody = document.getElementById('libros-table');
        const rowsArray = Array.from(rows);
        
        rowsArray.sort((a, b) => {
            let aValue, bValue;
            
            switch (this.value) {
                case 'autor':
                    aValue = a.dataset.autor;
                    bValue = b.dataset.autor;
                    break;
                case 'fecha':
                    // Ordenar por n√∫mero de inventario como proxy de fecha
                    aValue = parseInt(a.querySelector('td:first-child').textContent) || 0;
                    bValue = parseInt(b.querySelector('td:first-child').textContent) || 0;
                    return bValue - aValue; // Descendente para fechas
                default: // titulo
                    aValue = a.dataset.titulo;
                    bValue = b.dataset.titulo;
            }
            
            return aValue.localeCompare(bValue);
        });
        
        // Reordenar en el DOM
        rowsArray.forEach(row => tbody.appendChild(row));
    });
});

// Funciones para los botones de acci√≥n
function darDeBaja(libroId, titulo) {
    // Obtener la fila del libro para extraer todos los datos
    const filaLibro = document.querySelector(`tr[data-titulo*="${titulo.toLowerCase()}"]`);
    
    if (!filaLibro) {
        console.error('No se pudo encontrar la fila del libro');
        return;
    }
    
    // Extraer datos de la fila
    const celdas = filaLibro.querySelectorAll('td');
    const numInventario = celdas[0].textContent.trim();
    const tituloLibro = celdas[1].textContent.trim();
    const autor = celdas[2].textContent.trim();
    const editorial = celdas[3].textContent.trim();
    const cdu = celdas[4].textContent.trim();
    const siglas = celdas[5].textContent.trim();
    const sede = celdas[6].textContent.trim();
    
    // Obtener imagen del libro
    const imagenElement = filaLibro.querySelector('.libro-thumbnail');
    const imagenSrc = imagenElement ? imagenElement.src : '';
    
    // Llenar el formulario oculto
    document.getElementById('libro_id').value = libroId;
    
    // Llenar los datos en el modal
    document.getElementById('modal_num_inventario').textContent = numInventario || '1';
    document.getElementById('modal_titulo').textContent = tituloLibro;
    document.getElementById('modal_autor').textContent = autor || 'Sin autor';
    document.getElementById('modal_editorial').textContent = editorial || 'Sin editorial';
    document.getElementById('modal_cdu').textContent = cdu || 'Sin CDU';
    document.getElementById('modal_siglas').textContent = siglas || 'ABC';
    document.getElementById('modal_sede').textContent = sede || 'LA PLATA';
    
    // Manejar la imagen
    const imagenModal = document.getElementById('libro_imagen_modal');
    const placeholderModal = document.getElementById('libro_placeholder');
    
    if (imagenSrc && !imagenSrc.includes('placeholder')) {
        imagenModal.src = imagenSrc;
        imagenModal.style.display = 'block';
        placeholderModal.style.display = 'none';
    } else {
        imagenModal.style.display = 'none';
        placeholderModal.style.display = 'flex';
    }
    
    // Limpiar el formulario
    document.getElementById('motivo_baja').value = '';
    document.getElementById('imagen_rota').value = '';
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('bajaModal'));
    modal.show();
}

// AGREGAR este event listener para manejar la subida de archivos:
document.addEventListener('DOMContentLoaded', function() {
    // Manejar preview de imagen subida
    const inputImagen = document.getElementById('imagen_rota');
    
    if (inputImagen) {
        inputImagen.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const uploadZone = document.querySelector('[onclick="document.getElementById(\'imagen_rota\').click()"]');
            
            if (file) {
                // Mostrar nombre del archivo
                uploadZone.innerHTML = `
                    <div style="text-align: center; color: #27ae60;">
                        <div style="font-size: 20px; margin-bottom: 4px;">‚úÖ</div>
                        <div style="font-size: 10px; font-weight: 600;">${file.name}</div>
                    </div>
                `;
                uploadZone.style.background = '#d5f4e6';
                uploadZone.style.borderColor = '#27ae60';
            } else {
                // Restaurar estado original
                uploadZone.innerHTML = `
                    <div style="text-align: center; color: #f39c12;">
                        <div style="font-size: 24px; margin-bottom: 4px;">üìÅ</div>
                        <div style="font-size: 11px; font-weight: 600;">SUBIR ARCHIVO</div>
                    </div>
                `;
                uploadZone.style.background = '#fef9e7';
                uploadZone.style.borderColor = '#f39c12';
            }
        });
    }
    
    // Efectos hover para botones
    document.addEventListener('mouseover', function(e) {
        if (e.target.style.background === 'rgb(66, 133, 244)') { // Bot√≥n cancelar
            e.target.style.background = '#3367D6';
        } else if (e.target.style.background === 'rgb(255, 107, 53)') { // Bot√≥n confirmar
            e.target.style.background = '#e55a2b';
        }
    });
    
    document.addEventListener('mouseout', function(e) {
        if (e.target.style.background === 'rgb(51, 103, 214)') { // Bot√≥n cancelar hover
            e.target.style.background = '#4285F4';
        } else if (e.target.style.background === 'rgb(229, 90, 43)') { // Bot√≥n confirmar hover
            e.target.style.background = '#ff6b35';
        }
    });
});

function reactivarLibro(libroId, titulo) {
    if (confirm(`¬øEst√° seguro de reactivar el libro "${titulo}"?`)) {
        window.location.href = `/reactivar-libro/${libroId}/`;
    }
}

function verDetalles(libroId) {
    // Implementar vista de detalles
    console.log('Ver detalles del libro:', libroId);
}

function imprimirLibro(libroId) {
    // Implementar funcionalidad de impresi√≥n
    console.log('Imprimir libro:', libroId);
}
</script>
{% endblock %}