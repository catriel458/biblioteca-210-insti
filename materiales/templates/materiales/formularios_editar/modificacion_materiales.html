{% extends 'components/baseb.html' %}
{% load static %}
{% csrf_token %}

<!-- Agregar esto justo despu√©s de {% load static %} en tu template -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
{% block title %}Modificaci√≥n de Materiales | Biblioteca Digital{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'css/modificacion_material.css' %}">
<link rel="stylesheet" href="{% static 'css/style_form.css' %}">
<link rel="stylesheet" href="{% static 'css/manual_modal.css' %}">
<link rel="stylesheet" href="{% static 'css/main.css' %}">
<link rel="stylesheet" href="{% static 'css/botones.css' %}">

<style>
    .page-header {
        background: linear-gradient(135deg, #4ECDC4, #44A08D);
        color: white;
        padding: 1.5rem 0;
        text-align: center;
        margin-bottom: 2rem;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 600;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .controls-row {
        background: white;
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }

    .buscar {
        position: relative;
        width: 100%;
    }

    .buscar input[type="text"] {
        width: 100%;
    /* Layout general - Alineaci√≥n exacta como en la imagen */
    .container-fluid {
        /* Layout principal */
        .container-fluid {
            padding: 15px 20px;
        }

        /* Primera fila - Distribuci√≥n horizontal */
        .primera-fila {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            width: 100%;
        }

        .buscar-container {
            flex-shrink: 0;
        }

        .controles-derecha {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-shrink: 0;
        }

        /* Segunda fila - Distribuci√≥n horizontal */
        .segunda-fila {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 20px;
            width: 100%;
        }

        /* Estilos del buscador */
        .buscar {
            display: flex;
            align-items: center;
            width: 240px;
        }

        .buscar input {
            width: 200px;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 20px 0 0 20px;
            font-size: 13px;
            outline: none;
            font-family: Arial, sans-serif;
        }

        .buscar button {
            background: #f8f9fa;
            border: 1px solid #ccc;
            border-left: none;
            border-radius: 0 20px 20px 0;
            padding: 8px 12px;
            cursor: pointer;
            width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Checkbox "Mostrar no disponibles" */
        .mostrar-no-disponibles {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: Arial, sans-serif;
            font-size: 13px;
            color: #333;
            white-space: nowrap;
        }

        .mostrar-no-disponibles input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        .mostrar-no-disponibles label {
            margin: 0;
            cursor: pointer;
        }

        /* Bot√≥n MANUAL */
        .manual-button {
            background-color: #8B4B9C !important;
            color: white !important;
            border: none !important;
            border-radius: 0px !important;
            padding: 10px 20px !important;
            font-family: Arial, sans-serif !important;
            font-size: 14px !important;
            font-weight: bold !important;
            cursor: pointer !important;
            text-transform: uppercase !important;
            height: 35px !important;
            min-width: 100px !important;
        }

        .manual-button:hover {
            background-color: #7A3F8A !important;
        }

        /* Contenedores de selectores */
        .tipo-material-container,
        .ordenar-por {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        /* Labels de los selectores */
        .tipo-material-container label,
        .ordenar-por label {
            font-family: Arial, sans-serif !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            color: #5cb3a3 !important;
            margin: 0;
        }

        /* Estilos base para ambos selectores */
        .tipo-material-container select,
        .ordenar-por select {
            width: 200px !important;
            height: 32px !important;
            font-family: Arial, sans-serif !important;
            font-size: 13px !important;
            font-weight: normal !important;
            color: #333 !important;
            border: 1px solid #5cb3a3 !important;
            border-radius: 0px !important;
            padding: 6px 25px 6px 8px !important;
    
            /* Eliminar estilos nativos */
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
    
            /* Flecha personalizada */
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e") !important;
            background-repeat: no-repeat !important;
            background-position: right 8px center !important;
            background-size: 12px !important;
        }

        /* Selector de tipo de material - Color turquesa */
        #tipo_material {
            background-color: #7dd3c0 !important;
        }

        #tipo_material option {
            background-color: #7dd3c0 !important;
            color: #333 !important;
        }

        /* Selector de ordenar por - Color gris */
        #ordenar_por {
            background-color: #e9ecef !important;
        }

        #ordenar_por option {
            background-color: #e9ecef !important;
            color: #333 !important;
        }

        /* Estados hover y focus */
        #tipo_material:hover,
        #tipo_material:focus {
            background-color: #6bc7b3 !important;
            outline: none !important;
        }

        #ordenar_por:hover,
        #ordenar_por:focus {
            background-color: #dee2e6 !important;
            outline: none !important;
        }

        /* Responsividad */
        @media (max-width: 768px) {
            .primera-fila,
            .segunda-fila {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
    
            .controles-derecha {
                justify-content: space-between;
                width: 100%;
            }
    
            .buscar {
                width: 100%;
            }
    
            .buscar input {
                flex: 1;
            }
    
            .tipo-material-container select,
            .ordenar-por select {
                width: 100% !important;
            }
    
            .manual-button {
                min-width: 120px !important;
            }
        }
    width: 200px !important;
}

/* Estilo espec√≠fico para el selector de ordenar por */
#ordenar_por {
    background: #e9ecef !important;
    background-color: #e9ecef !important;
    min-width: 200px !important;
    width: 200px !important;
}

/* Opciones del dropdown - tambi√©n con color turquesa */
#tipo_material option {
    background-color: #7dd3c0 !important;
    color: #333 !important;
    padding: 8px !important;
    font-size: 13px !important;
    font-family: Arial, sans-serif !important;
}

#ordenar_por option {
    background-color: #e9ecef !important;
    color: #333 !important;
    padding: 8px !important;
    font-size: 13px !important;
    font-family: Arial, sans-serif !important;
}

/* Labels */
.tipo-material-container label,
.ordenar-por label {
    display: block;
    font-family: Arial, sans-serif !important;
    font-size: 14px !important;
    font-weight: 500 !important;
    color: #5cb3a3 !important;
    margin-bottom: 8px !important;
}

/* Contenedores */
.tipo-material-container,
.ordenar-por {
    display: block;
    margin-bottom: 15px;
}

/* Estados hover y focus */
.tipo-material-container select:hover,
.tipo-material-container select:focus {
    background: #6bc7b3 !important;
    background-color: #6bc7b3 !important;
    border-color: #5cb3a3 !important;
    outline: none !important;
}

.ordenar-por select:hover,
.ordenar-por select:focus {
    background: #dee2e6 !important;
    background-color: #dee2e6 !important;
    border-color: #adb5bd !important;
    outline: none !important;
}

/* Forzar el estilo en todos los navegadores */
select {
    background: #7dd3c0 !important;
}

select#tipo_material {
    background: #7dd3c0 !important;
}

select#ordenar_por {
    background: #e9ecef !important;
}

/* Responsividad */
@media (max-width: 768px) {
    .tipo-material-container select,
    .ordenar-por select {
        width: 100% !important;
        min-width: 100% !important;
    }
}
    }

    /* Tabla de materiales */
    .tabla-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .libros-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    .libros-table thead {
        background: linear-gradient(135deg, #4ECDC4, #44A08D);
        color: white;
    }

    .libros-table th {
        padding: 15px 10px;
        text-align: left;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .libros-table th.text-center {
        text-align: center;
    }

    .libros-table tbody tr {
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.2s ease;
    }

    .libros-table tbody tr:nth-child(odd) {
        background-color: #f8f9fa;
    }

    .libros-table tbody tr:nth-child(even) {
        background-color: white;
    }

    .libros-table tbody tr:hover {
        background-color: #e8f8f5;
        transform: scale(1.002);
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .libros-table td {
        padding: 12px 10px;
        vertical-align: middle;
        font-size: 13px;
    }

    .titulo-cell {
        font-weight: 600;
        color: #2c3e50;
        max-width: 200px;
        word-wrap: break-word;
    }

    .disponibilidad-cell {
        text-align: center;
    }

    .disponible {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        color: white;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 11px;
        font-weight: 600;
        display: inline-block;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .no-disponible {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 11px;
        font-weight: 600;
        display: inline-block;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .reservado {
        background: linear-gradient(135deg, #f39c12, #e67e22);
        color: white;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 11px;
        font-weight: 600;
        display: inline-block;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .imagen-cell {
        text-align: center;
        padding: 8px;
    }

    .libro-thumbnail {
        width: 50px;
        height: 70px;
        object-fit: cover;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        transition: transform 0.2s ease;
    }

    .libro-thumbnail:hover {
        transform: scale(1.1);
    }

    .acciones-cell {
        text-align: center;
        padding: 8px;
    }

    .btn-icon {
        background: none;
        border: none;
        padding: 8px;
        margin: 0 2px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }

    .btn-icon:hover {
        transform: translateY(-2px);
    }

    .btn-detalle:hover {
        background-color: #3498db;
        color: white;
    }

    .btn-editar {
        text-decoration: none;
        color: inherit;
    }

    .btn-editar:hover {
        background-color: #f39c12;
        color: white;
        text-decoration: none;
    }

    .btn-imprimir:hover {
        background-color: #9b59b6;
        color: white;
    }

    .btn-eliminar:hover {
        background-color: #e74c3c;
        color: white;
    }

    .no-results {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
        font-style: italic;
        font-size: 16px;
    }

    .ordenar-por {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #555;
    }

    .ordenar-por select {
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 13px;
        background: white;
    }

    /* Estilos para libros no disponibles */
.libro-no-disponible {
    background-color: #f8d7da !important; /* Rosa claro para libros no disponibles */
}

.libro-no-disponible:hover {
    background-color: #f5c6cb !important;
}

.libro-no-disponible:nth-child(even) {
    background-color: #f8d7da !important;
}

.libro-no-disponible:nth-child(odd) {
    background-color: #f8d7da !important;
}

/* Bot√≥n de ver informe */
.btn-ver-informe:hover {
    background-color: #17a2b8;
    color: white;
}

/* Estilos para modales de dar de alta */
.modal-dar-alta .modal-content {
    border: none;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.modal-dar-alta .modal-header {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    padding: 1.5rem;
    border: none;
}

.modal-dar-alta .modal-title {
    font-weight: 700;
    font-size: 1.2rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin: 0;
}

.form-group-custom {
    margin-bottom: 1rem;
}

.form-group-custom label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
    display: block;
}

.form-control-custom {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.form-control-custom:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
    outline: none;
}

.select-custom {
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
}

    /* Responsive Design */
    @media screen and (max-width: 1024px) {
        .libros-table {
            font-size: 12px;
        }
        
        .libros-table th, .libros-table td {
            padding: 8px 6px;
        }
        
        .libro-thumbnail {
            width: 40px;
            height: 56px;
        }
    }

    @media screen and (max-width: 768px) {
        .tabla-container {
            overflow-x: auto;
        }
        
        .libros-table {
            min-width: 800px;
        }

        .controls-row .row > div {
            margin-bottom: 1rem;
        }
    }

    @media screen and (max-width: 480px) {
        .page-title {
            font-size: 1.5rem;
        }
        
        .controls-row {
            padding: 0.8rem;
        }
    }
</style>
{% endblock %}

{% block content %}

<div class="container-fluid">
    <!-- Controles principales -->
    <div class="controls-row">
        <div class="row align-items-center">
            <!-- Buscador -->
            <div class="col-12 col-md-3 col-lg-2">
                <form method="get" class="buscar">
                    <input type="text" name="q" placeholder="Buscar por..." value="{{ request.GET.q }}" id="searchInput">
                    <button type="submit" title="Buscar">
                        <span class="icono-buscar">üîç</span>
                    </button>
                </form>
            </div>

            <!-- Espacio en blanco -->
            <div class="col-md-3 col-lg-4 d-none d-md-block"></div>

            <!-- Mostrar no disponibles -->
            <div class="col-12 col-md-3 col-lg-2">
                <div class="mostrar-no-disponibles">
                    <input type="checkbox" id="mostrar_no_disponibles" name="mostrar_no_disponibles">
                    <label for="mostrar_no_disponibles">Mostrar no disponibles</label>
                </div>
            </div>

            <!-- Ordenar por -->
            <div class="col-12 col-md-2 col-lg-2">
                <div class="ordenar-por">
                    <label for="ordenar_por">Ordenar por:</label>
                    <select id="ordenar_por" name="ordenar_por">
                        <option value="titulo">T√≠tulo</option>
                        <option value="autor">Autor</option>
                        <option value="fecha">Fecha</option>
                    </select>
                </div>
            </div>

            <!-- Bot√≥n Manual -->
            <div class="col-12 col-md-1 col-lg-2">
                <button type="button" class="manual-button w-100" onclick="document.getElementById('manualModal').style.display='flex'">
                    MANUAL
                </button>
            </div>
        </div>

        <!-- Segunda fila: Tipo de material -->
        <div class="row mt-3">
            <div class="col-12 col-md-3 col-lg-2">
                <div class="tipo-material-container">
                    <label for="tipo_material">Tipo de Material:</label>
                    <select class="form-control form-control-sm" id="tipo_material" name="tipo_material">
                        <option value="">Selecciona un tipo de material</option>
                        <option value="libro" selected>LIBRO</option>
                        <option value="mapa">MAPA</option>
                        <option value="multimedia">MULTIMEDIA</option>
                        <option value="notebook">NOTEBOOK</option>
                        <option value="programa">PROGRAMA</option>
                        <option value="proyector">PROYECTOR</option>
                        <option value="varios">VARIOS</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de materiales -->
    <div class="tabla-container">
        <table class="libros-table">
            <thead>
                <tr>
                    <th class="text-center">N¬∞ Inv.</th>
                    <th>T√≠tulo</th>
                    <th>Autor</th>
                    <th>Editorial</th>
                    <th class="text-center">CDU</th>
                    <th class="text-center">Siglas</th>
                    <th class="text-center">Sede</th>
                    <th class="text-center">Disponibilidad</th>
                    <th class="text-center">Imagen</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody id="libros-table">
                {% if libros %}
                    {% for libro in libros %}
                    <tr class="libro-row{% if libro.estado == 'No disponible' %} libro-no-disponible{% endif %}" 
                        data-estado="{{ libro.estado|lower }}"
                        data-titulo="{{ libro.titulo|lower }}"
                        data-autor="{{ libro.autor|lower }}"
                        data-editorial="{{ libro.editorial|lower }}">
                        <td class="text-center">{{ libro.num_inventario|default:'' }}</td>
                        <td class="titulo-cell">{{ libro.titulo }}</td>
                        <td>{{ libro.autor }}</td>
                        <td>{{ libro.editorial }}</td>
                        <td class="text-center">{{ libro.clasificacion_cdu|default:'' }}</td>
                        <td class="text-center">{{ libro.siglas_autor_titulo }}</td>
                        <td class="text-center">{{ libro.sede|default:'LA PLATA' }}</td>
                        <td class="disponibilidad-cell">
                            {% if libro.estado == 'Disponible' %}
                                <span class="disponible">Disponible para pr√©stamo</span>
                            {% elif libro.estado == 'Reservado' %}
                                <span class="reservado">{{ libro.estado }}</span>
                            {% else %}
                                <span class="no-disponible">{{ libro.estado }}</span>
                            {% endif %}
                        </td>
                        <td class="imagen-cell">
                            {% if libro.img %}
                                <img src="{{ libro.img }}" alt="{{ libro.titulo }}" class="libro-thumbnail">
                            {% else %}
                                <img src="https://via.placeholder.com/50x70/95a5a6/ffffff?text=Sin+Imagen" alt="{{ libro.titulo }}" class="libro-thumbnail">
                            {% endif %}
                        </td>
                        <td class="acciones-cell">
                            <button class="btn-icon btn-detalle" title="Ver detalles" onclick="verDetalles('{{ libro.id_libro }}')">
                                üìã
                            </button>
                            <a href="{% url 'editar_libro' libro.id_libro %}" class="btn-icon btn-editar" title="Editar">
                                ‚úèÔ∏è
                            </a>
                            <button class="btn-icon btn-imprimir" title="Imprimir" onclick="imprimirLibro('{{ libro.id_libro }}')">
                                üñ®Ô∏è
                            </button>
                            {% if libro.estado == 'Disponible' %}
                <button class="btn-icon btn-eliminar" title="Dar de baja" 
                    onclick="darDeBaja('{{ libro.id_libro }}', '{{ libro.titulo|escapejs }}')">
                                    üóëÔ∏è
                                </button>
                            {% elif libro.estado == 'No disponible' %}
                <button class="btn-icon btn-ver-informe" title="Ver informe de baja" 
                    onclick="verInformeBaja('{{ libro.id_libro }}')">
                                    üìÑ
                                </button>
                                
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="10" class="no-results">No se encontraron libros disponibles.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- MODAL PARA IMPRIMIR OBLEAS -->
<div class="modal fade" id="obleasModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" style="border: none; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <!-- Header del modal -->
            <div class="modal-header" style="background: linear-gradient(135deg, #4ECDC4, #44A08D); color: white; padding: 1.5rem; border: none;">
                <h5 class="modal-title" style="font-weight: 700; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; margin: 0;">
                    üìã IMPRIMIR OBLEAS - <span id="contadorObleas">0</span> OBLEAS SELECCIONADAS
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" 
                        style="filter: brightness(0) invert(1); opacity: 0.8; font-size: 1.2rem;"></button>
            </div>

            <div class="modal-body" style="padding: 2rem; background: #f8f9fa; max-height: 70vh; overflow-y: auto;">
                <!-- √Årea de vista previa de obleas -->
                <div id="obleasContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; min-height: 200px; background: white; padding: 20px; border-radius: 10px; border: 2px dashed #4ECDC4;">
                    <div id="placeholder" style="grid-column: 1 / -1; text-align: center; color: #95a5a6; font-style: italic; padding: 40px;">
                        Haz clic en "Imprimir" de cualquier libro para agregar obleas aqu√≠
                    </div>
                </div>
            </div>

            <!-- Footer del modal -->
            <div class="modal-footer" style="background: #f8f9fa; padding: 1rem 2rem; border: none; justify-content: space-between;">
                <div style="display: flex; gap: 1rem;">
                    <button type="button" id="limpiarObleas" class="btn" 
                            style="background: #95a5a6; color: white; border: none; padding: 10px 25px; border-radius: 25px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 13px;">
                        üóëÔ∏è LIMPIAR TODO
                    </button>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn" data-bs-dismiss="modal" 
                            style="background: #4285F4; color: white; border: none; padding: 10px 30px; border-radius: 25px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 13px;">
                        CANCELAR
                    </button>
                    <button type="button" id="imprimirPDF" class="btn"
                            style="background: #27ae60; color: white; border: none; padding: 10px 30px; border-radius: 25px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 13px;">
                        üñ®Ô∏è GENERAR PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* ===== ESTILOS PARA EL MODAL DE OBLEAS ===== */

/* Modal de obleas */
#obleasModal .modal-dialog {
    max-width: 95%;
    width: 1200px;
}

/* Estilos para las obleas */
.oblea {
    width: 100px;
    height: 140px;
    border: 2px solid #2c3e50;
    border-radius: 8px;
    padding: 8px;
    background: white;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    text-align: center;
    font-family: 'Courier New', monospace;
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: relative;
    cursor: pointer;
    transition: all 0.2s ease;
}

.oblea:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.oblea .cdu {
    font-size: 14px;
    color: #2c3e50;
    font-weight: 900;
    line-height: 1.2;
    margin-bottom: 8px;
    padding: 4px;
    border-bottom: 1px solid #bdc3c7;
}

.oblea .siglas {
    font-size: 12px;
    color: #34495e;
    font-weight: 700;
    margin-bottom: 8px;
    word-wrap: break-word;
    line-height: 1.1;
}

.oblea .ejemplar {
    font-size: 11px;
    color: #7f8c8d;
    font-weight: 600;
    margin-top: auto;
    padding-top: 4px;
    border-top: 1px solid #ecf0f1;
}

.oblea .eliminar {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

.oblea:hover .eliminar {
    display: flex;
}

/* Animaciones */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.oblea {
    animation: slideIn 0.3s ease;
}

/* Responsive para obleas */
@media (max-width: 768px) {
    #obleasContainer {
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
        gap: 10px;
    }
    
    .oblea {
        width: 85px;
        height: 120px;
        padding: 6px;
    }
    
    .oblea .cdu {
        font-size: 12px;
    }
    
    .oblea .siglas {
        font-size: 10px;
    }
    
    .oblea .ejemplar {
        font-size: 9px;
    }
}

/* Estilos para impresi√≥n */
@media print {
    body * {
        visibility: hidden;
    }
    
    #obleasContainer, #obleasContainer * {
        visibility: visible;
    }
    
    #obleasContainer {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: white !important;
        border: none !important;
        padding: 10mm !important;
        display: grid !important;
        grid-template-columns: repeat(auto-fill, minmax(30mm, 1fr)) !important;
        gap: 5mm !important;
    }
    
    .oblea {
        width: 30mm !important;
        height: 40mm !important;
        border: 1px solid black !important;
        margin: 0 !important;
        box-shadow: none !important;
        page-break-inside: avoid;
    }
    
    .oblea .eliminar {
        display: none !important;
    }
}

/* Efectos hover para botones del modal */
#obleasModal .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}
</style>

<!-- MODAL PARA DAR DE BAJA -->
<div class="modal fade" id="bajaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="border: none; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <!-- Header del modal -->
            <div class="modal-header" style="background: linear-gradient(135deg, #4ECDC4, #44A08D); color: white; padding: 1.5rem; border: none;">
                <h5 class="modal-title" style="font-weight: 700; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; margin: 0;">
                    DAR DE BAJA AL MATERIAL SELECCIONADO:
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" 
                        style="filter: brightness(0) invert(1); opacity: 0.8; font-size: 1.2rem;"></button>
            </div>

            <form method="POST" action="{% url 'baja_libro' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body" style="padding: 0; background: #f8f9fa;">
                    <input type="hidden" id="libro_id" name="libro_id">
                    
                    <!-- Informaci√≥n del libro -->
                    <div style="background: linear-gradient(135deg, #e8f4f8, #f0f8ff); padding: 1.5rem; border-bottom: 2px solid #4ECDC4;">
                        <div class="row align-items-center">
                            <div class="col-2 text-center">
                                <div style="width: 80px; height: 100px; background: #ddd; border-radius: 8px; margin: 0 auto; position: relative; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                                    <img id="libro_imagen_modal" src="" alt="Libro" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                    <div id="libro_placeholder" style="width: 100%; height: 100%; background: #bdc3c7; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; text-align: center;">
                                        Sin<br>Imagen
                                    </div>
                                </div>
                            </div>
                            <div class="col-10">
                                <table style="width: 100%; font-size: 14px; color: #2c3e50;">
                                    <tr style="border-bottom: 1px solid #ddd;">
                                        <td style="padding: 8px 12px; font-weight: 600; background: #ecf0f1; width: 15%; text-align: center;">N¬∞ Inv.</td>
                                        <td style="padding: 8px 12px; font-weight: 600; background: #ecf0f1; width: 25%;">T√≠tulo</td>
                                        <td style="padding: 8px 12px; font-weight: 600; background: #ecf0f1; width: 20%;">Autor</td>
                                        <td style="padding: 8px 12px; font-weight: 600; background: #ecf0f1; width: 15%;">Editorial</td>
                                        <td style="padding: 8px 12px; font-weight: 600; background: #ecf0f1; width: 10%; text-align: center;">CDU</td>
                                        <td style="padding: 8px 12px; font-weight: 600; background: #ecf0f1; width: 10%; text-align: center;">Siglas</td>
                                        <td style="padding: 8px 12px; font-weight: 600; background: #ecf0f1; width: 15%; text-align: center;">Sede</td>
                                    </tr>
                                    <tr style="background: rgba(78, 205, 196, 0.1);">
                                        <td style="padding: 12px 12px; text-align: center; font-weight: 600;" id="modal_num_inventario">1</td>
                                        <td style="padding: 12px 12px; font-weight: 600; color: #2c3e50;" id="modal_titulo">T√≠tulo del libro</td>
                                        <td style="padding: 12px 12px;" id="modal_autor">Autor</td>
                                        <td style="padding: 12px 12px;" id="modal_editorial">Editorial</td>
                                        <td style="padding: 12px 12px; text-align: center;" id="modal_cdu">CDU</td>
                                        <td style="padding: 12px 12px; text-align: center; font-weight: 600;" id="modal_siglas">ABC</td>
                                        <td style="padding: 12px 12px; text-align: center;" id="modal_sede">LA PLATA</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n de formulario -->
                    <div style="padding: 1.5rem;">
                        <div class="row">
                            <!-- Motivo de baja -->
                            <div class="col-md-6">
                                <div style="background: white; padding: 1.5rem; border-radius: 10px; border: 2px solid #4ECDC4; height: 100%;">
                                    <h6 style="color: #4ECDC4; font-weight: 700; text-transform: uppercase; margin-bottom: 1rem; font-size: 14px; letter-spacing: 0.5px;">
                                        Motivo de baja*
                                    </h6>
                                    <textarea class="form-control" id="motivo_baja" name="motivo_baja" 
                                              rows="6" required placeholder="Describe el motivo de la baja del material..."
                                              style="border: 1px solid #ddd; border-radius: 8px; font-size: 14px; resize: none; padding: 12px;"></textarea>
                                </div>
                            </div>

                            <!-- Cargar imagen -->
                            <div class="col-md-6">
                                <div style="background: white; padding: 1.5rem; border-radius: 10px; border: 2px solid #f39c12; height: 100%;">
                                    <h6 style="color: #f39c12; font-weight: 700; text-transform: uppercase; margin-bottom: 1rem; font-size: 14px; letter-spacing: 0.5px;">
                                        Cargar imagen de baja
                                    </h6>
                                    
                                    <div style="text-align: center; margin-bottom: 1rem;">
                                        <div style="width: 120px; height: 80px; border: 2px dashed #f39c12; border-radius: 8px; margin: 0 auto; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; background: #fef9e7;" onclick="document.getElementById('imagen_rota').click()">
                                            <div style="text-align: center; color: #f39c12;">
                                                <div style="font-size: 24px; margin-bottom: 4px;">üìÅ</div>
                                                <div style="font-size: 11px; font-weight: 600;">SUBIR ARCHIVO</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <input type="file" class="form-control" id="imagen_rota" name="imagen_rota" 
                                           accept="image/*" style="display: none;">
                                    
                                    <div style="margin-top: 1rem;">
                                        <label style="color: #7B68EE; font-weight: 600; font-size: 12px; text-transform: uppercase; margin-bottom: 0.5rem; display: block;">
                                            Localizaci√≥n
                                        </label>
                                        <input type="text" class="form-control" placeholder="Guardar en..."
                                               style="border: 1px solid #ddd; border-radius: 5px; font-size: 13px; padding: 8px;" readonly value="Galer√≠a de bajas">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer del modal -->
                <div class="modal-footer" style="background: #f8f9fa; padding: 1rem 1.5rem; border: none; justify-content: center; gap: 1rem;">
                    <button type="button" class="btn" data-bs-dismiss="modal" 
                            style="background: #4285F4; color: white; border: none; padding: 10px 30px; border-radius: 25px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 13px; min-width: 120px; transition: all 0.3s ease;">
                        CANCELAR
                    </button>
                    <button type="submit" class="btn"
                            style="background: #ff6b35; color: white; border: none; padding: 10px 30px; border-radius: 25px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 13px; min-width: 120px; transition: all 0.3s ease;">
                        CONFIRMAR
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para ver informe de baja -->
<div class="modal fade" id="verInformeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="border: none; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <!-- Header del modal -->
            <div class="modal-header" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 1.5rem; border: none;">
                <h5 class="modal-title" style="font-weight: 700; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; margin: 0;">
                    üìã INFORME DE BAJA DEL MATERIAL
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" 
                        style="filter: brightness(0) invert(1); opacity: 0.8; font-size: 1.2rem;"></button>
            </div>

            <div class="modal-body" style="padding: 2rem; background: #f8f9fa;">
                <!-- Informaci√≥n del libro dado de baja -->
                <div style="background: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; border-left: 5px solid #dc3545;">
                    <div class="row">
                        <div class="col-3 text-center">
                            <div style="width: 100px; height: 130px; background: #ddd; border-radius: 8px; margin: 0 auto; position: relative; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                                <img id="informe_imagen" src="" alt="Libro" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                <div id="informe_placeholder" style="width: 100%; height: 100%; background: #bdc3c7; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; text-align: center;">
                                    Sin<br>Imagen
                                </div>
                            </div>
                        </div>
                        <div class="col-9">
                            <table style="width: 100%; font-size: 14px; color: #2c3e50;">
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 8px 0; font-weight: 600; width: 30%;">N¬∞ Inventario:</td>
                                    <td style="padding: 8px 0;" id="informe_num_inventario">-</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 8px 0; font-weight: 600;">T√≠tulo:</td>
                                    <td style="padding: 8px 0; font-weight: 600; color: #dc3545;" id="informe_titulo">-</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 8px 0; font-weight: 600;">Autor:</td>
                                    <td style="padding: 8px 0;" id="informe_autor">-</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 8px 0; font-weight: 600;">CDU:</td>
                                    <td style="padding: 8px 0;" id="informe_cdu">-</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 8px 0; font-weight: 600;">Siglas:</td>
                                    <td style="padding: 8px 0;" id="informe_siglas">-</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; font-weight: 600;">Fecha de baja:</td>
                                    <td style="padding: 8px 0; color: #dc3545;" id="informe_fecha_baja">30/10/2024</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Motivo de baja -->
                <div style="background: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem;">
                    <h6 style="color: #dc3545; font-weight: 700; text-transform: uppercase; margin-bottom: 1rem; font-size: 14px; letter-spacing: 0.5px;">
                        Motivo de la baja
                    </h6>
                    <div id="informe_motivo" style="padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #dc3545; font-size: 14px; line-height: 1.5;">
                        Cargando motivo de baja...
                    </div>
                </div>

                <!-- Imagen de la baja (si existe) -->
                <div id="imagen_baja_container" style="background: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; display: none;">
                    <h6 style="color: #dc3545; font-weight: 700; text-transform: uppercase; margin-bottom: 1rem; font-size: 14px; letter-spacing: 0.5px;">
                        Imagen de la baja
                    </h6>
                    <div style="text-align: center;">
                        <img id="imagen_baja" src="" alt="Imagen de baja" style="max-width: 300px; max-height: 200px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    </div>
                </div>
            </div>

            <!-- Footer del modal -->
            <div class="modal-footer" style="background: #f8f9fa; padding: 1rem 2rem; border: none; justify-content: center; gap: 1rem;">
                <button type="button" class="btn" data-bs-dismiss="modal" 
                        style="background: #6c757d; color: white; border: none; padding: 10px 30px; border-radius: 25px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 13px;">
                    CERRAR
                </button>
                <button type="button" id="btnDarDeAlta" class="btn"
                        style="background: #28a745; color: white; border: none; padding: 10px 30px; border-radius: 25px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 13px;">
                    üîÑ DAR DE ALTA
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ========== PARTE 3: MODAL CONFIRMACI√ìN DAR DE ALTA ========== -->

<!-- Modal de confirmaci√≥n para dar de alta -->
<div class="modal fade" id="confirmarAltaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-dar-alta">
            <!-- Header del modal -->
            <div class="modal-header">
                <h5 class="modal-title">
                    ¬øDESEA VOLVER A PONER EL MATERIAL COMO DISPONIBLE?
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" 
                        style="filter: brightness(0) invert(1); opacity: 0.8;"></button>
            </div>

            <div class="modal-body" style="padding: 2rem; background: white; text-align: center;">
                <div style="font-size: 48px; color: #28a745; margin-bottom: 1rem;">üìö</div>
                <p style="font-size: 16px; color: #495057; margin-bottom: 2rem; line-height: 1.5;">
                    El libro <strong id="confirm_titulo_libro">t√≠tulo del libro</strong> volver√° a estar disponible para pr√©stamos.
                </p>
            </div>

            <!-- Footer del modal -->
            <div class="modal-footer" style="background: #f8f9fa; padding: 1rem 2rem; border: none; justify-content: center; gap: 1rem;">
                <button type="button" class="btn" data-bs-dismiss="modal" 
                        style="background: #6c757d; color: white; border: none; padding: 10px 30px; border-radius: 25px; font-weight: 600; text-transform: uppercase;">
                    CANCELAR
                </button>
                <button type="button" id="confirmarDarAlta" class="btn"
                        style="background: #fd7e14; color: white; border: none; padding: 10px 30px; border-radius: 25px; font-weight: 600; text-transform: uppercase;">
                    CONFIRMAR
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ========== PARTE 4: MODAL MODIFICAR DATOS ANTES DE DAR DE ALTA ========== -->

<!-- Modal para modificar datos antes de dar de alta -->
<div class="modal fade" id="modificarDatosModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content modal-dar-alta">
            <!-- Header del modal -->
            <div class="modal-header">
                <h5 class="modal-title">
                    CONFIRMAR DAR DE ALTA EL MATERIAL
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" 
                        style="filter: brightness(0) invert(1); opacity: 0.8;"></button>
            </div>

            <form id="formDarAlta" method="POST" action="{% url 'dar_alta_libro' %}">
                {% csrf_token %}
                <div class="modal-body" style="padding: 2rem; background: white;">
                    <input type="hidden" id="alta_libro_id" name="libro_id">
                    
                    <div class="row">
                        <!-- Sede -->
                        <div class="col-md-6">
                            <div class="form-group-custom">
                                <label for="alta_sede">Sede*</label>
                                <select class="form-control-custom select-custom" id="alta_sede" name="sede" required>
                                    <option value="LA PLATA" selected>LA PLATA</option>
                                    <option value="BERISSO">BERISSO</option>
                                    <option value="ENSENADA">ENSENADA</option>
                                </select>
                            </div>
                        </div>

                        <!-- Disponibilidad -->
                        <div class="col-md-6">
                            <div class="form-group-custom">
                                <label for="alta_disponibilidad">Disponibilidad*</label>
                                <select class="form-control-custom select-custom" id="alta_disponibilidad" name="disponibilidad" required>
                                    <option value="Domicilio" selected>Domicilio</option>
                                    <option value="Aula">Aula</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Observaciones -->
                    <div class="form-group-custom">
                        <label for="alta_observaciones">Observaciones</label>
                        <textarea class="form-control-custom" id="alta_observaciones" name="observaciones" 
                                  rows="3" placeholder="Observaciones adicionales sobre la reactivaci√≥n del material..."></textarea>
                    </div>
                </div>

                <!-- Footer del modal -->
                <div class="modal-footer" style="background: #f8f9fa; padding: 1rem 2rem; border: none; justify-content: center; gap: 1rem;">
                    <button type="button" class="btn" data-bs-dismiss="modal" 
                            style="background: #6c757d; color: white; border: none; padding: 10px 30px; border-radius: 25px; font-weight: 600; text-transform: uppercase;">
                        CANCELAR
                    </button>
                    <button type="submit" class="btn"
                            style="background: #28a745; color: white; border: none; padding: 10px 30px; border-radius: 25px; font-weight: 600; text-transform: uppercase;">
                        CONFIRMAR
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ========== PARTE 5: MODAL √âXITO ========== -->

<!-- Modal de √©xito -->
<div class="modal fade" id="exitoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-dar-alta">
            <div class="modal-body" style="padding: 3rem; background: white; text-align: center;">
                <div style="font-size: 64px; color: #28a745; margin-bottom: 1rem;">‚úÖ</div>
                <h5 style="color: #28a745; font-weight: 700; margin-bottom: 1rem; text-transform: uppercase;">
                    EL ALTA DEL MATERIAL<br>
                    <span id="exito_titulo">TITULO</span> COL S<br>
                    HA CONCLUIDO CON √âXITO
                </h5>
            </div>
            
            <div class="modal-footer" style="background: white; border: none; justify-content: center; padding-bottom: 2rem;">
                <button type="button" class="btn" data-bs-dismiss="modal" onclick="location.reload()"
                        style="background: #28a745; color: white; border: none; padding: 12px 40px; border-radius: 25px; font-weight: 600; text-transform: uppercase;">
                    ACEPTAR
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver detalles del material -->
<div class="modal fade" id="detallesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" style="border: none; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <!-- Header del modal -->
            <div class="modal-header" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 1.5rem; border: none;">
                <h5 class="modal-title" style="font-weight: 700; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; margin: 0;">
                    üìã DETALLES DEL MATERIAL
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" 
                        style="filter: brightness(0) invert(1); opacity: 0.8; font-size: 1.2rem;"></button>
            </div>

            <div class="modal-body" style="padding: 2rem; background: #f8f9fa; max-height: 80vh; overflow-y: auto;">
                <!-- Informaci√≥n principal con imagen -->
                <div class="row mb-4">
                    <!-- Imagen del libro -->
                    <div class="col-md-4 text-center">
                        <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                            <h6 style="color: #3498db; font-weight: 700; text-transform: uppercase; margin-bottom: 1rem; font-size: 14px;">
                                Imagen del Material
                            </h6>
                            <div style="width: 200px; height: 280px; margin: 0 auto; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15); position: relative;">
                                <img id="detalle_imagen_principal" src="" alt="Material" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                <div id="detalle_placeholder_principal" style="width: 100%; height: 100%; background: linear-gradient(135deg, #bdc3c7, #95a5a6); display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; text-align: center; font-weight: 600;">
                                    Sin<br>Imagen<br>Disponible
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n detallada -->
                    <div class="col-md-8">
                        <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                            <h6 style="color: #3498db; font-weight: 700; text-transform: uppercase; margin-bottom: 1rem; font-size: 14px;">
                                Informaci√≥n del Material
                            </h6>
                            
                            <table style="width: 100%; font-size: 14px; color: #2c3e50;">
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 12px 0; font-weight: 600; width: 35%;">N¬∞ Inventario:</td>
                                    <td style="padding: 12px 0;" id="detalle_num_inventario">-</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 12px 0; font-weight: 600;">T√≠tulo:</td>
                                    <td style="padding: 12px 0; font-weight: 600; color: #3498db;" id="detalle_titulo">-</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 12px 0; font-weight: 600;">Autor:</td>
                                    <td style="padding: 12px 0;" id="detalle_autor">-</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 12px 0; font-weight: 600;">Editorial:</td>
                                    <td style="padding: 12px 0;" id="detalle_editorial">-</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 12px 0; font-weight: 600;">CDU:</td>
                                    <td style="padding: 12px 0;" id="detalle_cdu">-</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 12px 0; font-weight: 600;">Siglas:</td>
                                    <td style="padding: 12px 0;" id="detalle_siglas">-</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 12px 0; font-weight: 600;">Sede:</td>
                                    <td style="padding: 12px 0;" id="detalle_sede">-</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 12px 0; font-weight: 600;">Disponibilidad:</td>
                                    <td style="padding: 12px 0;" id="detalle_disponibilidad">-</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px 0; font-weight: 600;">Estado:</td>
                                    <td style="padding: 12px 0;" id="detalle_estado">-</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Descripci√≥n y detalles adicionales -->
                <div class="row">
                    <!-- Descripci√≥n -->
                    <div class="col-md-6 mb-3">
                        <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); height: 100%;">
                            <h6 style="color: #3498db; font-weight: 700; text-transform: uppercase; margin-bottom: 1rem; font-size: 14px;">
                                Descripci√≥n
                            </h6>
                            <div id="detalle_descripcion" style="padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db; font-size: 14px; line-height: 1.5; min-height: 80px;">
                                Cargando descripci√≥n...
                            </div>
                        </div>
                    </div>

                    <!-- Observaciones -->
                    <div class="col-md-6 mb-3">
                        <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); height: 100%;">
                            <h6 style="color: #3498db; font-weight: 700; text-transform: uppercase; margin-bottom: 1rem; font-size: 14px;">
                                Observaciones
                            </h6>
                            <div id="detalle_observaciones" style="padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745; font-size: 14px; line-height: 1.5; min-height: 80px;">
                                Cargando observaciones...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Palabras clave -->
                <div class="row">
                    <div class="col-12">
                        <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                            <h6 style="color: #3498db; font-weight: 700; text-transform: uppercase; margin-bottom: 1rem; font-size: 14px;">
                                Etiquetas / Palabras Clave
                            </h6>
                            <div id="detalle_etiquetas" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <!-- Las etiquetas se cargar√°n din√°micamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer del modal -->
            <div class="modal-footer" style="background: #f8f9fa; padding: 1rem 2rem; border: none; justify-content: center;">
                <button type="button" class="btn" data-bs-dismiss="modal" 
                        style="background: #6c757d; color: white; border: none; padding: 10px 30px; border-radius: 25px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 13px;">
                    CERRAR
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* ===== ESTILOS PARA EL MODAL DE BAJA ===== */

.modal-backdrop {
    background-color: rgba(0, 0, 0, 0.6);
}

#bajaModal .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

#bajaModal .form-control:focus {
    border-color: #4ECDC4;
    box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.2);
}

/* Animaci√≥n de hover para la zona de subida */
#bajaModal .upload-zone:hover {
    background: #fef2e7 !important;
    border-color: #e67e22 !important;
    transform: scale(1.02);
}

/* Responsive */
@media (max-width: 768px) {
    #bajaModal .modal-dialog {
        margin: 1rem;
        max-width: none;
    }
    
    #bajaModal .modal-body .row {
        flex-direction: column;
    }
    
    #bajaModal .modal-body .col-md-6 {
        margin-bottom: 1rem;
    }
}
</style>

{% endblock %}

{% block modals %}
  {% include 'modals/detalles_material.html' %}
  {% include 'modals/manual_modal.html' %}
{% endblock %}

{% block extra_scripts %}
<script>
// ===== SISTEMA DE GESTI√ìN DE OBLEAS =====
class SistemaObleas {
    constructor() {
        this.obleas = [];
        this.contadorEjemplar = {};
        this.init();
    }
    
    init() {
        // Event listeners para el modal de obleas
        document.getElementById('limpiarObleas').addEventListener('click', () => this.limpiarTodo());
        document.getElementById('imprimirPDF').addEventListener('click', () => this.generarPDF());
        
        // Cerrar modal con escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('obleasModal').classList.contains('show')) {
                this.cerrarModal();
            }
        });
        
        // Inicializar estado del bot√≥n imprimir
        this.actualizarContador();
    }
    
    agregarOblea(libroData) {
        // Generar n√∫mero de ejemplar √∫nico por CDU + Siglas
        const clave = `${libroData.cdu}_${libroData.siglas}`;
        if (!this.contadorEjemplar[clave]) {
            this.contadorEjemplar[clave] = 0;
        }
        this.contadorEjemplar[clave]++;
        
        // Crear oblea con datos del libro
        const oblea = {
            id: Date.now() + Math.random(),
            cdu: libroData.cdu || 'SIN CDU',
            siglas: libroData.siglas || 'ABC',
            ejemplar: this.contadorEjemplar[clave],
            titulo: libroData.titulo,
            autor: libroData.autor
        };
        
        // Agregar a la colecci√≥n y actualizar vista
        this.obleas.push(oblea);
        this.renderizarObleas();
        this.actualizarContador();
        this.mostrarModal();
        
        // Mostrar notificaci√≥n de √©xito
        this.mostrarNotificacion(`Oblea agregada: ${oblea.cdu} - ${oblea.siglas} (Ej. ${oblea.ejemplar})`);
    }
    
    eliminarOblea(id) {
        // Encontrar la oblea a eliminar
        const obleaAEliminar = this.obleas.find(oblea => oblea.id === id);
        if (!obleaAEliminar) return;
        
        // Confirmar eliminaci√≥n
        if (confirm(`¬øEliminar oblea ${obleaAEliminar.cdu} - ${obleaAEliminar.siglas}?`)) {
            this.obleas = this.obleas.filter(oblea => oblea.id !== id);
            this.renderizarObleas();
            this.actualizarContador();
            
            // Mostrar notificaci√≥n
            this.mostrarNotificacion(`Oblea eliminada: ${obleaAEliminar.cdu} - ${obleaAEliminar.siglas}`, 'warning');
        }
    }
    
    limpiarTodo() {
        if (this.obleas.length === 0) {
            alert('No hay obleas para limpiar');
            return;
        }
        
        if (confirm(`¬øEst√° seguro de eliminar todas las ${this.obleas.length} obleas?`)) {
            this.obleas = [];
            this.contadorEjemplar = {};
            this.renderizarObleas();
            this.actualizarContador();
            
            // Mostrar notificaci√≥n
            this.mostrarNotificacion('Todas las obleas han sido eliminadas', 'info');
        }
    }
    
    renderizarObleas() {
        const container = document.getElementById('obleasContainer');
        
        if (this.obleas.length === 0) {
            container.innerHTML = `
                <div id="placeholder" style="grid-column: 1 / -1; text-align: center; color: #95a5a6; font-style: italic; padding: 40px;">
                    Haz clic en "Imprimir" de cualquier libro para agregar obleas aqu√≠
                </div>
            `;
            return;
        }
        
        // Generar HTML para cada oblea
        container.innerHTML = this.obleas.map(oblea => `
            <div class="oblea" title="T√≠tulo: ${oblea.titulo} | Autor: ${oblea.autor}">
                <button class="eliminar" onclick="sistemaObleas.eliminarOblea(${oblea.id})" title="Eliminar oblea">√ó</button>
                <div class="cdu">${oblea.cdu}</div>
                <div class="siglas">${oblea.siglas}</div>
                <div class="ejemplar">Ej. ${oblea.ejemplar}</div>
            </div>
        `).join('');
    }
    
    actualizarContador() {
        const contador = document.getElementById('contadorObleas');
        const btnImprimir = document.getElementById('imprimirPDF');
        
        // Actualizar texto del contador
        contador.textContent = this.obleas.length;
        
        // Cambiar estado del bot√≥n seg√∫n la cantidad de obleas
        if (this.obleas.length === 0) {
            btnImprimir.style.background = '#95a5a6';
            btnImprimir.disabled = true;
            btnImprimir.textContent = 'üñ®Ô∏è GENERAR PDF';
        } else {
            btnImprimir.style.background = '#27ae60';
            btnImprimir.disabled = false;
            btnImprimir.textContent = `üñ®Ô∏è GENERAR PDF (${this.obleas.length})`;
        }
    }
    
    mostrarModal() {
        const modal = new bootstrap.Modal(document.getElementById('obleasModal'));
        modal.show();
    }
    
    cerrarModal() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('obleasModal'));
        if (modal) {
            modal.hide();
        }
    }
    
    mostrarNotificacion(mensaje, tipo = 'success') {
        // Crear notificaci√≥n temporal
        const colores = {
            success: '#27ae60',
            warning: '#f39c12',
            info: '#3498db',
            error: '#e74c3c'
        };
        
        const notificacion = document.createElement('div');
        notificacion.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${colores[tipo]};
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: slideInRight 0.3s ease;
        `;
        notificacion.textContent = mensaje;
        
        document.body.appendChild(notificacion);
        
        // Eliminar despu√©s de 3 segundos
        setTimeout(() => {
            notificacion.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => notificacion.remove(), 300);
        }, 3000);
    }
    
    generarPDF() {
        if (this.obleas.length === 0) {
            alert('No hay obleas para imprimir');
            return;
        }
        
        // Crear ventana de impresi√≥n optimizada
        const ventanaImpresion = window.open('', '_blank', 'width=800,height=600');
        
        ventanaImpresion.document.write(`
            <!DOCTYPE html>
            <html lang="es">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Obleas - Biblioteca Digital - ${new Date().toLocaleDateString()}</title>
                <style>
                    @page {
                        margin: 10mm;
                        size: A4;
                    }
                    
                    * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                    }
                    
                    body {
                        font-family: 'Courier New', monospace;
                        background: white;
                    }
                    
                    .header {
                        text-align: center;
                        margin-bottom: 10mm;
                        border-bottom: 2px solid #333;
                        padding-bottom: 5mm;
                    }
                    
                    .header h1 {
                        font-size: 18pt;
                        font-weight: bold;
                        margin-bottom: 2mm;
                    }
                    
                    .header p {
                        font-size: 12pt;
                        color: #666;
                    }
                    
                    .obleas-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fill, minmax(35mm, 1fr));
                        gap: 8mm;
                        width: 100%;
                        justify-items: center;
                    }
                    
                    .oblea-print {
                        width: 35mm;
                        height: 45mm;
                        border: 2px solid #000;
                        padding: 3mm;
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                        text-align: center;
                        font-weight: bold;
                        page-break-inside: avoid;
                        background: white;
                        border-radius: 2mm;
                    }
                    
                    .oblea-print .cdu {
                        font-size: 12pt;
                        font-weight: 900;
                        line-height: 1.1;
                        margin-bottom: 3mm;
                        padding-bottom: 2mm;
                        border-bottom: 1pt solid #333;
                        color: #000;
                    }
                    
                    .oblea-print .siglas {
                        font-size: 10pt;
                        font-weight: 700;
                        margin-bottom: 3mm;
                        word-wrap: break-word;
                        line-height: 1.0;
                        color: #333;
                        flex-grow: 1;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    
                    .oblea-print .ejemplar {
                        font-size: 8pt;
                        font-weight: 600;
                        padding-top: 2mm;
                        border-top: 1pt solid #666;
                        color: #666;
                    }
                    
                    .footer {
                        position: fixed;
                        bottom: 5mm;
                        left: 0;
                        right: 0;
                        text-align: center;
                        font-size: 8pt;
                        color: #666;
                        border-top: 1pt solid #ddd;
                        padding-top: 2mm;
                    }
                    
                    @media print {
                        .no-print { display: none !important; }
                    }
                </style>
            </head>
            <body>
                <div class="header no-print">
                    <h1>OBLEAS DE BIBLIOTECA</h1>
                    <p>Total de obleas: ${this.obleas.length} | Fecha: ${new Date().toLocaleDateString('es-ES')}</p>
                </div>
                
                <div class="obleas-grid">
                    ${this.obleas.map((oblea, index) => `
                        <div class="oblea-print">
                            <div class="cdu">${oblea.cdu}</div>
                            <div class="siglas">${oblea.siglas}</div>
                            <div class="ejemplar">Ej. ${oblea.ejemplar}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="footer">
                    <p>Biblioteca Digital - Instituto Superior de Formaci√≥n Docente y T√©cnica N¬∞ 210</p>
                </div>
            </body>
            </html>
        `);
        
        ventanaImpresion.document.close();
        
        // Esperar carga y luego imprimir
        ventanaImpresion.onload = function() {
            setTimeout(() => {
                ventanaImpresion.print();
                // Preguntar si cerrar la ventana
                setTimeout(() => {
                    if (confirm('¬øDesea cerrar la ventana de vista previa?')) {
                        ventanaImpresion.close();
                    }
                }, 1000);
            }, 500);
        };
        
        // Mostrar notificaci√≥n de √©xito
        this.mostrarNotificacion(`PDF generado con ${this.obleas.length} obleas`, 'success');
        
        // Cerrar el modal despu√©s de generar PDF
        setTimeout(() => this.cerrarModal(), 1000);
    }
}

// Variable global para el sistema de obleas
let sistemaObleas;

document.addEventListener("DOMContentLoaded", function() {
    // ===== INICIALIZAR SISTEMA DE OBLEAS =====
    sistemaObleas = new SistemaObleas();
    
    // ===== FUNCIONALIDAD DE B√öSQUEDA Y FILTROS =====
    const searchInput = document.getElementById('searchInput');
    const mostrarNoDisponibles = document.getElementById('mostrar_no_disponibles');
    const ordenarPor = document.getElementById('ordenar_por');
    const tipoMaterial = document.getElementById('tipo_material');
    const rows = document.querySelectorAll('.libro-row');

    function filtrarLibros() {
        const searchTerm = searchInput.value.toLowerCase();
        const showUnavailable = mostrarNoDisponibles.checked;
        const tipoSeleccionado = tipoMaterial.value;
        let visibleCount = 0;

        rows.forEach(row => {
            const titulo = row.dataset.titulo;
            const autor = row.dataset.autor;
            const editorial = row.dataset.editorial;
            const estado = row.dataset.estado;
            const tipo = row.dataset.tipo ? row.dataset.tipo : '';

            // Filtrar por tipo de material si est√° seleccionado
            const matchesTipo = !tipoSeleccionado || tipo === tipoSeleccionado;

            // Filtrar por b√∫squeda
            const matchesSearch = titulo.includes(searchTerm) || 
                                 autor.includes(searchTerm) || 
                                 editorial.includes(searchTerm);

            // Filtrar por estado
            const isAvailable = estado === 'disponible' || estado === 'reservado';
            const showRow = matchesTipo && matchesSearch && (showUnavailable || isAvailable);

            row.style.display = showRow ? '' : 'none';
            if (showRow) visibleCount++;
        });

        updateNoResultsMessage(visibleCount);
    }

    function updateNoResultsMessage(count) {
        const tbody = document.getElementById('libros-table');
        let noResultsRow = document.getElementById('no-results-row');
        
        if (count === 0) {
            if (!noResultsRow) {
                noResultsRow = document.createElement('tr');
                noResultsRow.id = 'no-results-row';
                noResultsRow.innerHTML = '<td colspan="10" class="no-results">No se encontraron resultados con los filtros aplicados.</td>';
                tbody.appendChild(noResultsRow);
            }
        } else {
            if (noResultsRow) {
                noResultsRow.remove();
            }
        }
    }

    // Event listeners para filtros
    searchInput.addEventListener('input', filtrarLibros);
    mostrarNoDisponibles.addEventListener('change', filtrarLibros);
    tipoMaterial.addEventListener('change', filtrarLibros);

    // ===== APLICAR FILTRO INICIAL AL CARGAR LA P√ÅGINA =====
    filtrarLibros(); // <- AGREGAR ESTA L√çNEA

    // ===== FUNCIONALIDAD DE ORDENAMIENTO =====
    ordenarPor.addEventListener('change', function() {
        const tbody = document.getElementById('libros-table');
        const rowsArray = Array.from(rows);
        
        rowsArray.sort((a, b) => {
            let aValue, bValue;
            
            switch (this.value) {
                case 'autor':
                    aValue = a.dataset.autor;
                    bValue = b.dataset.autor;
                    break;
                case 'fecha':
                    aValue = parseInt(a.querySelector('td:first-child').textContent) || 0;
                    bValue = parseInt(b.querySelector('td:first-child').textContent) || 0;
                    return bValue - aValue; // Descendente para fechas
                default: // titulo
                    aValue = a.dataset.titulo;
                    bValue = b.dataset.titulo;
            }
            
            return aValue.localeCompare(bValue);
        });
        
        rowsArray.forEach(row => tbody.appendChild(row));
    });

    // ===== MANEJO DE SUBIDA DE IM√ÅGENES EN MODAL DE BAJA =====
    const inputImagen = document.getElementById('imagen_rota');
    
    if (inputImagen) {
        inputImagen.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const uploadZone = document.querySelector('[onclick="document.getElementById(\'imagen_rota\').click()"]');
            
            if (file) {
                uploadZone.innerHTML = `
                    <div style="text-align: center; color: #27ae60;">
                        <div style="font-size: 20px; margin-bottom: 4px;">‚úÖ</div>
                        <div style="font-size: 10px; font-weight: 600;">${file.name}</div>
                    </div>
                `;
                uploadZone.style.background = '#d5f4e6';
                uploadZone.style.borderColor = '#27ae60';
            } else {
                uploadZone.innerHTML = `
                    <div style="text-align: center; color: #f39c12;">
                        <div style="font-size: 24px; margin-bottom: 4px;">üìÅ</div>
                        <div style="font-size: 11px; font-weight: 600;">SUBIR ARCHIVO</div>
                    </div>
                `;
                uploadZone.style.background = '#fef9e7';
                uploadZone.style.borderColor = '#f39c12';
            }
        });
    }

    // ===== EFECTOS HOVER PARA BOTONES DE MODALES =====
    document.addEventListener('mouseover', function(e) {
        if (e.target.style.background === 'rgb(66, 133, 244)') {
            e.target.style.background = '#3367D6';
        } else if (e.target.style.background === 'rgb(255, 107, 53)') {
            e.target.style.background = '#e55a2b';
        }
    });
    
    document.addEventListener('mouseout', function(e) {
        if (e.target.style.background === 'rgb(51, 103, 214)') {
            e.target.style.background = '#4285F4';
        } else if (e.target.style.background === 'rgb(229, 90, 43)') {
            e.target.style.background = '#ff6b35';
        }
    });
});

// ===== FUNCIONES PARA ACCIONES DE LIBROS =====

// Funci√≥n para dar de baja un libro
function darDeBaja(libroId, titulo) {
    const filaLibro = document.querySelector(`tr[data-titulo*="${titulo.toLowerCase()}"]`);
    
    if (!filaLibro) {
        console.error('No se pudo encontrar la fila del libro');
        return;
    }
    
    // Extraer datos de la fila
    const celdas = filaLibro.querySelectorAll('td');
    const numInventario = celdas[0].textContent.trim();
    const tituloLibro = celdas[1].textContent.trim();
    const autor = celdas[2].textContent.trim();
    const editorial = celdas[3].textContent.trim();
    const cdu = celdas[4].textContent.trim();
    const siglas = celdas[5].textContent.trim();
    const sede = celdas[6].textContent.trim();
    
    // Obtener imagen del libro
    const imagenElement = filaLibro.querySelector('.libro-thumbnail');
    const imagenSrc = imagenElement ? imagenElement.src : '';
    
    // Llenar el formulario oculto
    document.getElementById('libro_id').value = libroId;
    
    // Llenar los datos en el modal
    document.getElementById('modal_num_inventario').textContent = numInventario || '1';
    document.getElementById('modal_titulo').textContent = tituloLibro;
    document.getElementById('modal_autor').textContent = autor || 'Sin autor';
    document.getElementById('modal_editorial').textContent = editorial || 'Sin editorial';
    document.getElementById('modal_cdu').textContent = cdu || 'Sin CDU';
    document.getElementById('modal_siglas').textContent = siglas || 'ABC';
    document.getElementById('modal_sede').textContent = sede || 'LA PLATA';
    
    // Manejar la imagen
    const imagenModal = document.getElementById('libro_imagen_modal');
    const placeholderModal = document.getElementById('libro_placeholder');
    
    if (imagenSrc && !imagenSrc.includes('placeholder')) {
        imagenModal.src = imagenSrc;
        imagenModal.style.display = 'block';
        placeholderModal.style.display = 'none';
    } else {
        imagenModal.style.display = 'none';
        placeholderModal.style.display = 'flex';
    }
    
    // Limpiar el formulario
    document.getElementById('motivo_baja').value = '';
    document.getElementById('imagen_rota').value = '';
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('bajaModal'));
    modal.show();
}

// Funci√≥n para reactivar un libro
function reactivarLibro(libroId, titulo) {
    if (confirm(`¬øEst√° seguro de reactivar el libro "${titulo}"?`)) {
        window.location.href = `/reactivar-libro/${libroId}/`;
    }
}

// Funci√≥n para ver detalles de un libro

function verDetalles(libroId) {
    try {
        // Hacer llamada AJAX para obtener detalles completos
        const formData = new FormData();
        formData.append('libro_id', libroId);
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        fetch(`/ver-detalles-material/${libroId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const detalles = data.detalles;
                
                // Llenar datos en el modal
                document.getElementById('detalle_num_inventario').textContent = detalles.num_inventario || '-';
                document.getElementById('detalle_titulo').textContent = detalles.titulo || '-';
                document.getElementById('detalle_autor').textContent = detalles.autor || 'Sin autor';
                document.getElementById('detalle_editorial').textContent = detalles.editorial || 'Sin editorial';
                document.getElementById('detalle_cdu').textContent = detalles.clasificacion_cdu || '-';
                document.getElementById('detalle_siglas').textContent = detalles.siglas_autor_titulo || '-';
                document.getElementById('detalle_sede').textContent = detalles.sede || '-';
                document.getElementById('detalle_disponibilidad').textContent = detalles.disponibilidad || '-';
                document.getElementById('detalle_estado').textContent = detalles.estado || '-';
                document.getElementById('detalle_descripcion').textContent = detalles.descripcion || 'Sin descripci√≥n disponible';
                document.getElementById('detalle_observaciones').textContent = detalles.observaciones || 'Sin observaciones';
                
                // Manejar imagen principal
                const imagenPrincipal = document.getElementById('detalle_imagen_principal');
                const placeholderPrincipal = document.getElementById('detalle_placeholder_principal');
                
                if (detalles.img && detalles.img.trim() !== '') {
                    imagenPrincipal.src = detalles.img;
                    imagenPrincipal.style.display = 'block';
                    placeholderPrincipal.style.display = 'none';
                } else {
                    imagenPrincipal.style.display = 'none';
                    placeholderPrincipal.style.display = 'flex';
                }
                
                // Manejar etiquetas/palabras clave
                const etiquetasContainer = document.getElementById('detalle_etiquetas');
                if (detalles.etiqueta_palabra_clave) {
                    const etiquetas = detalles.etiqueta_palabra_clave.split(',');
                    etiquetasContainer.innerHTML = etiquetas.map(etiqueta => 
                        `<span style="background: #3498db; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600;">${etiqueta.trim()}</span>`
                    ).join('');
                } else {
                    etiquetasContainer.innerHTML = '<span style="color: #6c757d; font-style: italic;">Sin etiquetas</span>';
                }
                
                // Mostrar el modal
                const modal = new bootstrap.Modal(document.getElementById('detallesModal'));
                modal.show();
                
            } else {
                alert(`Error: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los detalles del material');
        });
        
    } catch (error) {
        console.error('Error al ver detalles:', error);
        alert('Error inesperado al cargar los detalles');
    }
}

// ACTUALIZAR LA FUNCI√ìN verInformeBaja para usar datos reales:
function verInformeBaja(libroId) {
    try {
        // Buscar la fila del libro
        const botonInforme = document.querySelector(`button[onclick*="verInformeBaja(${libroId})"]`);
        if (!botonInforme) {
            console.error('No se encontr√≥ el bot√≥n de informe para el libro ID:', libroId);
            alert('Error: No se pudo encontrar la informaci√≥n del libro');
            return;
        }
        
        const filaLibro = botonInforme.closest('tr');
        const celdas = filaLibro.querySelectorAll('td');
        
        // Extraer datos b√°sicos del libro
        const datosLibro = {
            id: libroId,
            numInventario: celdas[0].textContent.trim(),
            titulo: celdas[1].textContent.trim(),
            autor: celdas[2].textContent.trim(),
            editorial: celdas[3].textContent.trim(),
            cdu: celdas[4].textContent.trim(),
            siglas: celdas[5].textContent.trim(),
            sede: celdas[6].textContent.trim()
        };
        
        // Obtener imagen del libro de la tabla
        const imagenElement = filaLibro.querySelector('.libro-thumbnail');
        const imagenSrc = imagenElement ? imagenElement.src : '';
        
        // Llenar datos b√°sicos en el modal
        document.getElementById('informe_num_inventario').textContent = datosLibro.numInventario || '-';
        document.getElementById('informe_titulo').textContent = datosLibro.titulo;
        document.getElementById('informe_autor').textContent = datosLibro.autor || 'Sin autor';
        document.getElementById('informe_cdu').textContent = datosLibro.cdu || '-';
        document.getElementById('informe_siglas').textContent = datosLibro.siglas || '-';
        
        // Manejar imagen del libro
        const imagenModal = document.getElementById('informe_imagen');
        const placeholderModal = document.getElementById('informe_placeholder');
        
        if (imagenSrc && !imagenSrc.includes('placeholder')) {
            imagenModal.src = imagenSrc;
            imagenModal.style.display = 'block';
            placeholderModal.style.display = 'none';
        } else {
            imagenModal.style.display = 'none';
            placeholderModal.style.display = 'flex';
        }
        
        // Guardar datos para dar de alta
        libroActualParaAlta = datosLibro;
        
        // Mostrar el modal
        const modal = new bootstrap.Modal(document.getElementById('verInformeModal'));
        modal.show();
        
        // Obtener datos REALES del informe en segundo plano
        const formData = new FormData();
        formData.append('libro_id', libroId);
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        fetch('/obtener-informe-baja/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const informe = data.informe;
                
                // Actualizar con datos REALES de la base de datos
                document.getElementById('informe_fecha_baja').textContent = informe.fecha_baja || '30/10/2024';
                document.getElementById('informe_motivo').textContent = informe.motivo || 'Motivo no registrado';
                
                // Manejar imagen de la baja REAL
                const imagenBajaContainer = document.getElementById('imagen_baja_container');
                const imagenBaja = document.getElementById('imagen_baja');
                
                if (informe.imagen_baja) {
                    imagenBaja.src = informe.imagen_baja;
                    imagenBajaContainer.style.display = 'block';
                } else {
                    imagenBajaContainer.style.display = 'none';
                }
            }
        })
        .catch(error => {
            console.error('Error al obtener informe:', error);
            // Mantener datos por defecto si hay error
        });
        
        console.log('Informe mostrado para libro:', datosLibro);
        
    } catch (error) {
        console.error('Error al mostrar informe de baja:', error);
        alert('Error inesperado al cargar el informe. Verifique la consola para m√°s detalles.');
    }
}

// ACTUALIZAR LA FUNCI√ìN actualizarBotonesAcciones para quitar el bot√≥n de reactivar:
function actualizarBotonesAcciones() {
    const rows = document.querySelectorAll('.libro-row');
    rows.forEach(row => {
        const estado = row.dataset.estado;
        const celdaAcciones = row.querySelector('.acciones-cell');
        const libroId = row.querySelector('.btn-icon').getAttribute('onclick').match(/\d+/)[0];
        
        if (estado === 'no disponible') {
            // Verificar si ya tiene el bot√≥n de ver informe
            const tieneBotonInforme = celdaAcciones.querySelector(`button[onclick*="verInformeBaja"]`);
            if (!tieneBotonInforme) {
                // Agregar bot√≥n de ver informe despu√©s del bot√≥n de editar
                const botonEditar = celdaAcciones.querySelector('.btn-editar');
                if (botonEditar) {
                    const botonInforme = document.createElement('button');
                    botonInforme.className = 'btn-icon btn-ver-informe';
                    botonInforme.title = 'Ver informe de baja';
                    botonInforme.innerHTML = 'üìÑ';
                    botonInforme.setAttribute('onclick', `verInformeBaja(${libroId})`);
                    
                    botonEditar.insertAdjacentElement('afterend', botonInforme);
                }
            }
            
            // QUITAR cualquier bot√≥n de reactivar existente
            const botonReactivar = celdaAcciones.querySelector('.btn-reactivar');
            if (botonReactivar) {
                botonReactivar.remove();
            }
        }
    });
}

// ===== FUNCI√ìN PRINCIPAL PARA IMPRIMIR LIBRO (SISTEMA DE OBLEAS) =====
function imprimirLibro(libroId) {
    try {
        // Buscar la fila del libro por el bot√≥n de imprimir
        const botonImprimir = document.querySelector(`button[onclick*="imprimirLibro(${libroId})"]`);
        if (!botonImprimir) {
            console.error('No se encontr√≥ el bot√≥n de imprimir para el libro ID:', libroId);
            alert('Error: No se pudo encontrar la informaci√≥n del libro');
            return;
        }
        
        const filaLibro = botonImprimir.closest('tr');
        if (!filaLibro) {
            console.error('No se encontr√≥ la fila del libro');
            alert('Error: No se pudo encontrar la informaci√≥n del libro');
            return;
        }
        
        const celdas = filaLibro.querySelectorAll('td');
        
        // Validar que tenemos suficientes celdas
        if (celdas.length < 7) {
            console.error('Estructura de tabla inesperada');
            alert('Error: Estructura de datos incorrecta');
            return;
        }
        
        // Extraer datos del libro
        const libroData = {
            id: libroId,
            numInventario: celdas[0].textContent.trim(),
            titulo: celdas[1].textContent.trim(),
            autor: celdas[2].textContent.trim(),
            editorial: celdas[3].textContent.trim(),
            cdu: celdas[4].textContent.trim(),
            siglas: celdas[5].textContent.trim(),
            sede: celdas[6].textContent.trim()
        };
        
        // Validar que tenemos los datos m√≠nimos necesarios
        if (!libroData.titulo) {
            alert('Error: El libro no tiene t√≠tulo v√°lido');
            return;
        }
        
        // Agregar oblea al sistema
        sistemaObleas.agregarOblea(libroData);
        
        console.log('Oblea agregada correctamente:', libroData);
        
    } catch (error) {
        console.error('Error al procesar la impresi√≥n del libro:', error);
        alert('Error inesperado al procesar la oblea. Verifique la consola para m√°s detalles.');
    }
}

// ===== FUNCIONES AUXILIARES =====

// Funci√≥n para manejar errores de carga de im√°genes
function handleImageError(img) {
    img.src = 'https://via.placeholder.com/50x70/95a5a6/ffffff?text=Sin+Imagen';
    img.onerror = null; // Prevenir bucle infinito
}

// Funci√≥n para formatear texto para obleas
function formatearTextoOblea(texto, maxLength = 12) {
    if (!texto) return 'N/A';
    
    texto = texto.toString().trim().toUpperCase();
    
    if (texto.length <= maxLength) {
        return texto;
    }
    
    // Intentar cortar por palabras
    const palabras = texto.split(' ');
    let resultado = '';
    
    for (const palabra of palabras) {
        if ((resultado + ' ' + palabra).length <= maxLength) {
            resultado += (resultado ? ' ' : '') + palabra;
        } else {
            break;
        }
    }
    
    return resultado || texto.substring(0, maxLength);
}

// Funci√≥n para validar datos de libro antes de crear oblea
function validarDatosLibro(libroData) {
    const errores = [];
    
    if (!libroData.titulo || libroData.titulo.trim() === '') {
        errores.push('T√≠tulo requerido');
    }
    
    if (!libroData.cdu || libroData.cdu.trim() === '') {
        libroData.cdu = 'SIN CDU';
    }
    
    if (!libroData.siglas || libroData.siglas.trim() === '') {
        libroData.siglas = libroData.titulo ? 
            formatearTextoOblea(libroData.titulo, 8) : 'ABC';
    }
    
    return {
        valido: errores.length === 0,
        errores: errores,
        datos: libroData
    };
}

// ===== CONFIGURACI√ìN GLOBAL =====

// Configurar comportamiento global de modales
document.addEventListener('shown.bs.modal', function (e) {
    // Enfocar primer input al abrir modal
    const firstInput = e.target.querySelector('input:not([type="hidden"]), textarea');
    if (firstInput) {
        firstInput.focus();
    }
});

// Prevenir cierre accidental de modal con obleas
document.addEventListener('hide.bs.modal', function (e) {
    if (e.target.id === 'obleasModal' && sistemaObleas && sistemaObleas.obleas.length > 0) {
        if (!confirm('Tiene obleas sin imprimir. ¬øEst√° seguro de cerrar?')) {
            e.preventDefault();
        }
    }
});

// Mostrar conteo de obleas en t√≠tulo de p√°gina cuando hay obleas
function actualizarTituloConObleas() {
    const tituloOriginal = 'Modificaci√≥n de Materiales | Biblioteca Digital';
    const cantidadObleas = sistemaObleas ? sistemaObleas.obleas.length : 0;
    
    if (cantidadObleas > 0) {
        document.title = `(${cantidadObleas}) ${tituloOriginal}`;
    } else {
        document.title = tituloOriginal;
    }
}

// Llamar la funci√≥n peri√≥dicamente para mantener actualizado el t√≠tulo
setInterval(actualizarTituloConObleas, 1000);

// ===== ATAJOS DE TECLADO =====
document.addEventListener('keydown', function(e) {
    // Ctrl + P para abrir modal de obleas si hay obleas
    if (e.ctrlKey && e.key === 'p' && sistemaObleas && sistemaObleas.obleas.length > 0) {
        e.preventDefault();
        sistemaObleas.mostrarModal();
    }
    
    // Escape para cerrar cualquier modal abierto
    if (e.key === 'Escape') {
        const modalAbierto = document.querySelector('.modal.show');
        if (modalAbierto) {
            const modal = bootstrap.Modal.getInstance(modalAbierto);
            if (modal) modal.hide();
        }
    }
});

// ===== SISTEMA DE GESTI√ìN DE LIBROS DADOS DE BAJA =====

// Variable para almacenar el libro actual en proceso
let libroActualParaAlta = null;

// Funci√≥n para aplicar estilos a filas de libros no disponibles
function aplicarEstilosLibrosNoDisponibles() {
    const rows = document.querySelectorAll('.libro-row');
    rows.forEach(row => {
        const estado = row.dataset.estado;
        if (estado === 'no disponible') {
            row.classList.add('libro-no-disponible');
        } else {
            row.classList.remove('libro-no-disponible');
        }
    });
}

// Funci√≥n para ver informe de baja
// REEMPLAZAR LA PARTE DE OBTENER INFORME EN TU JAVASCRIPT CON ESTO:

// FUNCI√ìN ACTUALIZADA para verInformeBaja
function verInformeBaja(libroId) {
    try {
        // Buscar la fila del libro
        const botonInforme = document.querySelector(`button[onclick*="verInformeBaja(${libroId})"]`);
        if (!botonInforme) {
            console.error('No se encontr√≥ el bot√≥n de informe para el libro ID:', libroId);
            alert('Error: No se pudo encontrar la informaci√≥n del libro');
            return;
        }
        
        const filaLibro = botonInforme.closest('tr');
        const celdas = filaLibro.querySelectorAll('td');
        
        // Extraer datos b√°sicos del libro
        const datosLibro = {
            id: libroId,
            numInventario: celdas[0].textContent.trim(),
            titulo: celdas[1].textContent.trim(),
            autor: celdas[2].textContent.trim(),
            editorial: celdas[3].textContent.trim(),
            cdu: celdas[4].textContent.trim(),
            siglas: celdas[5].textContent.trim(),
            sede: celdas[6].textContent.trim()
        };
        
        // Obtener imagen del libro de la tabla
        const imagenElement = filaLibro.querySelector('.libro-thumbnail');
        const imagenSrc = imagenElement ? imagenElement.src : '';
        
        // Llenar datos b√°sicos en el modal
        document.getElementById('informe_num_inventario').textContent = datosLibro.numInventario || '-';
        document.getElementById('informe_titulo').textContent = datosLibro.titulo;
        document.getElementById('informe_autor').textContent = datosLibro.autor || 'Sin autor';
        document.getElementById('informe_cdu').textContent = datosLibro.cdu || '-';
        document.getElementById('informe_siglas').textContent = datosLibro.siglas || '-';
        
        // Manejar imagen del libro
        const imagenModal = document.getElementById('informe_imagen');
        const placeholderModal = document.getElementById('informe_placeholder');
        
        if (imagenSrc && !imagenSrc.includes('placeholder')) {
            imagenModal.src = imagenSrc;
            imagenModal.style.display = 'block';
            placeholderModal.style.display = 'none';
        } else {
            imagenModal.style.display = 'none';
            placeholderModal.style.display = 'flex';
        }
        
        // Guardar datos para dar de alta
        libroActualParaAlta = datosLibro;
        
        // INICIALIZAR con valores por defecto mientras carga
        document.getElementById('informe_fecha_baja').textContent = '30/10/2024';
        document.getElementById('informe_motivo').textContent = 'Cargando motivo...';
        
        // Ocultar imagen de baja inicialmente
        const imagenBajaContainer = document.getElementById('imagen_baja_container');
        imagenBajaContainer.style.display = 'none';
        
        // Mostrar el modal INMEDIATAMENTE
        const modal = new bootstrap.Modal(document.getElementById('verInformeModal'));
        modal.show();
        
        // Obtener datos REALES del informe en segundo plano
        const formData = new FormData();
        formData.append('libro_id', libroId);
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        console.log('üîç Obteniendo informe para libro ID:', libroId);
        
        fetch('/obtener-informe-baja/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            console.log('üì° Respuesta recibida:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üìã Datos del informe:', data);
            
            if (data.success) {
                const informe = data.informe;
                
                // Actualizar con datos REALES de la base de datos
                document.getElementById('informe_fecha_baja').textContent = informe.fecha_baja || '30/10/2024';
                document.getElementById('informe_motivo').textContent = informe.motivo || 'Motivo no registrado';
                
                // MANEJAR IMAGEN DE LA BAJA REAL
                console.log('üñºÔ∏è URL de imagen de baja:', informe.imagen_baja);
                
                if (informe.imagen_baja && informe.imagen_baja.trim() !== '') {
                    console.log('‚úÖ Mostrando imagen de baja');
                    
                    const imagenBaja = document.getElementById('imagen_baja');
                    imagenBaja.src = informe.imagen_baja;
                    imagenBaja.onload = function() {
                        console.log('üñºÔ∏è Imagen cargada correctamente');
                        imagenBajaContainer.style.display = 'block';
                    };
                    imagenBaja.onerror = function() {
                        console.error('‚ùå Error al cargar imagen de baja');
                        imagenBajaContainer.style.display = 'none';
                    };
                } else {
                    console.log('‚ùå No hay imagen de baja disponible');
                    imagenBajaContainer.style.display = 'none';
                }
            } else {
                console.error('‚ùå Error en respuesta:', data.error);
                document.getElementById('informe_motivo').textContent = 'Error al cargar motivo de baja';
            }
        })
        .catch(error => {
            console.error('‚ùå Error al obtener informe:', error);
            document.getElementById('informe_motivo').textContent = 'Error de conexi√≥n al obtener motivo';
        });
        
        console.log('‚úÖ Informe mostrado para libro:', datosLibro);
        
    } catch (error) {
        console.error('‚ùå Error al mostrar informe de baja:', error);
        alert('Error inesperado al cargar el informe. Verifique la consola para m√°s detalles.');
    }
}

// Funci√≥n para iniciar proceso de dar de alta
function iniciarDarDeAlta() {
    if (!libroActualParaAlta) {
        alert('Error: No se encontraron datos del libro');
        return;
    }
    
    // Cerrar modal de informe
    const modalInforme = bootstrap.Modal.getInstance(document.getElementById('verInformeModal'));
    if (modalInforme) {
        modalInforme.hide();
    }
    
    // Llenar datos en modal de confirmaci√≥n
    document.getElementById('confirm_titulo_libro').textContent = libroActualParaAlta.titulo;
    
    // Mostrar modal de confirmaci√≥n
    setTimeout(() => {
        const modal = new bootstrap.Modal(document.getElementById('confirmarAltaModal'));
        modal.show();
    }, 300);
}

// Funci√≥n para proceder con modificaci√≥n de datos
function procederConModificacion() {
    if (!libroActualParaAlta) {
        alert('Error: No se encontraron datos del libro');
        return;
    }
    
    // Cerrar modal de confirmaci√≥n
    const modalConfirm = bootstrap.Modal.getInstance(document.getElementById('confirmarAltaModal'));
    if (modalConfirm) {
        modalConfirm.hide();
    }
    
    // Llenar datos en modal de modificaci√≥n
    document.getElementById('alta_libro_id').value = libroActualParaAlta.id;
    document.getElementById('alta_sede').value = libroActualParaAlta.sede || 'LA PLATA';
    document.getElementById('alta_disponibilidad').value = 'Disponible';
    document.getElementById('alta_observaciones').value = '';
    
    // Mostrar modal de modificaci√≥n
    setTimeout(() => {
        const modal = new bootstrap.Modal(document.getElementById('modificarDatosModal'));
        modal.show();
    }, 300);
}

// Funci√≥n para procesar dar de alta (simulada)
// Funci√≥n para procesar dar de alta (con AJAX real)
function procesarDarDeAlta(event) {
    event.preventDefault();
    
    if (!libroActualParaAlta) {
        alert('Error: No se encontraron datos del libro');
        return;
    }
    
    // Obtener datos del formulario
    const formData = new FormData();
    formData.append('libro_id', libroActualParaAlta.id);
    formData.append('sede', document.getElementById('alta_sede').value);
    formData.append('disponibilidad', document.getElementById('alta_disponibilidad').value);
    formData.append('observaciones', document.getElementById('alta_observaciones').value);
    
    // Obtener token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    // Cerrar modal de modificaci√≥n
    const modalModificar = bootstrap.Modal.getInstance(document.getElementById('modificarDatosModal'));
    if (modalModificar) {
        modalModificar.hide();
    }
    
    // Mostrar loading
    mostrarNotificacionAlta('Procesando dar de alta...', 'info');
    
    // Hacer llamada AJAX
    fetch('/dar-alta-libro/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Mostrar modal de √©xito
            document.getElementById('exito_titulo').textContent = libroActualParaAlta.titulo.substring(0, 20) + '...';
            const modal = new bootstrap.Modal(document.getElementById('exitoModal'));
            modal.show();
            
            // Actualizar la fila en la tabla
            actualizarFilaTabla(libroActualParaAlta.id, data.nuevo_estado);
            
            // Mostrar notificaci√≥n de √©xito
            mostrarNotificacionAlta(`‚úÖ ${data.message}`, 'success');
            
        } else {
            // Mostrar error
            alert(`Error: ${data.error}`);
            mostrarNotificacionAlta(`‚ùå Error: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexi√≥n. Int√©ntalo nuevamente.');
        mostrarNotificacionAlta('‚ùå Error de conexi√≥n', 'error');
    })
    .finally(() => {
        // Limpiar variable
        libroActualParaAlta = null;
    });
}

// NUEVA FUNCI√ìN PARA ACTUALIZAR LA FILA EN LA TABLA
function actualizarFilaTabla(libroId, nuevoEstado) {
    const filaLibro = document.querySelector(`button[onclick*="verInformeBaja(${libroId})"]`).closest('tr');
    if (!filaLibro) return;
    
    // Remover clase de no disponible
    filaLibro.classList.remove('libro-no-disponible');
    filaLibro.dataset.estado = 'disponible';
    
    // Actualizar celda de disponibilidad
    const celdaDisponibilidad = filaLibro.querySelector('.disponibilidad-cell');
    celdaDisponibilidad.innerHTML = '<span class="disponible">Disponible para pr√©stamo</span>';
    
    // Actualizar botones de acciones
    const celdaAcciones = filaLibro.querySelector('.acciones-cell');
    
    // Remover botones de informe y reactivar
    const botonInforme = celdaAcciones.querySelector(`button[onclick*="verInformeBaja(${libroId})"]`);
    const botonReactivar = celdaAcciones.querySelector(`button[onclick*="reactivarLibro(${libroId})"]`);
    
    if (botonInforme) botonInforme.remove();
    if (botonReactivar) botonReactivar.remove();
    
    // Encontrar el t√≠tulo del libro para el bot√≥n
    const titulo = filaLibro.querySelector('.titulo-cell').textContent;
    
    // Agregar bot√≥n de dar de baja normal
    const nuevoBotonBaja = document.createElement('button');
    nuevoBotonBaja.className = 'btn-icon btn-eliminar';
    nuevoBotonBaja.title = 'Dar de baja';
    nuevoBotonBaja.innerHTML = 'üóëÔ∏è';
    nuevoBotonBaja.onclick = function() {
        darDeBaja(libroId, titulo);
    };
    
    celdaAcciones.appendChild(nuevoBotonBaja);
}

// AGREGAR FUNCI√ìN PARA OBTENER INFORME REAL (OPCIONAL)
function obtenerInformeReal(libroId) {
    const formData = new FormData();
    formData.append('libro_id', libroId);
    
    // Obtener token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    return fetch('/obtener-informe-baja/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            return data.informe;
        } else {
            throw new Error(data.error);
        }
    });
}

// MODIFICAR LA FUNCI√ìN verInformeBaja PARA USAR DATOS REALES (OPCIONAL)
function verInformeBajaConDatosReales(libroId) {
    try {
        // Primero obtener datos b√°sicos del libro de la tabla
        const botonInforme = document.querySelector(`button[onclick*="verInformeBaja(${libroId})"]`);
        if (!botonInforme) {
            console.error('No se encontr√≥ el bot√≥n de informe para el libro ID:', libroId);
            alert('Error: No se pudo encontrar la informaci√≥n del libro');
            return;
        }
        
        const filaLibro = botonInforme.closest('tr');
        const celdas = filaLibro.querySelectorAll('td');
        
        const datosLibro = {
            id: libroId,
            numInventario: celdas[0].textContent.trim(),
            titulo: celdas[1].textContent.trim(),
            autor: celdas[2].textContent.trim(),
            editorial: celdas[3].textContent.trim(),
            cdu: celdas[4].textContent.trim(),
            siglas: celdas[5].textContent.trim(),
            sede: celdas[6].textContent.trim()
        };
        
        // Obtener imagen del libro
        const imagenElement = filaLibro.querySelector('.libro-thumbnail');
        const imagenSrc = imagenElement ? imagenElement.src : '';
        
        // Llenar datos b√°sicos en el modal
        document.getElementById('informe_num_inventario').textContent = datosLibro.numInventario || '-';
        document.getElementById('informe_titulo').textContent = datosLibro.titulo;
        document.getElementById('informe_autor').textContent = datosLibro.autor || 'Sin autor';
        document.getElementById('informe_cdu').textContent = datosLibro.cdu || '-';
        document.getElementById('informe_siglas').textContent = datosLibro.siglas || '-';
        
        // Manejar imagen del libro
        const imagenModal = document.getElementById('informe_imagen');
        const placeholderModal = document.getElementById('informe_placeholder');
        
        if (imagenSrc && !imagenSrc.includes('placeholder')) {
            imagenModal.src = imagenSrc;
            imagenModal.style.display = 'block';
            placeholderModal.style.display = 'none';
        } else {
            imagenModal.style.display = 'none';
            placeholderModal.style.display = 'flex';
        }
        
        // Guardar datos para dar de alta
        libroActualParaAlta = datosLibro;
        
        // Mostrar el modal
        const modal = new bootstrap.Modal(document.getElementById('verInformeModal'));
        modal.show();
        
        // Obtener datos reales del informe en segundo plano
        obtenerInformeReal(libroId)
            .then(informe => {
                // Actualizar con datos reales
                document.getElementById('informe_fecha_baja').textContent = informe.fecha_baja || '30/10/2024';
                document.getElementById('informe_motivo').textContent = informe.motivo || 'Motivo no registrado';
                
                // Manejar imagen de la baja
                const imagenBajaContainer = document.getElementById('imagen_baja_container');
                const imagenBaja = document.getElementById('imagen_baja');
                
                if (informe.imagen_baja) {
                    imagenBaja.src = informe.imagen_baja;
                    imagenBajaContainer.style.display = 'block';
                } else {
                    imagenBajaContainer.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error al obtener informe:', error);
                // Mantener datos por defecto
            });
        
        console.log('Informe mostrado para libro:', datosLibro);
        
    } catch (error) {
        console.error('Error al mostrar informe de baja:', error);
        alert('Error inesperado al cargar el informe. Verifique la consola para m√°s detalles.');
    }
}

// Funci√≥n para mostrar notificaci√≥n de dar de alta
function mostrarNotificacionAlta(mensaje, tipo = 'success') {
    const colores = {
        success: '#28a745',
        warning: '#ffc107',
        info: '#17a2b8',
        error: '#dc3545'
    };
    
    const notificacion = document.createElement('div');
    notificacion.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colores[tipo]};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        animation: slideInRight 0.3s ease;
    `;
    notificacion.textContent = mensaje;
    
    document.body.appendChild(notificacion);
    
    setTimeout(() => {
        notificacion.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => notificacion.remove(), 300);
    }, 3000);
}

// Event listeners para los modales
document.addEventListener('DOMContentLoaded', function() {
    // Aplicar estilos iniciales
    aplicarEstilosLibrosNoDisponibles();
    
    // Event listener para bot√≥n "DAR DE ALTA" en modal de informe
    const btnDarDeAlta = document.getElementById('btnDarDeAlta');
    if (btnDarDeAlta) {
        btnDarDeAlta.addEventListener('click', iniciarDarDeAlta);
    }
    
    // Event listener para bot√≥n "CONFIRMAR" en modal de confirmaci√≥n
    const btnConfirmarAlta = document.getElementById('confirmarDarAlta');
    if (btnConfirmarAlta) {
        btnConfirmarAlta.addEventListener('click', procederConModificacion);
    }
    
    // Event listener para formulario de dar de alta
    const formDarAlta = document.getElementById('formDarAlta');
    if (formDarAlta) {
        formDarAlta.addEventListener('submit', procesarDarDeAlta);
    }
    
    // Aplicar estilos despu√©s de filtrar
    const originalFiltrarLibros = window.filtrarLibros;
    if (originalFiltrarLibros) {
        window.filtrarLibros = function() {
            originalFiltrarLibros();
            aplicarEstilosLibrosNoDisponibles();
        };
    }
});

// Funci√≥n para actualizar botones de acciones seg√∫n el estado
function actualizarBotonesAcciones() {
    const rows = document.querySelectorAll('.libro-row');
    rows.forEach(row => {
        const estado = row.dataset.estado;
        const celdaAcciones = row.querySelector('.acciones-cell');
        const libroId = row.querySelector('.btn-icon').getAttribute('onclick').match(/\d+/)[0];
        const titulo = row.dataset.titulo;
        
        if (estado === 'no disponible') {
            // Verificar si ya tiene el bot√≥n de ver informe
            const tieneBotonInforme = celdaAcciones.querySelector(`button[onclick*="verInformeBaja"]`);
            if (!tieneBotonInforme) {
                // Agregar bot√≥n de ver informe despu√©s del bot√≥n de editar
                const botonEditar = celdaAcciones.querySelector('.btn-editar');
                if (botonEditar) {
                    const botonInforme = document.createElement('button');
                    botonInforme.className = 'btn-icon btn-ver-informe';
                    botonInforme.title = 'Ver informe de baja';
                    botonInforme.innerHTML = 'üìÑ';
                    botonInforme.setAttribute('onclick', `verInformeBaja(${libroId})`);
                    
                    botonEditar.insertAdjacentElement('afterend', botonInforme);
                }
            }
        }
    });
}

// Sobrescribir la funci√≥n de filtrado para incluir los estilos
const originalFiltrarLibros = window.filtrarLibros;
if (typeof filtrarLibros === 'function') {
    window.filtrarLibros = function() {
        originalFiltrarLibros();
        aplicarEstilosLibrosNoDisponibles();
        actualizarBotonesAcciones();
    };
}

// Inicializar todo al cargar
setTimeout(() => {
    aplicarEstilosLibrosNoDisponibles();
    actualizarBotonesAcciones();
}, 100);

console.log('‚úÖ Sistema de obleas inicializado correctamente');
</script>
{% endblock %}