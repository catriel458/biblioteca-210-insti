{% load static %}

<div data-block="content" data-form="mapa">
    <div class="row mb-3">
        <div class="col-md-3">
            <label for="sede-mapa" style="font-size: 14px;">Sede: <span style="color: red;">*</span></label>
            <select class="form-control form-control-sm" id="sede-mapa" name="sede_mapa" required>
                <option value="">Seleccione una sede</option>
                <option value="sede1">La Plata</option>
                <option value="sede2">Abasto</option>
            </select>
        </div>

        <div class="col-md-3">
            <label for="input-nuevo-tipo-mapa" style="font-size: 14px;">Tipo de Mapa: <span style="color: red;">*</span></label>
            <select class="form-control form-control-sm" id="input-nuevo-tipo-mapa" name="input-nuevo-tipo-mapa" required>
                <option value="">Seleccione un tipo</option>
                <option value="FISICO">FISICO</option>
                <option value="FISICO-POLITICO">FISICO-POLITICO</option>
                <option value="POLITICO">POLITICO</option>
                <option value="OTROS">OTROS</option>
            </select>
        </div>
        
        <div class="col-md-3">
            <label for="input-nueva-cant-mapa" style="font-size: 14px;">Cantidad <span class="text-danger">*</span></label>
            <input type="number" class="form-control form-control-sm" id="input-nueva-cant-mapa" name="input-nueva-cant-mapa" min="1" value="1" data-valor-anterior="1" required>
        </div>
    </div>
    
    <!-- Campo oculto para enviar los datos de grupos de tipos -->
    <input type="hidden" id="gruposTiposMapa" name="gruposTiposMapa" value="">
    
    <!-- Contenedor din√°mico para tipo y cantidad -->
    <div class="row mb-3">
        <div class="col-4" id="bloque-tipo-cantidad"></div>
    </div>

    <!-- Contenedor para los ejemplares -->
    <div id="contenedor-ejemplares-mapa" class="mb-4">
        <!-- Los ejemplares se generar√°n aqu√≠ din√°micamente -->
    </div>
    
    <!-- Botones -->
    <div class="row botones-container">
        <div class="col-12 d-flex justify-content-end gap-3">
            <button type="reset" class="btn btn-outline-danger btn-sm">CANCELAR</button>
            <button type="submit" class="btn btn-primary btn-sm" formaction="{% url 'confirmar_alta_mapa' %}" formmethod="post" onclick="prepararEnvioFormulario()">GUARDAR</button>
        </div>
    </div>
</div>

<style>
/* Asegurar que los botones no queden ocultos detr√°s del footer */
.content {
    padding-bottom: 100px !important;
}

/* Estilo espec√≠fico para el contenedor de botones del formulario de mapas */
[data-form="mapa"] .row:last-of-type {
    margin-bottom: 120px !important;
    padding-bottom: 20px;
}

/* Asegurar que el contenedor de ejemplares tenga espacio suficiente */
#contenedor-ejemplares-mapa {
    margin-bottom: 20px;
}
</style>

<!-- Importaci√≥n del JS din√°mico de ejemplares -->
<script src="{% static 'js/form_altas.js' %}"></script>

<script>
    // Inicializar gruposTiposMapa si no existe
    if (!window.gruposTiposMapa) {
        window.gruposTiposMapa = [];
    }
    
    // Funci√≥n para preparar el env√≠o del formulario
    function prepararEnvioFormulario() {
        // Serializar los datos de gruposTiposMapa
        const gruposTiposMapaInput = document.getElementById('gruposTiposMapa');
        if (gruposTiposMapaInput && window.gruposTiposMapa) {
            gruposTiposMapaInput.value = JSON.stringify(window.gruposTiposMapa);
        }
        
        // Agregar campos ocultos para cada tipo de grupo
        window.gruposTiposMapa.forEach((grupo, idx) => {
            const tipoInput = document.createElement('input');
            tipoInput.type = 'hidden';
            tipoInput.name = `tipo_grupo_${idx}`;
            tipoInput.value = grupo.tipo;
            document.querySelector('[data-form="mapa"]').appendChild(tipoInput);
        });
        
        console.log('üì§ Datos preparados para env√≠o:', {
            gruposTiposMapa: window.gruposTiposMapa,
            sede: document.getElementById('sede-mapa').value
        });
    }
    
    // Agregar event listener al formulario principal cuando se carga el DOM
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('form_alta_material');
        if (form) {
            form.addEventListener('submit', function(e) {
                // Solo interceptar si es el formulario de mapas
                const tipoMaterial = document.getElementById('tipo_material');
                if (tipoMaterial && tipoMaterial.value === 'mapa') {
                    console.log('üó∫Ô∏è Interceptando env√≠o del formulario de mapas...');
                    prepararEnvioFormulario();
                }
            });
        }
    });
    
    // Llamar a la funci√≥n de renderizado
    window.renderizarTiposMapa();
    
    // Actualizar el input de sede cuando se seleccione un tipo de mapa
    document.getElementById('input-nuevo-tipo-mapa').addEventListener('change', function() {
        const sedeInput = document.getElementById('sede-mapa');
        const tipoSeleccionado = this.value;
        if (tipoSeleccionado) {
            sedeInput.value = tipoSeleccionado;
            
            // Agregar autom√°ticamente el tipo seleccionado a gruposTiposMapa
            const cantidadInput = document.getElementById('input-nueva-cant-mapa');
            const cantidad = parseInt(cantidadInput.value) || 1;
            
            // Limpiar tipos anteriores y agregar el nuevo
            window.gruposTiposMapa = [];
            window.gruposTiposMapa.push({ tipo: tipoSeleccionado, cantidad: cantidad });
            
            // Renderizar los tipos
            window.renderizarTiposMapa();
            
            console.log('üó∫Ô∏è Tipo de mapa agregado:', { tipo: tipoSeleccionado, cantidad: cantidad });
        } else {
            sedeInput.value = '';
            window.gruposTiposMapa = [];
            window.renderizarTiposMapa();
        }
    });

    // Manejar reducci√≥n en la cantidad est√°tica con modal
    (function() {
        const cantidadMapaInput = document.getElementById('input-nueva-cant-mapa');
        if (!cantidadMapaInput) return;
        const inicial = parseInt(cantidadMapaInput.getAttribute('data-valor-anterior') || cantidadMapaInput.value || '1', 10);
        cantidadMapaInput.setAttribute('data-valor-anterior', String(inicial));

        function manejarReduccionCantidadMapa() {
            const prev = parseInt(cantidadMapaInput.getAttribute('data-valor-anterior') || '1', 10);
            const nuevo = parseInt(cantidadMapaInput.value || '1', 10);
            const aplicar = function() {
                cantidadMapaInput.setAttribute('data-valor-anterior', String(nuevo));
                if (Array.isArray(window.gruposTiposMapa) && window.gruposTiposMapa.length > 0) {
                    window.gruposTiposMapa[0].cantidad = nuevo;
                    if (typeof window.renderizarTiposMapa === 'function') {
                        window.renderizarTiposMapa();
                    }
                }
            };
            if (nuevo < prev) {
                if (typeof mostrarModalReducirEjemplares === 'function') {
                    mostrarModalReducirEjemplares(aplicar, function() { cantidadMapaInput.value = String(prev); });
                } else {
                    if (confirm('Reducir la cantidad eliminar√° datos de ejemplares adicionales. ¬øConfirmar?')) {
                        aplicar();
                    } else {
                        cantidadMapaInput.value = String(prev);
                    }
                }
            } else {
                aplicar();
            }
        }
        cantidadMapaInput.addEventListener('input', manejarReduccionCantidadMapa);
        cantidadMapaInput.addEventListener('change', manejarReduccionCantidadMapa);
    })();
</script>