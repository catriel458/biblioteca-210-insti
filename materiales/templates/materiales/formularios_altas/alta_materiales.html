{% extends 'components/baseb.html' %}
{% load static %}
{% block extra_styles %}
    <link rel="stylesheet" href="{% static 'css/header.css' %}">
    <link rel="stylesheet" href="{% static 'css/manual_modal.css' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="{% static 'css/style_form.css' %}">
    <link rel="stylesheet" href="{% static 'css/botones.css' %}">
{% endblock %}

{% block content %}
<header class="header-pantalla">
    <div class="header-pantalla">
        <h1 class="header-title" style="padding-top: 15px;">ALTA MATERIAL</h1>
        <a href="{% url 'home' %}" class="logo-link">
            <img src="{% static 'imagenes/Logo_inicio.png' %}" alt="Logo" class="cover-pic">
        </a>
    </div>
</header>
<div class="container-fluid">
    <form id="form_alta_material" action="{% url 'alta_libro' %}" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="row align-items-start">
            <div class="col-12 col-lg-10">
                <div class="row">
                    <div class="col-12 col-sm-6 col-lg-2 form-group mb-2">
                        <label for="tipo_material" class="text-input" style="color:#25898D;">Tipo de Material:</label>
                        <select class="form-control form-control-sm" id="tipo_material" name="tipo_material" required>
                            <option value="">Selecciona un tipo de material</option>
                            <option value="libro">LIBRO</option>
                            <option value="programa">PROGRAMA</option>
                            <option value="mapa">MAPA</option>
                            <option value="multimedia">MULTIMEDIA</option>
                            <option value="notebook">NOTEBOOK</option>
                            <option value="proyector">PROYECTOR</option>
                            <option value="varios">VARIOS</option>
                        </select>
                    </div>
                    <div class="col-12 col-lg-8 mb-2"></div>
                </div>
                <!-- Aqu√≠ se cargar√° din√°micamente el formulario -->
                <div id="formulario-especifico" class="mt-2 row"></div>
            </div>
            
            <!-- Columna derecha con manual y carga masiva -->
            <div class="col-12 col-lg-2 d-flex flex-column align-items-end mt-3 mt-lg-0">
                <div class="w-100 mb-2">
                    <button type="button" class="btn btn-dark btn-sm manual-button w-100" onclick="document.getElementById('manualModal').style.display='flex'">MANUAL</button>
                </div>
                
                <!-- Secci√≥n de carga masiva (solo visible al seleccionar material) -->
                <div id="upload_simple_container" class="w-100 mb-4" style="display: none;">
                    <div class="upload-box w-100">
                        <small class="text-muted">Para carga masiva, suba un archivo CSV o Excel (.csv, .xls, .xlsx):</small>
                        <label for="cargar_archivo" class="d-block my-3">
                            <div class="boton-redondeado">
                                <span>‚Üë</span>
                            </div>
                            <input type="file" id="cargar_archivo" name="cargar_archivo" accept=".csv, .xls, .xlsx" style="display: none;">
                        </label>
                        <div id="nombre_archivo_carga_simple" style="text-align:center;font-size:0.92em;color:#444;margin-top:6px;margin-bottom:2px;word-break:break-all;"></div>
                    </div>
                </div>
                
                <!-- Fila 4/5: Carga de Imagen -->
                <div id="upload_box_container" class="custom-upload-box-container" style="display: none; width: 100%;">
                    <div class="custom-upload-box w-100">
                        <button class="btn btn-sm custom-upload-btn w-100" type="button" onclick="document.getElementById('file_upload_input').click();">‚Üë</button>
                        <input type="file" id="file_upload_input" name="imagen" accept="image/*" style="display: none;">
                        <input type="text" id="url_upload_input" class="form-control custom-upload-input mb-2" placeholder="O pegue un enlace de imagen aqu√≠...">
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones -->
        <div id="buttons-container" class="row bg-white px-0 mx-0" style="border:none; box-shadow:none; display: none;">
            <div class="col-12 d-flex justify-content-end gap-5">
              <!-- Los botones se cargan din√°micamente con cada formulario espec√≠fico -->
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block modals %}
  {% include 'modals/manual_modal.html' %}
  <!-- Solo incluir el modal de confirmaci√≥n para materiales que no tienen su propio modal -->
  <div id="contenedor-modal-confirmacion">
   
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
// Script para el template principal (paste-2.txt - segundo template)
document.addEventListener("DOMContentLoaded", function () {
    const tipoMaterial = document.getElementById('tipo_material');
    const formularioEspecifico = document.getElementById('formulario-especifico');
    const buttonsContainer = document.getElementById('buttons-container');
    
    // Elementos de carga masiva e imagen
    const uploadSimple = document.getElementById('upload_simple_container');
    const uploadBox = document.getElementById('upload_box_container');

    // FUNCIONALIDAD PRINCIPAL
    tipoMaterial.addEventListener('change', function () {
        const tipo = this.value;
        console.log('üî• Tipo seleccionado:', tipo);
        
        if (tipo === '') {
            formularioEspecifico.innerHTML = '';
            buttonsContainer.style.display = 'none';
            if (uploadSimple) uploadSimple.style.display = 'none';
            if (uploadBox) uploadBox.style.display = 'none';
            return;
        }
        
        if (tipo === 'libro') {
            console.log('üìö Cargando formulario de libro...');
            fetch('/formulario/libro/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    
                    // üî• IMPORTANTE: Establecer el action correcto para libro
                    const form = document.getElementById('form_alta_material');
                    if (form) {
                        form.action = '/alta-libro/';
                        console.log('üîß Action del formulario libro establecido a:', form.action);
                    }
                    
                    // Mostrar el modal de confirmaci√≥n gen√©rico para libro
                    const contenedorModal = document.getElementById('contenedor-modal-confirmacion');
                    if (contenedorModal) {
                        contenedorModal.style.display = 'block';
                        console.log('üîß Modal de confirmaci√≥n gen√©rico mostrado para libro');
                    }
                    
                    // Solo mostrar carga masiva y URL para libros
                    if (uploadSimple) uploadSimple.style.display = 'block';
                    if (uploadBox) uploadBox.style.display = 'block';
                    
                    // üéØ CR√çTICO: Inicializar funcionalidad din√°mica DESPU√âS de cargar HTML
                    setTimeout(() => {
                        // Inicializar ejemplares din√°micos para libros
                        const cantidadInput = document.querySelector('input[name="cant_ejemplares"]');
                        if (cantidadInput) {
                            // Generar ejemplares iniciales
                            window.updateRowsMaterial('libro');
                            
                            // Agregar event listener para cambios en cantidad
                            cantidadInput.addEventListener('input', function() {
                                console.log('üîÑ Cantidad de ejemplares cambiada:', this.value);
                                window.updateRowsMaterial('libro');
                            });
                            
                            console.log('‚úÖ Funcionalidad din√°mica de libros inicializada');
                        } else {
                            console.warn('‚ö†Ô∏è Input de cantidad de ejemplares no encontrado');
                        }
                    }, 100); // Peque√±o delay para asegurar que el DOM est√© listo
                    
                    console.log('‚úÖ Formulario de libro cargado');
                })
                .catch(error => {
                    console.error('‚ùå Error cargando libro:', error);
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else if (tipo === 'programa') {
            console.log('üéì Cargando formulario de programa...');
            fetch('/formulario/programa/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    
                    // üî• IMPORTANTE: Corregir el action despu√©s de cargar
                    const form = document.getElementById('form_alta_material');
                    if (form) {
                        form.action = '/alta-programa/';
                        console.log('üîß Action del formulario programa corregido a:', form.action);
                    }
                    
                    // üéØ CR√çTICO: Inicializar funcionalidad carrera-materia DESPU√âS de cargar HTML
                    setTimeout(() => {
                        initCarreraMateriaFunctionality();
                    }, 100); // Peque√±o delay para asegurar que el DOM est√© listo
                    
                    // No mostrar carga masiva ni URL para programas
                    if (uploadSimple) uploadSimple.style.display = 'none';
                    if (uploadBox) uploadBox.style.display = 'none';
                    console.log('‚úÖ Formulario de programa cargado');
                })
                .catch(error => {
                    console.error('‚ùå Error cargando programa:', error);
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        // ... resto de casos (mapa, multimedia, etc.)
        else if (tipo === 'mapa') {
            console.log('üó∫Ô∏è Cargando formulario de mapa...');
            fetch('/formulario/mapa/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    
                    // üî• IMPORTANTE: Establecer el action correcto para mapa
                    const form = document.getElementById('form_alta_material');
                    if (form) {
                        form.action = '/confirmar-alta-mapa/';
                        console.log('üîß Action del formulario mapa establecido a:', form.action);
                    }
                    
                    // üéØ CR√çTICO: Inicializar funcionalidad de mapas DESPU√âS de cargar HTML
                    setTimeout(() => {
                        // Inicializar arrays globales y renderizar tipos de mapa
                        if (typeof window.gruposTiposMapa === 'undefined') {
                            window.gruposTiposMapa = [];
                        }
                        if (typeof window.renderizarTiposMapa === 'function') {
                            window.renderizarTiposMapa();
                        }
                    }, 100); // Peque√±o delay para asegurar que el DOM est√© listo
                    
                    // No mostrar carga masiva ni URL para mapas
                    if (uploadSimple) uploadSimple.style.display = 'none';
                    if (uploadBox) uploadBox.style.display = 'none';
                    console.log('‚úÖ Formulario de mapa cargado');
                })
                .catch(error => {
                    console.error('‚ùå Error cargando mapa:', error);
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else if (tipo === 'multimedia') {
            console.log('üíø Cargando formulario de multimedia...');
            fetch('/formulario/multimedia/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    
                    // üî• IMPORTANTE: Establecer el action correcto para multimedia
                    const form = document.getElementById('form_alta_material');
                    if (form) {
                        form.action = '/alta-multimedia/';
                        console.log('üîß Action del formulario multimedia establecido a:', form.action);
                    }
                    
                    // Ocultar el modal de confirmaci√≥n gen√©rico ya que multimedia tiene su propio modal
                    const contenedorModal = document.getElementById('contenedor-modal-confirmacion');
                    if (contenedorModal) {
                        contenedorModal.style.display = 'none';
                        console.log('üîß Modal de confirmaci√≥n gen√©rico ocultado para multimedia');
                    }
                    
                    // üéØ CR√çTICO: Inicializar funcionalidad carrera-materia DESPU√âS de cargar HTML
                    setTimeout(() => {
                        initCarreraMateriaFunctionality();
                        initMultimediaFunctionality(); // Inicializar funcionalidad del bot√≥n '+'
                    }, 100); // Peque√±o delay para asegurar que el DOM est√© listo
                    
                    // No mostrar carga masiva ni URL para multimedia
                    if (uploadSimple) uploadSimple.style.display = 'none';
                    if (uploadBox) uploadBox.style.display = 'none';
                    console.log('‚úÖ Formulario de multimedia cargado');
                })
                .catch(error => {
                    console.error('‚ùå Error cargando multimedia:', error);
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else if (tipo === 'notebook') {
            console.log('üíª Cargando formulario de notebook...');
            fetch('/formulario/notebook/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    
                    // üî• IMPORTANTE: Establecer el action correcto para notebook
                    const form = document.getElementById('form_alta_material');
                    if (form) {
                        form.action = '{% url "confirmacion_alta_notebook" %}';
                        console.log('üîß Action del formulario notebook establecido a:', form.action);
                    }
                    
                    // Ocultar el modal de confirmaci√≥n gen√©rico ya que notebook tiene su propio modal
                    const contenedorModal = document.getElementById('contenedor-modal-confirmacion');
                    if (contenedorModal) {
                        contenedorModal.style.display = 'none';
                        console.log('üîß Modal de confirmaci√≥n gen√©rico ocultado para notebook');
                    }
                    
                    // No mostrar carga masiva ni URL para notebook
                    if (uploadSimple) uploadSimple.style.display = 'none';
                    if (uploadBox) uploadBox.style.display = 'none';
                    
                    // üéØ CR√çTICO: Inicializar funcionalidad din√°mica DESPU√âS de cargar HTML
                    setTimeout(() => {
                        initNotebookDynamicFunctionality();
                    }, 100); // Peque√±o delay para asegurar que el DOM est√© listo
                    
                    console.log('‚úÖ Formulario de notebook cargado');
                })
                .catch(error => {
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else if (tipo === 'proyector') {
            console.log('üìΩÔ∏è Cargando formulario de proyector...');
            fetch('/formulario/proyector/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    // No mostrar carga masiva ni URL para proyector
                    if (uploadSimple) uploadSimple.style.display = 'none';
                    if (uploadBox) uploadBox.style.display = 'none';
                    
                    // Configurar la acci√≥n del formulario para proyector
                    const form = document.getElementById('form_alta_material');
                    if (form) {
                        form.action = '{% url "confirmacion_alta_proyector" %}';
                        console.log('‚úÖ Acci√≥n del formulario configurada para proyector:', form.action);
                    }
                    
                    // üéØ CR√çTICO: Inicializar funcionalidad din√°mica DESPU√âS de cargar HTML
                    setTimeout(() => {
                        initProyectorDynamicFunctionality();
                    }, 100); // Peque√±o delay para asegurar que el DOM est√© listo
                    
                    console.log('‚úÖ Formulario de proyector cargado');
                })
                .catch(error => {
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else if (tipo === 'varios') {
            console.log('üì¶ Cargando formulario de varios...');
            fetch('/formulario/varios/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    // No mostrar carga masiva ni URL para varios
                    if (uploadSimple) uploadSimple.style.display = 'none';
                    if (uploadBox) uploadBox.style.display = 'none';
                    
                    // üéØ CR√çTICO: Inicializar funcionalidad carrera-materia DESPU√âS de cargar HTML
                    setTimeout(() => {
                        initCarreraMateriaFunctionality();
                        initVariosFunctionality(); // Inicializar funcionalidad del bot√≥n '+' para varios
                    }, 100); // Peque√±o delay para asegurar que el DOM est√© listo
                    
                    // Configurar la acci√≥n del formulario para varios
                    const form = document.getElementById('form_alta_material');
                    if (form) {
                        form.action = '{% url "confirmacion_alta_varios" %}';
                        console.log('‚úÖ Acci√≥n del formulario configurada para varios:', form.action);
                    }
                    console.log('‚úÖ Formulario de varios cargado');
                })
                .catch(error => {
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else {
            console.log('‚ùå Sin selecci√≥n o tipo no reconocido');
            formularioEspecifico.innerHTML = '';
            buttonsContainer.style.display = 'none';
            if (uploadSimple) uploadSimple.style.display = 'none';
            if (uploadBox) uploadBox.style.display = 'none';
        }
    });

// Funci√≥n para inicializar la funcionalidad din√°mica del proyector
function initProyectorDynamicFunctionality() {
    console.log('üéØ Inicializando funcionalidad din√°mica del proyector...');
    
    const cantEjemplaresProyector = document.getElementById('cant_ejemplares');
    const contenedorEjemplaresProyector = document.getElementById('contenedor-ejemplares-proyector');
    
    if (cantEjemplaresProyector && contenedorEjemplaresProyector) {
        console.log('‚úÖ Elementos encontrados para proyector...');
        
        // Funci√≥n para generar campos din√°micos id√©nticos a notebook
        function generarCamposProyector() {
            const cantidad = parseInt(cantEjemplaresProyector.value) || 1;
            let html = '';
            
            for (let i = 1; i <= cantidad; i++) {
                html += `
                <!-- L√≠nea punteada -->
                <div style="
                    background: repeating-linear-gradient(
                        to right,
                        #8B1D69 0px,
                        #8B1D69 10px,
                        transparent 10px,
                        transparent 30px
                    );
                    height: 3px;
                    margin: 25px 0;
                    width: 100%;
                "></div>
                <div class="row mb-2">
                    <div class="col-md-3">
                        <label for="num_registro_${i}" style="font-size: 14px;">N¬∞ de registro<span style="color: #dc3545; font-weight: bold;">*</span>:</label>
                        <input type="text" class="form-control" id="num_registro_${i}" name="num_registro_${i}" required placeholder="N¬∞ de registro...">
                    </div>
                    <div class="col-md-3">
                        <label for="modelo_proy_${i}" style="font-size: 14px;">Modelo:</label>
                        <input type="text" class="form-control" id="modelo_proy_${i}" name="modelo_proy_${i}" placeholder="Modelo..." />
                    </div>
                </div>`;
            }
            contenedorEjemplaresProyector.innerHTML = html;
        }
        
        // Event listeners para cambios din√°micos
        cantEjemplaresProyector.addEventListener('input', generarCamposProyector);
        cantEjemplaresProyector.addEventListener('change', generarCamposProyector);
        
        // Generar campos iniciales
        generarCamposProyector();
        
        console.log('‚úÖ Funcionalidad din√°mica del proyector inicializada correctamente');
    } else {
        console.error('‚ùå No se encontraron los elementos necesarios para la funcionalidad din√°mica');
        console.log('cantEjemplaresProyector:', cantEjemplaresProyector);
        console.log('contenedorEjemplaresProyector:', contenedorEjemplaresProyector);
    }
}

// Funci√≥n para inicializar la funcionalidad din√°mica del notebook
function initNotebookDynamicFunctionality() {
    console.log('üíª Inicializando funcionalidad din√°mica del notebook...');
    
    const cantEjemplaresNotebook = document.getElementById('cant_ejemplares');
    const contenedorEjemplaresNotebook = document.getElementById('contenedor-ejemplares-notebook');
    
    if (cantEjemplaresNotebook && contenedorEjemplaresNotebook) {
        console.log('‚úÖ Elementos encontrados, configurando eventos...');
        
        // Event listener para cambios din√°micos
        cantEjemplaresNotebook.addEventListener('input', function() {
            console.log('üîÑ Input event triggered, cantidad:', this.value);
            window.updateRowsMaterial('notebook');
        });
        
        cantEjemplaresNotebook.addEventListener('change', function() {
            console.log('üîÑ Change event triggered, cantidad:', this.value);
            window.updateRowsMaterial('notebook');
        });
        
        // Llamar inicialmente para generar campos si ya hay un valor
        if (cantEjemplaresNotebook.value && cantEjemplaresNotebook.value > 0) {
            console.log('üîÑ Generando campos iniciales para cantidad:', cantEjemplaresNotebook.value);
            window.updateRowsMaterial('notebook');
        }
        
        console.log('‚úÖ Funcionalidad din√°mica del notebook inicializada correctamente');
    } else {
        console.error('‚ùå No se encontraron los elementos necesarios para la funcionalidad din√°mica del notebook');
        console.log('cantEjemplaresNotebook:', cantEjemplaresNotebook);
        console.log('contenedorEjemplaresNotebook:', contenedorEjemplaresNotebook);
    }
}

// FUNCIONALIDAD AGREGADA: Mostrar nombre del archivo seleccionado
    const cargarArchivo = document.getElementById('cargar_archivo');
    const nombreArchivo = document.getElementById('nombre_archivo_carga_simple');
    
    if (cargarArchivo && nombreArchivo) {
        cargarArchivo.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                nombreArchivo.textContent = this.files[0].name;
            } else {
                nombreArchivo.textContent = '';
            }
        });
    }

    // üéØ FUNCI√ìN PARA INICIALIZAR CARRERA-MATERIA (para programa y multimedia)
    function initCarreraMateriaFunctionality() {
        // Buscar elementos por ambos posibles IDs (para compatibilidad con diferentes formularios)
        const carreraSelect = document.getElementById('id_carrera') || document.getElementById('carrera');
        const materiaSelect = document.getElementById('id_materia') || document.getElementById('materia');
        
        console.log('üéØ Inicializando carrera-materia...', !!carreraSelect, !!materiaSelect);
        
        if (!carreraSelect || !materiaSelect) {
            console.log('‚ö†Ô∏è Elementos carrera-materia no encontrados');
            return;
        }
        
        // Materias por carrera - ID√âNTICO al primer archivo
        const materiasPorCarrera = {
            'Profesorado de Educaci√≥n Inicial': [
                'Pedagog√≠a', 'Psicolog√≠a Educacional', 'Sociolog√≠a de la Educaci√≥n', 
                'Historia y Pol√≠tica de la Educaci√≥n Argentina', 'Filosof√≠a de la Educaci√≥n',
                'Did√°ctica General', 'Curriculum y Did√°ctica del Nivel Inicial', 
                'Juego y Desarrollo Infantil', 'Literatura Infantil', 'Matem√°tica y su Did√°ctica',
                'Ciencias Sociales y su Did√°ctica', 'Ciencias Naturales y su Did√°ctica',
                'Lengua y su Did√°ctica', 'Educaci√≥n Art√≠stica', 'Educaci√≥n F√≠sica',
                'Pr√°ctica Docente I', 'Pr√°ctica Docente II', 'Pr√°ctica Docente III', 'Pr√°ctica Docente IV'
            ],
            'Profesorado de Educaci√≥n Primaria': [
                'Pedagog√≠a', 'Psicolog√≠a Educacional', 'Sociolog√≠a de la Educaci√≥n',
                'Historia y Pol√≠tica de la Educaci√≥n Argentina', 'Filosof√≠a de la Educaci√≥n',
                'Did√°ctica General', 'Curriculum y Did√°ctica del Nivel Primario',
                'Matem√°tica y su Did√°ctica I', 'Matem√°tica y su Did√°ctica II',
                'Lengua y su Did√°ctica I', 'Lengua y su Did√°ctica II',
                'Ciencias Sociales y su Did√°ctica I', 'Ciencias Sociales y su Did√°ctica II',
                'Ciencias Naturales y su Did√°ctica I', 'Ciencias Naturales y su Did√°ctica II',
                'Educaci√≥n Art√≠stica', 'Educaci√≥n F√≠sica', 'Tecnolog√≠as de la Informaci√≥n',
                'Pr√°ctica Docente I', 'Pr√°ctica Docente II', 'Pr√°ctica Docente III', 'Pr√°ctica Docente IV'
            ],
            'Profesorado de Educaci√≥n Secundaria en Geograf√≠a': [
                'Pedagog√≠a', 'Psicolog√≠a Educacional', 'Sociolog√≠a de la Educaci√≥n',
                'Historia y Pol√≠tica de la Educaci√≥n Argentina', 'Filosof√≠a de la Educaci√≥n',
                'Did√°ctica General', 'Did√°ctica de la Geograf√≠a',
                'Geograf√≠a F√≠sica I', 'Geograf√≠a F√≠sica II', 'Geograf√≠a Humana I', 'Geograf√≠a Humana II',
                'Geograf√≠a de Am√©rica', 'Geograf√≠a de Argentina', 'Geograf√≠a Mundial',
                'Cartograf√≠a', 'Climatolog√≠a', 'Geomorfolog√≠a', 'Biogeograf√≠a',
                'Geograf√≠a Econ√≥mica', 'Geograf√≠a Urbana y Rural', 'Epistemolog√≠a de la Geograf√≠a',
                'Pr√°ctica Docente I', 'Pr√°ctica Docente II', 'Pr√°ctica Docente III', 'Pr√°ctica Docente IV'
            ],
            'Profesorado de Educaci√≥n Secundaria en Ciencias Pol√≠ticas': [
                'Pedagog√≠a', 'Psicolog√≠a Educacional', 'Sociolog√≠a de la Educaci√≥n',
                'Historia y Pol√≠tica de la Educaci√≥n Argentina', 'Filosof√≠a de la Educaci√≥n',
                'Did√°ctica General', 'Did√°ctica de las Ciencias Pol√≠ticas',
                'Teor√≠a Pol√≠tica', 'Historia del Pensamiento Pol√≠tico', 'Sistemas Pol√≠ticos Comparados',
                'Pol√≠tica Argentina', 'Pol√≠tica Latinoamericana', 'Relaciones Internacionales',
                'Derecho Constitucional', 'Sociolog√≠a Pol√≠tica', 'Econom√≠a Pol√≠tica',
                'Filosof√≠a Pol√≠tica', 'Metodolog√≠a de la Investigaci√≥n Social',
                'Pr√°ctica Docente I', 'Pr√°ctica Docente II', 'Pr√°ctica Docente III', 'Pr√°ctica Docente IV'
            ],
            'Tecnicatura Superior en An√°lisis de Sistemas': [
                'Matem√°tica', 'Ingl√©s T√©cnico', 'Arquitectura de Computadoras',
                'Sistemas Operativos', 'Algoritmos y Estructuras de Datos',
                'Programaci√≥n I', 'Programaci√≥n II', 'Programaci√≥n III',
                'Base de Datos I', 'Base de Datos II', 'An√°lisis de Sistemas I', 'An√°lisis de Sistemas II',
                'Ingenier√≠a de Software', 'Redes y Comunicaciones', 'Seguridad Inform√°tica',
                'Desarrollo Web', 'Programaci√≥n Orientada a Objetos', 'Metodolog√≠as de Desarrollo',
                'Gesti√≥n de Proyectos', 'Pr√°ctica Profesionalizante I', 'Pr√°ctica Profesionalizante II'
            ],
            'Tecnicatura en Enfermer√≠a': [
                'Anatom√≠a y Fisiolog√≠a I', 'Anatom√≠a y Fisiolog√≠a II', 'Microbiolog√≠a y Parasitolog√≠a',
                'Farmacolog√≠a', 'Patolog√≠a', 'Nutrici√≥n y Dietoterapia',
                'Enfermer√≠a B√°sica', 'Enfermer√≠a M√©dica', 'Enfermer√≠a Quir√∫rgica',
                'Enfermer√≠a Materno Infantil', 'Enfermer√≠a Pedi√°trica', 'Enfermer√≠a Geri√°trica',
                'Enfermer√≠a en Salud Mental', 'Enfermer√≠a Comunitaria', 'Administraci√≥n en Enfermer√≠a',
                'Bio√©tica', 'Epidemiolog√≠a', 'Primeros Auxilios',
                'Pr√°ctica Profesional I', 'Pr√°ctica Profesional II', 'Pr√°ctica Profesional III'
            ],
            'Tecnicatura en Acompa√±amiento Terap√©utico': [
                'Psicolog√≠a General', 'Psicopatolog√≠a', 'Neurociencias', 'Desarrollo Humano',
                'Teor√≠as y T√©cnicas de Acompa√±amiento Terap√©utico', 'Comunicaci√≥n Terap√©utica',
                'Din√°micas Familiares', 'Integraci√≥n Social', 'Recreaci√≥n Terap√©utica',
                'Talleres de Expresi√≥n', 'Primeros Auxilios', 'Bio√©tica',
                'Legislaci√≥n en Salud Mental', 'Trabajo Interdisciplinario',
                'Pr√°ctica Profesional I', 'Pr√°ctica Profesional II', 'Pr√°ctica Profesional III'
            ],
            'Tecnicatura Superior en Higiene y Seguridad en el Trabajo': [
                'Matem√°tica', 'F√≠sica', 'Qu√≠mica', 'Legislaci√≥n Laboral',
                'Higiene Industrial I', 'Higiene Industrial II', 'Seguridad Industrial I', 'Seguridad Industrial II',
                'Medicina del Trabajo', 'Toxicolog√≠a Laboral', 'Ergonom√≠a',
                'Protecci√≥n contra Incendios', 'Contaminaci√≥n Ambiental', 'Gesti√≥n de Residuos',
                'Capacitaci√≥n en Seguridad', 'Investigaci√≥n de Accidentes', 'Auditor√≠as de Seguridad',
                'Gesti√≥n de Riesgos', 'Pr√°ctica Profesional I', 'Pr√°ctica Profesional II'
            ]
        };
        
        // Funci√≥n para cargar materias seg√∫n la carrera seleccionada
        function cargarMaterias(carreraSeleccionada) {
            console.log('üìö Carrera seleccionada:', carreraSeleccionada);
            
            // Limpiar opciones de materia
            materiaSelect.innerHTML = '';
            
            if (carreraSeleccionada && materiasPorCarrera[carreraSeleccionada]) {
                // Agregar opci√≥n vac√≠a
                const opcionVacia = document.createElement('option');
                opcionVacia.value = '';
                opcionVacia.textContent = 'Seleccione una materia';
                materiaSelect.appendChild(opcionVacia);
                
                // Agregar materias de la carrera seleccionada
                materiasPorCarrera[carreraSeleccionada].forEach(function(materia) {
                    const option = document.createElement('option');
                    option.value = materia;
                    option.textContent = materia;
                    materiaSelect.appendChild(option);
                });
                
                materiaSelect.disabled = false;
                console.log('‚úÖ Materias cargadas:', materiasPorCarrera[carreraSeleccionada].length);
            } else {
                // No hay carrera seleccionada o no tiene materias
                const opcionVacia = document.createElement('option');
                opcionVacia.value = '';
                opcionVacia.textContent = 'Primero seleccione una carrera';
                materiaSelect.appendChild(opcionVacia);
                materiaSelect.disabled = true;
                console.log('‚ö†Ô∏è No hay materias para:', carreraSeleccionada);
            }
        }
        
        // Event listener para cambio de carrera
        carreraSelect.addEventListener('change', function() {
            cargarMaterias(this.value);
        });
        
        // Inicializar estado de materia
        materiaSelect.disabled = true;
        
        // Si ya hay una carrera seleccionada al cargar (por ejemplo, por validaci√≥n de errores)
        if (carreraSelect.value) {
            cargarMaterias(carreraSelect.value);
        }
        function cargarMaterias(carreraSeleccionada) {
            console.log('üìö Carrera seleccionada:', carreraSeleccionada);
            
            // Limpiar opciones de materia
            materiaSelect.innerHTML = '';
            
            if (carreraSeleccionada && materiasPorCarrera[carreraSeleccionada]) {
                // Agregar opci√≥n vac√≠a
                const opcionVacia = document.createElement('option');
                opcionVacia.value = '';
                opcionVacia.textContent = 'Seleccione una materia';
                materiaSelect.appendChild(opcionVacia);
                
                // Agregar materias de la carrera seleccionada
                materiasPorCarrera[carreraSeleccionada].forEach(function(materia) {
                    const option = document.createElement('option');
                    option.value = materia;
                    option.textContent = materia;
                    materiaSelect.appendChild(option);
                });
                
                materiaSelect.disabled = false;
                console.log('‚úÖ Materias cargadas:', materiasPorCarrera[carreraSeleccionada].length);
            } else {
                // No hay carrera seleccionada o no tiene materias
                const opcionVacia = document.createElement('option');
                opcionVacia.value = '';
                opcionVacia.textContent = 'Primero seleccione una carrera';
                materiaSelect.appendChild(opcionVacia);
                materiaSelect.disabled = true;
                console.log('‚ö†Ô∏è No hay materias para:', carreraSeleccionada);
            }
        }
        
        // Event listener para cambio de carrera
        carreraSelect.addEventListener('change', function() {
            cargarMaterias(this.value);
        });
        
        // Inicializar estado de materia
        materiaSelect.disabled = true;
        
        // Si ya hay una carrera seleccionada al cargar
        if (carreraSelect.value) {
            cargarMaterias(carreraSelect.value);
        }
        
        console.log('‚úÖ Funcionalidad carrera-materia inicializada correctamente');
    }

    // üéØ FUNCI√ìN PARA INICIALIZAR FUNCIONALIDAD MULTIMEDIA
    function initMultimediaFunctionality() {
        console.log('üöÄ Inicializando funcionalidad multimedia...');
        
        // Inicializar gruposTiposMultimedia si no existe
        if (!window.gruposTiposMultimedia) {
            window.gruposTiposMultimedia = [];
        }
        
        // Event listener para el bot√≥n de agregar multimedia
        const btnAgregarMultimedia = document.getElementById('btn-agregar-multimedia');
        console.log('üîç Bot√≥n encontrado:', btnAgregarMultimedia);
        
        if (btnAgregarMultimedia) {
            // Remover event listeners previos para evitar duplicados
            btnAgregarMultimedia.replaceWith(btnAgregarMultimedia.cloneNode(true));
            const newBtn = document.getElementById('btn-agregar-multimedia');
            
            newBtn.addEventListener('click', function() {
                console.log('‚ûï Bot√≥n clickeado, ejecutando agregarNuevoMultimedia()');
                agregarNuevoMultimedia();
            });
            console.log('‚úÖ Event listener agregado correctamente al bot√≥n +');
        } else {
            console.error('‚ùå No se encontr√≥ el bot√≥n btn-agregar-multimedia');
        }
    }

    // üéØ FUNCI√ìN PARA AGREGAR NUEVO GRUPO DE MULTIMEDIA
    function agregarNuevoMultimedia() {
        console.log('üîÑ Ejecutando agregarNuevoMultimedia()');
        const contenedor = document.getElementById('contenedor-tipos-multimedia');
        console.log('üì¶ Contenedor encontrado:', contenedor);
        
        if (!contenedor) {
            console.error('‚ùå No se encontr√≥ el contenedor contenedor-tipos-multimedia');
            return;
        }
        
        const index = window.gruposTiposMultimedia.length;
        console.log('üî¢ √çndice actual:', index);
        
        // Crear nuevo grupo
        const nuevoGrupo = {
            url: '',
            titulo: ''
        };
        
        window.gruposTiposMultimedia.push(nuevoGrupo);
        
        // Crear HTML para el nuevo grupo con la estructura exacta especificada
        const grupoHTML = `
            <div class="grupo-multimedia mb-3" data-index="${index}">
                <div class="row">
                    <div class="col-md-2">
                        <label for="ingresar_enlace_${index}" style="font-size: 14px;">Ingresar enlace (URL)</label>
                        <div class="input-group">
                            <input type="url" class="form-control form-control-sm" 
                                   id="ingresar_enlace_${index}" 
                                   name="ingresar_enlace_${index}" 
                                   placeholder="URL del contenido multimedia">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label for="titulo_contenido_${index}" style="font-size: 14px;">Titulo del contenido <span class="text-danger">*</span></label>
                        <input type="text" class="form-control form-control-sm" 
                               id="titulo_contenido_${index}" 
                               name="titulo_contenido_${index}" 
                               required>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="boton-eliminar" 
                                onclick="eliminarMultimedia(${index})" 
                                title="Eliminar este contenido multimedia">√ó</button>
                    </div>
                </div>
            </div>
        `;
        
        contenedor.insertAdjacentHTML('beforeend', grupoHTML);
        console.log('‚úÖ Nuevo grupo agregado exitosamente');
    }

    // üéØ FUNCI√ìN PARA ELIMINAR MULTIMEDIA
    function eliminarMultimedia(index) {
        console.log('üóëÔ∏è Eliminando multimedia con √≠ndice:', index);
        
        // Eliminar del array
        window.gruposTiposMultimedia.splice(index, 1);
        
        // Eliminar del DOM
        const grupo = document.querySelector(`[data-index="${index}"]`);
        if (grupo) {
            grupo.remove();
        }
        
        // Actualizar √≠ndices
        actualizarIndicesMultimedia();
        console.log('‚úÖ Multimedia eliminado y √≠ndices actualizados');
    }

    // üéØ FUNCI√ìN PARA ACTUALIZAR √çNDICES
    function actualizarIndicesMultimedia() {
        const grupos = document.querySelectorAll('.grupo-multimedia');
        grupos.forEach((grupo, nuevoIndex) => {
            grupo.setAttribute('data-index', nuevoIndex);
            
            // Actualizar IDs y names de los inputs
            const inputUrl = grupo.querySelector('input[type="url"]');
            const inputTitulo = grupo.querySelector('input[type="text"]');
            const labelUrl = grupo.querySelector('label[for*="ingresar_enlace"]');
            const labelTitulo = grupo.querySelector('label[for*="titulo_contenido"]');
            
            if (inputUrl) {
                inputUrl.id = `ingresar_enlace_${nuevoIndex}`;
                inputUrl.name = `ingresar_enlace_${nuevoIndex}`;
            }
            if (inputTitulo) {
                inputTitulo.id = `titulo_contenido_${nuevoIndex}`;
                inputTitulo.name = `titulo_contenido_${nuevoIndex}`;
            }
            if (labelUrl) {
                labelUrl.setAttribute('for', `ingresar_enlace_${nuevoIndex}`);
            }
            if (labelTitulo) {
                labelTitulo.setAttribute('for', `titulo_contenido_${nuevoIndex}`);
            }
            
            // Actualizar el bot√≥n de eliminar
            const btnEliminar = grupo.querySelector('button');
            if (btnEliminar) {
                btnEliminar.setAttribute('onclick', `eliminarMultimedia(${nuevoIndex})`);
            }
        });
    }

    // Hacer las funciones globales para que puedan ser llamadas desde onclick
    window.eliminarMultimedia = eliminarMultimedia;
    window.actualizarIndicesMultimedia = actualizarIndicesMultimedia;

    // üéØ FUNCI√ìN PARA INICIALIZAR FUNCIONALIDAD VARIOS
    function initVariosFunctionality() {
        console.log('üöÄ Inicializando funcionalidad varios...');
        
        // Inicializar gruposTiposVarios si no existe
        if (!window.gruposTiposVarios) {
            window.gruposTiposVarios = [];
        }
        
        // Event listener para el bot√≥n de agregar varios
        const btnAgregarVarios = document.getElementById('btn-agregar-varios');
        console.log('üîç Bot√≥n encontrado:', btnAgregarVarios);
        
        if (btnAgregarVarios) {
            // Remover event listeners previos para evitar duplicados
            btnAgregarVarios.replaceWith(btnAgregarVarios.cloneNode(true));
            const newBtn = document.getElementById('btn-agregar-varios');
            
            newBtn.addEventListener('click', function() {
                console.log('‚ûï Bot√≥n clickeado, ejecutando agregarNuevoVarios()');
                agregarNuevoVarios();
            });
            console.log('‚úÖ Event listener agregado correctamente al bot√≥n +');
        } else {
            console.error('‚ùå No se encontr√≥ el bot√≥n btn-agregar-varios');
        }
    }

    // üéØ FUNCI√ìN PARA AGREGAR NUEVO GRUPO DE VARIOS
    function agregarNuevoVarios() {
        console.log('üîÑ Ejecutando agregarNuevoVarios()');
        const contenedor = document.getElementById('contenedor-tipos-varios-dinamicos');
        console.log('üì¶ Contenedor encontrado:', contenedor);
        
        if (!contenedor) {
            console.error('‚ùå No se encontr√≥ el contenedor contenedor-tipos-varios-dinamicos');
            return;
        }
        
        const index = window.gruposTiposVarios.length;
        console.log('üî¢ √çndice actual:', index);
        
        // Crear nuevo grupo
        const nuevoGrupo = {
            tipo: '',
            cantidad: 1
        };
        
        window.gruposTiposVarios.push(nuevoGrupo);
        
        // Crear HTML para el nuevo grupo con la estructura exacta especificada
        const grupoHTML = `
            <div class="grupo-varios mb-3" data-index="${index}">
                <div class="row">
                    <div class="col-md-3">
                        <label for="tipo_varios_${index}" style="font-size: 14px;">Tipo a registrar <span class="text-danger">*</span></label>
                        <input type="text" class="form-control form-control-sm" 
                               id="tipo_varios_${index}" 
                               name="tipo_varios_${index}" 
                               required>
                    </div>
                    <div class="col-md-3">
                        <label for="cant_ejemplares_${index}" style="font-size: 14px;">Cant. de ejemplares <span class="text-danger">*</span></label>
                        <input type="number" class="form-control form-control-sm" 
                               id="cant_ejemplares_${index}" 
                               name="cant_ejemplares_${index}" 
                               min="1" 
                               value="1" 
                               required>
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                         <button type="button" class="boton-eliminar" 
                                 onclick="eliminarVarios(${index})" 
                                 title="Eliminar este tipo de material">√ó</button>
                     </div>
                </div>
            </div>
        `;
        
        contenedor.insertAdjacentHTML('beforeend', grupoHTML);
        console.log('‚úÖ Nuevo grupo agregado exitosamente');
    }

    // üéØ FUNCI√ìN PARA ELIMINAR VARIOS
    function eliminarVarios(index) {
        console.log('üóëÔ∏è Eliminando varios con √≠ndice:', index);
        
        // Eliminar del array
        window.gruposTiposVarios.splice(index, 1);
        
        // Eliminar del DOM
        const grupo = document.querySelector(`[data-index="${index}"]`);
        if (grupo) {
            grupo.remove();
        }
        
        // Actualizar √≠ndices
        actualizarIndicesVarios();
        console.log('‚úÖ Varios eliminado y √≠ndices actualizados');
    }

    // üéØ FUNCI√ìN PARA ACTUALIZAR √çNDICES
    function actualizarIndicesVarios() {
        const grupos = document.querySelectorAll('.grupo-varios');
        grupos.forEach((grupo, nuevoIndex) => {
            grupo.setAttribute('data-index', nuevoIndex);
            
            // Actualizar IDs y names de los inputs
            const inputTipo = grupo.querySelector('input[type="text"]');
            const inputCantidad = grupo.querySelector('input[type="number"]');
            const labelTipo = grupo.querySelector('label[for*="tipo_varios"]');
            const labelCantidad = grupo.querySelector('label[for*="cant_ejemplares"]');
            
            if (inputTipo) {
                inputTipo.id = `tipo_varios_${nuevoIndex}`;
                inputTipo.name = `tipo_varios_${nuevoIndex}`;
            }
            if (inputCantidad) {
                inputCantidad.id = `cant_ejemplares_${nuevoIndex}`;
                inputCantidad.name = `cant_ejemplares_${nuevoIndex}`;
            }
            if (labelTipo) {
                labelTipo.setAttribute('for', `tipo_varios_${nuevoIndex}`);
            }
            if (labelCantidad) {
                labelCantidad.setAttribute('for', `cant_ejemplares_${nuevoIndex}`);
            }
            
            // Actualizar el bot√≥n de eliminar
            const btnEliminar = grupo.querySelector('button');
            if (btnEliminar) {
                btnEliminar.setAttribute('onclick', `eliminarVarios(${nuevoIndex})`);
            }
        });
    }

    // Hacer las funciones globales para que puedan ser llamadas desde onclick
    window.eliminarVarios = eliminarVarios;
    window.actualizarIndicesVarios = actualizarIndicesVarios;
});

// ===== FUNCIONES GLOBALES PARA PREPARAR ENV√çO DE FORMULARIOS =====

// Funci√≥n global para preparar env√≠o de formulario de mapas
window.prepararEnvioFormulario = function() {
    const tipoMaterial = document.getElementById('tipo_material').value;
    
    if (tipoMaterial === 'mapa') {
        // Serializar los datos de gruposTiposMapa
        const gruposTiposMapaInput = document.getElementById('gruposTiposMapa');
        if (gruposTiposMapaInput && window.gruposTiposMapa) {
            gruposTiposMapaInput.value = JSON.stringify(window.gruposTiposMapa);
        }
        
        // Agregar campos ocultos para cada tipo de grupo
        if (window.gruposTiposMapa) {
            window.gruposTiposMapa.forEach((grupo, idx) => {
                const tipoInput = document.createElement('input');
                tipoInput.type = 'hidden';
                tipoInput.name = `tipo_grupo_${idx}`;
                tipoInput.value = grupo.tipo;
                document.getElementById('form_alta_material').appendChild(tipoInput);
            });
        }
        
        console.log('üì§ Datos de mapa preparados para env√≠o:', {
            gruposTiposMapa: window.gruposTiposMapa,
            sede: document.getElementById('sede-mapa')?.value
        });
    }
    else if (tipoMaterial === 'multimedia') {
        // Recopilar datos de multimedia de los inputs
        const multimediaData = [];
        let index = 0;
        
        // Buscar todos los grupos de multimedia
        while (true) {
            const urlInput = document.getElementById(`url_contenido_${index}`);
            const tituloInput = document.getElementById(`titulo_contenido_${index}`);
            
            if (!urlInput || !tituloInput) break;
            
            if (urlInput.value.trim() && tituloInput.value.trim()) {
                multimediaData.push({
                    url: urlInput.value.trim(),
                    titulo: tituloInput.value.trim()
                });
            }
            index++;
        }
        
        // Actualizar window.gruposTiposMultimedia
        window.gruposTiposMultimedia = multimediaData;
        
        // Serializar en el input hidden
        const gruposMultimediaInput = document.getElementById('gruposMultimedia');
        if (gruposMultimediaInput) {
            gruposMultimediaInput.value = JSON.stringify(multimediaData);
        }
        
        console.log('üì§ Datos de multimedia preparados para env√≠o:', {
            gruposTiposMultimedia: multimediaData
        });
    }
    else if (tipoMaterial === 'varios') {
        // Filtrar solo elementos din√°micos (excluir el primer elemento que es del formulario est√°tico)
        const elementosDinamicos = window.gruposTiposVariosNuevo && window.gruposTiposVariosNuevo.length > 1 
            ? window.gruposTiposVariosNuevo.slice(1) 
            : [];
        
        // Serializar los datos de elementos din√°micos √∫nicamente
        const gruposTiposVariosInput = document.getElementById('gruposTiposVariosNuevo');
        if (gruposTiposVariosInput) {
            gruposTiposVariosInput.value = JSON.stringify(elementosDinamicos);
        }
        
        // Agregar campos ocultos para cada tipo de grupo din√°mico
        if (elementosDinamicos.length > 0) {
            elementosDinamicos.forEach((grupo, idx) => {
                const tipoInput = document.createElement('input');
                tipoInput.type = 'hidden';
                tipoInput.name = `tipo_grupo_${idx}`;
                tipoInput.value = grupo.tipo;
                document.getElementById('form_alta_material').appendChild(tipoInput);
            });
        }
        
        console.log('üì§ Datos de varios preparados para env√≠o:', {
            gruposTiposVariosNuevo: elementosDinamicos,
            sede: document.getElementById('sede-varios')?.value
        });
    }
};
</script>

<!-- Scripts necesarios para funcionalidad de formularios din√°micos -->
<script src="{% static 'js/form_altas.js' %}"></script>
<!-- <script src="{% static 'js/confirmacion_alta_material.js' %}"></script> -->
{% endblock %}