{% extends 'components/baseb.html' %}
{% load static %}
{% block extra_styles %}
    <link rel="stylesheet" href="{% static 'css/manual_modal.css' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="{% static 'css/style_form.css' %}">
    <link rel="stylesheet" href="{% static 'css/botones.css' %}">
    <link rel="stylesheet" href="{% static 'css/confirmacion_carga_exitosa.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <form id="form_alta_material" action="{% url 'alta_libro' %}" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="row align-items-start">
            <div class="col-12 col-lg-10">
                <div class="row">
                    <div class="col-12 col-sm-6 col-lg-2 form-group mb-2">
                        <label for="tipo_material" class="text-input" style="color:#25898D;">Tipo de Material:</label>
                        <select class="form-control form-control-sm" id="tipo_material" name="tipo_material" required>
                            <option value="">Selecciona un tipo de material</option>
                            <option value="libro">LIBRO</option>
                            <option value="programa">PROGRAMA</option>
                            <option value="mapa">MAPA</option>
                            <option value="multimedia">MULTIMEDIA</option>
                            <option value="notebook">NOTEBOOK</option>
                            <option value="proyector">PROYECTOR</option>
                            <option value="varios">VARIOS</option>
                        </select>
                    </div>
                    <div class="col-12 col-lg-8 mb-2"></div>
                </div>
                <!-- Aqu√≠ se cargar√° din√°micamente el formulario -->
                <div id="formulario-especifico" class="mt-2 row"></div>
            </div>
            
            <!-- Columna derecha con manual y carga masiva -->
            <div class="col-12 col-lg-2 d-flex flex-column align-items-end mt-3 mt-lg-0">
                <div class="w-100 mb-2">
                    <button type="button" class="btn btn-dark btn-sm manual-button w-100" onclick="document.getElementById('manualModal').style.display='flex'">MANUAL</button>
                </div>
                
                <!-- Secci√≥n de carga masiva (solo visible al seleccionar material) -->
                <div id="upload_simple_container" class="w-100 mb-4" style="display: none;">
                    <div class="upload-box w-100">
                        <small class="text-muted">Para carga masiva, suba un archivo CSV o Excel (.csv, .xls, .xlsx):</small>
                        <label for="cargar_archivo" class="d-block my-3">
                            <div class="boton-redondeado">
                                <span>‚Üë</span>
                            </div>
                            <input type="file" id="cargar_archivo" name="cargar_archivo" accept=".csv, .xls, .xlsx" style="display: none;">
                        </label>
                        <div id="nombre_archivo_carga_simple" style="text-align:center;font-size:0.92em;color:#444;margin-top:6px;margin-bottom:2px;word-break:break-all;"></div>
                    </div>
                </div>
                
                <!-- Fila 4/5: Carga de Imagen -->
                <div id="upload_box_container" class="custom-upload-box-container" style="display: none; width: 100%;">
                    <div class="custom-upload-box w-100">
                        <button class="btn btn-sm custom-upload-btn w-100" type="button" onclick="document.getElementById('file_upload_input').click();">‚Üë</button>
                        <input type="file" id="file_upload_input" name="imagen" accept="image/*" style="display: none;">
                        <input type="text" id="url_upload_input" class="form-control custom-upload-input mb-2" placeholder="O pegue un enlace de imagen aqu√≠...">
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones -->
        <div id="buttons-container" class="row bg-white px-0 mx-0" style="border:none; box-shadow:none; display: none;">
            <div class="col-12 d-flex justify-content-end gap-5">
              <!-- Estan repetidos los botones -->
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block modals %}
  {% include 'modals/manual_modal.html' %}
  {% include 'modals/confirmacion_alta_material.html' %}
  {% comment %} {% include 'modals/confirmacion_carga_exitosa.html' %} {% endcomment %}
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const tipoMaterial = document.getElementById('tipo_material');
    const formularioEspecifico = document.getElementById('formulario-especifico');
    const buttonsContainer = document.getElementById('buttons-container');
    
    // Elementos de carga masiva e imagen
    const uploadSimple = document.getElementById('upload_simple_container');
    const uploadBox = document.getElementById('upload_box_container');

    // FUNCIONALIDAD PRINCIPAL - CON PROGRAMA INCLUIDO
    tipoMaterial.addEventListener('change', function () {
        const tipo = this.value;
        console.log('üî• Tipo seleccionado:', tipo); // DEBUG
        
        if (tipo === 'libro') {
            console.log('üìö Cargando formulario de libro...');
            fetch('/formulario/libro/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    
                    // Mostrar elementos de carga cuando se carga el formulario
                    if (uploadSimple) uploadSimple.style.display = 'block';
                    if (uploadBox) uploadBox.style.display = 'block';
                    console.log('‚úÖ Formulario de libro cargado');
                })
                .catch(error => {
                    console.error('‚ùå Error cargando libro:', error);
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        // üî•üî•üî• CASO PROGRAMA - ESTE ES EL QUE FALTABA üî•üî•üî•
        else if (tipo === 'programa') {
            console.log('üéì Cargando formulario de programa...');
            fetch('/formulario/programa/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    
                    // üî• IMPORTANTE: Corregir el action despu√©s de cargar
                    const form = document.getElementById('form_alta_material');
                    if (form) {
                        form.action = '/alta-programa/';
                        console.log('üîß Action del formulario programa corregido a:', form.action);
                    }
                    
                    // Mostrar elementos de carga cuando se carga el formulario
                    if (uploadSimple) uploadSimple.style.display = 'block';
                    if (uploadBox) uploadBox.style.display = 'block';
                    console.log('‚úÖ Formulario de programa cargado');
                })
                .catch(error => {
                    console.error('‚ùå Error cargando programa:', error);
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        // OTROS CASOS (si los tienes)
        else if (tipo === 'mapa') {
            console.log('üó∫Ô∏è Cargando formulario de mapa...');
            fetch('/formulario/mapa/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    
                    if (uploadSimple) uploadSimple.style.display = 'block';
                    if (uploadBox) uploadBox.style.display = 'block';
                })
                .catch(error => {
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else if (tipo === 'multimedia') {
            console.log('üíø Cargando formulario de multimedia...');
            fetch('/formulario/multimedia/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    
                    if (uploadSimple) uploadSimple.style.display = 'block';
                    if (uploadBox) uploadBox.style.display = 'block';
                })
                .catch(error => {
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else if (tipo === 'notebook') {
            console.log('üíª Cargando formulario de notebook...');
            fetch('/formulario/notebook/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    
                    if (uploadSimple) uploadSimple.style.display = 'block';
                    if (uploadBox) uploadBox.style.display = 'block';
                })
                .catch(error => {
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else if (tipo === 'proyector') {
            console.log('üìΩÔ∏è Cargando formulario de proyector...');
            fetch('/formulario/proyector/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    
                    if (uploadSimple) uploadSimple.style.display = 'block';
                    if (uploadBox) uploadBox.style.display = 'block';
                })
                .catch(error => {
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else if (tipo === 'varios') {
            console.log('üì¶ Cargando formulario de varios...');
            fetch('/formulario/varios/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    
                    if (uploadSimple) uploadSimple.style.display = 'block';
                    if (uploadBox) uploadBox.style.display = 'block';
                })
                .catch(error => {
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else {
            console.log('‚ùå Sin selecci√≥n o tipo no reconocido');
            formularioEspecifico.innerHTML = '';
            buttonsContainer.style.display = 'none';
            
            // Ocultar elementos de carga cuando no hay formulario
            if (uploadSimple) uploadSimple.style.display = 'none';
            if (uploadBox) uploadBox.style.display = 'none';
        }
    });

    // FUNCIONALIDAD AGREGADA: Mostrar nombre del archivo seleccionado
    const cargarArchivo = document.getElementById('cargar_archivo');
    const nombreArchivo = document.getElementById('nombre_archivo_carga_simple');
    
    if (cargarArchivo && nombreArchivo) {
        cargarArchivo.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                nombreArchivo.textContent = this.files[0].name;
            } else {
                nombreArchivo.textContent = '';
            }
        });
    }
});
</script>
{% endblock %}