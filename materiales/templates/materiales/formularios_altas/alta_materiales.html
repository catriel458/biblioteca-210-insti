{% extends 'components/baseb.html' %}
{% load static %}
{% block extra_styles %}
    <link rel="stylesheet" href="{% static 'css/header.css' %}">
    <link rel="stylesheet" href="{% static 'css/manual_modal.css' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="{% static 'css/style_form.css' %}">
    <link rel="stylesheet" href="{% static 'css/botones.css' %}">
    <link rel="stylesheet" href="{% static 'css/confirmacion_carga_exitosa.css' %}">
{% endblock %}

{% block content %}
<header class="header-pantalla">
    <div class="header-pantalla">
        <h1 class="header-title" style="padding-top: 15px;">ALTA MATERIAL</h1>
        <a href="{% url 'home' %}" class="logo-link">
            <img src="{% static 'imagenes/Logo_inicio.png' %}" alt="Logo" class="cover-pic">
        </a>
    </div>
</header>
<div class="container-fluid">
    <form id="form_alta_material" action="{% url 'alta_libro' %}" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="row align-items-start">
            <div class="col-12 col-lg-10">
                <div class="row">
                    <div class="col-12 col-sm-6 col-lg-2 form-group mb-2">
                        <label for="tipo_material" class="text-input" style="color:#25898D;">Tipo de Material:</label>
                        <select class="form-control form-control-sm" id="tipo_material" name="tipo_material" required>
                            <option value="">Selecciona un tipo de material</option>
                            <option value="libro">LIBRO</option>
                            <option value="programa">PROGRAMA</option>
                            <option value="mapa">MAPA</option>
                            <option value="multimedia">MULTIMEDIA</option>
                            <option value="notebook">NOTEBOOK</option>
                            <option value="proyector">PROYECTOR</option>
                            <option value="varios">VARIOS</option>
                        </select>
                    </div>
                    <div class="col-12 col-lg-8 mb-2"></div>
                </div>
                <!-- Aqu√≠ se cargar√° din√°micamente el formulario -->
                <div id="formulario-especifico" class="mt-2 row"></div>
            </div>
            
            <!-- Columna derecha con manual y carga masiva -->
            <div class="col-12 col-lg-2 d-flex flex-column align-items-end mt-3 mt-lg-0">
                <div class="w-100 mb-2">
                    <button type="button" class="btn btn-dark btn-sm manual-button w-100" onclick="document.getElementById('manualModal').style.display='flex'">MANUAL</button>
                </div>
                
                <!-- Secci√≥n de carga masiva (solo visible al seleccionar material) -->
                <div id="upload_simple_container" class="w-100 mb-4" style="display: none;">
                    <div class="upload-box w-100">
                        <small class="text-muted">Para carga masiva, suba un archivo CSV o Excel (.csv, .xls, .xlsx):</small>
                        <label for="cargar_archivo" class="d-block my-3">
                            <div class="boton-redondeado">
                                <span>‚Üë</span>
                            </div>
                            <input type="file" id="cargar_archivo" name="cargar_archivo" accept=".csv, .xls, .xlsx" style="display: none;">
                        </label>
                        <div id="nombre_archivo_carga_simple" style="text-align:center;font-size:0.92em;color:#444;margin-top:6px;margin-bottom:2px;word-break:break-all;"></div>
                    </div>
                </div>
                
                <!-- Fila 4/5: Carga de Imagen -->
                <div id="upload_box_container" class="custom-upload-box-container" style="display: none; width: 100%;">
                    <div class="custom-upload-box w-100">
                        <button class="btn btn-sm custom-upload-btn w-100" type="button" onclick="document.getElementById('file_upload_input').click();">‚Üë</button>
                        <input type="file" id="file_upload_input" name="imagen" accept="image/*" style="display: none;">
                        <input type="text" id="url_upload_input" class="form-control custom-upload-input mb-2" placeholder="O pegue un enlace de imagen aqu√≠...">
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones -->
        <div id="buttons-container" class="row bg-white px-0 mx-0" style="border:none; box-shadow:none; display: none;">
            <div class="col-12 d-flex justify-content-end gap-5">
              <!-- Estan repetidos los botones -->
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block modals %}
  {% include 'modals/manual_modal.html' %}
  {% include 'modals/confirmacion_alta_material.html' %}
  {% comment %} {% include 'modals/confirmacion_carga_exitosa.html' %} {% endcomment %}
{% endblock %}

{% block extra_scripts %}
<script>
// Script para el template principal (paste-2.txt - segundo template)
document.addEventListener("DOMContentLoaded", function () {
    const tipoMaterial = document.getElementById('tipo_material');
    const formularioEspecifico = document.getElementById('formulario-especifico');
    const buttonsContainer = document.getElementById('buttons-container');
    
    // Elementos de carga masiva e imagen
    const uploadSimple = document.getElementById('upload_simple_container');
    const uploadBox = document.getElementById('upload_box_container');

    // FUNCIONALIDAD PRINCIPAL
    tipoMaterial.addEventListener('change', function () {
        const tipo = this.value;
        console.log('üî• Tipo seleccionado:', tipo);
        
        if (tipo === '') {
            formularioEspecifico.innerHTML = '';
            buttonsContainer.style.display = 'none';
            if (uploadSimple) uploadSimple.style.display = 'none';
            if (uploadBox) uploadBox.style.display = 'none';
            return;
        }
        
        if (tipo === 'libro') {
            console.log('üìö Cargando formulario de libro...');
            fetch('/formulario/libro/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    
                    // üî• IMPORTANTE: Establecer el action correcto para libro
                    const form = document.getElementById('form_alta_material');
                    if (form) {
                        form.action = '/alta-libro/';
                        console.log('üîß Action del formulario libro establecido a:', form.action);
                    }
                    
                    // Solo mostrar carga masiva y URL para libros
                    if (uploadSimple) uploadSimple.style.display = 'block';
                    if (uploadBox) uploadBox.style.display = 'block';
                    console.log('‚úÖ Formulario de libro cargado');
                })
                .catch(error => {
                    console.error('‚ùå Error cargando libro:', error);
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else if (tipo === 'programa') {
            console.log('üéì Cargando formulario de programa...');
            fetch('/formulario/programa/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    
                    // üî• IMPORTANTE: Corregir el action despu√©s de cargar
                    const form = document.getElementById('form_alta_material');
                    if (form) {
                        form.action = '/alta-programa/';
                        console.log('üîß Action del formulario programa corregido a:', form.action);
                    }
                    
                    // üéØ CR√çTICO: Inicializar funcionalidad carrera-materia DESPU√âS de cargar HTML
                    setTimeout(() => {
                        initCarreraMateriaFunctionality();
                    }, 100); // Peque√±o delay para asegurar que el DOM est√© listo
                    
                    // No mostrar carga masiva ni URL para programas
                    if (uploadSimple) uploadSimple.style.display = 'none';
                    if (uploadBox) uploadBox.style.display = 'none';
                    console.log('‚úÖ Formulario de programa cargado');
                })
                .catch(error => {
                    console.error('‚ùå Error cargando programa:', error);
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        // ... resto de casos (mapa, multimedia, etc.)
        else if (tipo === 'mapa') {
            console.log('üó∫Ô∏è Cargando formulario de mapa...');
            fetch('/formulario/mapa/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    // No mostrar carga masiva ni URL para mapas
                    if (uploadSimple) uploadSimple.style.display = 'none';
                    if (uploadBox) uploadBox.style.display = 'none';
                })
                .catch(error => {
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else if (tipo === 'multimedia') {
            console.log('üíø Cargando formulario de multimedia...');
            fetch('/formulario/multimedia/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    // No mostrar carga masiva ni URL para multimedia
                    if (uploadSimple) uploadSimple.style.display = 'none';
                    if (uploadBox) uploadBox.style.display = 'none';
                })
                .catch(error => {
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else if (tipo === 'notebook') {
            console.log('üíª Cargando formulario de notebook...');
            fetch('/formulario/notebook/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    // No mostrar carga masiva ni URL para notebook
                    if (uploadSimple) uploadSimple.style.display = 'none';
                    if (uploadBox) uploadBox.style.display = 'none';
                })
                .catch(error => {
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else if (tipo === 'proyector') {
            console.log('üìΩÔ∏è Cargando formulario de proyector...');
            fetch('/formulario/proyector/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    // No mostrar carga masiva ni URL para proyector
                    if (uploadSimple) uploadSimple.style.display = 'none';
                    if (uploadBox) uploadBox.style.display = 'none';
                })
                .catch(error => {
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else if (tipo === 'varios') {
            console.log('üì¶ Cargando formulario de varios...');
            fetch('/formulario/varios/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    // No mostrar carga masiva ni URL para varios
                    if (uploadSimple) uploadSimple.style.display = 'none';
                    if (uploadBox) uploadBox.style.display = 'none';
                })
                .catch(error => {
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else {
            console.log('‚ùå Sin selecci√≥n o tipo no reconocido');
            formularioEspecifico.innerHTML = '';
            buttonsContainer.style.display = 'none';
            if (uploadSimple) uploadSimple.style.display = 'none';
            if (uploadBox) uploadBox.style.display = 'none';
        }
    });

    // FUNCIONALIDAD AGREGADA: Mostrar nombre del archivo seleccionado
    const cargarArchivo = document.getElementById('cargar_archivo');
    const nombreArchivo = document.getElementById('nombre_archivo_carga_simple');
    
    if (cargarArchivo && nombreArchivo) {
        cargarArchivo.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                nombreArchivo.textContent = this.files[0].name;
            } else {
                nombreArchivo.textContent = '';
            }
        });
    }

    // üéØ FUNCI√ìN PARA INICIALIZAR CARRERA-MATERIA (solo cuando se carga programa)
    function initCarreraMateriaFunctionality() {
        const carreraSelect = document.getElementById('id_carrera');
        const materiaSelect = document.getElementById('id_materia');
        
        console.log('üéØ Inicializando carrera-materia...', !!carreraSelect, !!materiaSelect);
        
        if (!carreraSelect || !materiaSelect) {
            console.log('‚ö†Ô∏è Elementos carrera-materia no encontrados');
            return;
        }

        // Materias por carrera - ID√âNTICO al primer archivo
        const materiasPorCarrera = {
            'Profesorado de Educaci√≥n Inicial': [
                'Pedagog√≠a', 'Psicolog√≠a Educacional', 'Sociolog√≠a de la Educaci√≥n', 
                'Historia y Pol√≠tica de la Educaci√≥n Argentina', 'Filosof√≠a de la Educaci√≥n',
                'Did√°ctica General', 'Curriculum y Did√°ctica del Nivel Inicial', 
                'Juego y Desarrollo Infantil', 'Literatura Infantil', 'Matem√°tica y su Did√°ctica',
                'Ciencias Sociales y su Did√°ctica', 'Ciencias Naturales y su Did√°ctica',
                'Lengua y su Did√°ctica', 'Educaci√≥n Art√≠stica', 'Educaci√≥n F√≠sica',
                'Pr√°ctica Docente I', 'Pr√°ctica Docente II', 'Pr√°ctica Docente III', 'Pr√°ctica Docente IV'
            ],
            'Profesorado de Educaci√≥n Primaria': [
                'Pedagog√≠a', 'Psicolog√≠a Educacional', 'Sociolog√≠a de la Educaci√≥n',
                'Historia y Pol√≠tica de la Educaci√≥n Argentina', 'Filosof√≠a de la Educaci√≥n',
                'Did√°ctica General', 'Curriculum y Did√°ctica del Nivel Primario',
                'Matem√°tica y su Did√°ctica I', 'Matem√°tica y su Did√°ctica II',
                'Lengua y su Did√°ctica I', 'Lengua y su Did√°ctica II',
                'Ciencias Sociales y su Did√°ctica I', 'Ciencias Sociales y su Did√°ctica II',
                'Ciencias Naturales y su Did√°ctica I', 'Ciencias Naturales y su Did√°ctica II',
                'Educaci√≥n Art√≠stica', 'Educaci√≥n F√≠sica', 'Tecnolog√≠as de la Informaci√≥n',
                'Pr√°ctica Docente I', 'Pr√°ctica Docente II', 'Pr√°ctica Docente III', 'Pr√°ctica Docente IV'
            ],
            'Profesorado de Educaci√≥n Secundaria en Geograf√≠a': [
                'Pedagog√≠a', 'Psicolog√≠a Educacional', 'Sociolog√≠a de la Educaci√≥n',
                'Historia y Pol√≠tica de la Educaci√≥n Argentina', 'Filosof√≠a de la Educaci√≥n',
                'Did√°ctica General', 'Did√°ctica de la Geograf√≠a',
                'Geograf√≠a F√≠sica I', 'Geograf√≠a F√≠sica II', 'Geograf√≠a Humana I', 'Geograf√≠a Humana II',
                'Geograf√≠a de Am√©rica', 'Geograf√≠a de Argentina', 'Geograf√≠a Mundial',
                'Cartograf√≠a', 'Climatolog√≠a', 'Geomorfolog√≠a', 'Biogeograf√≠a',
                'Geograf√≠a Econ√≥mica', 'Geograf√≠a Urbana y Rural', 'Epistemolog√≠a de la Geograf√≠a',
                'Pr√°ctica Docente I', 'Pr√°ctica Docente II', 'Pr√°ctica Docente III', 'Pr√°ctica Docente IV'
            ],
            'Profesorado de Educaci√≥n Secundaria en Ciencias Pol√≠ticas': [
                'Pedagog√≠a', 'Psicolog√≠a Educacional', 'Sociolog√≠a de la Educaci√≥n',
                'Historia y Pol√≠tica de la Educaci√≥n Argentina', 'Filosof√≠a de la Educaci√≥n',
                'Did√°ctica General', 'Did√°ctica de las Ciencias Pol√≠ticas',
                'Teor√≠a Pol√≠tica', 'Historia del Pensamiento Pol√≠tico', 'Sistemas Pol√≠ticos Comparados',
                'Pol√≠tica Argentina', 'Pol√≠tica Latinoamericana', 'Relaciones Internacionales',
                'Derecho Constitucional', 'Sociolog√≠a Pol√≠tica', 'Econom√≠a Pol√≠tica',
                'Filosof√≠a Pol√≠tica', 'Metodolog√≠a de la Investigaci√≥n Social',
                'Pr√°ctica Docente I', 'Pr√°ctica Docente II', 'Pr√°ctica Docente III', 'Pr√°ctica Docente IV'
            ],
            'Tecnicatura Superior en An√°lisis de Sistemas': [
                'Matem√°tica', 'Ingl√©s T√©cnico', 'Arquitectura de Computadoras',
                'Sistemas Operativos', 'Algoritmos y Estructuras de Datos',
                'Programaci√≥n I', 'Programaci√≥n II', 'Programaci√≥n III',
                'Base de Datos I', 'Base de Datos II', 'An√°lisis de Sistemas I', 'An√°lisis de Sistemas II',
                'Ingenier√≠a de Software', 'Redes y Comunicaciones', 'Seguridad Inform√°tica',
                'Desarrollo Web', 'Programaci√≥n Orientada a Objetos', 'Metodolog√≠as de Desarrollo',
                'Gesti√≥n de Proyectos', 'Pr√°ctica Profesionalizante I', 'Pr√°ctica Profesionalizante II'
            ],
            'Tecnicatura Superior en Enfermer√≠a': [
                'Anatom√≠a y Fisiolog√≠a I', 'Anatom√≠a y Fisiolog√≠a II', 'Microbiolog√≠a y Parasitolog√≠a',
                'Farmacolog√≠a', 'Patolog√≠a', 'Nutrici√≥n y Dietoterapia',
                'Enfermer√≠a B√°sica', 'Enfermer√≠a M√©dica', 'Enfermer√≠a Quir√∫rgica',
                'Enfermer√≠a Materno Infantil', 'Enfermer√≠a Pedi√°trica', 'Enfermer√≠a Geri√°trica',
                'Enfermer√≠a en Salud Mental', 'Enfermer√≠a Comunitaria', 'Administraci√≥n en Enfermer√≠a',
                'Bio√©tica', 'Epidemiolog√≠a', 'Primeros Auxilios',
                'Pr√°ctica Profesional I', 'Pr√°ctica Profesional II', 'Pr√°ctica Profesional III'
            ],
            'Tecnicatura Superior en Acompa√±amiento Terap√©utico': [
                'Psicolog√≠a General', 'Psicopatolog√≠a', 'Neurociencias', 'Desarrollo Humano',
                'Teor√≠as y T√©cnicas de Acompa√±amiento Terap√©utico', 'Comunicaci√≥n Terap√©utica',
                'Din√°micas Familiares', 'Integraci√≥n Social', 'Recreaci√≥n Terap√©utica',
                'Talleres de Expresi√≥n', 'Primeros Auxilios', 'Bio√©tica',
                'Legislaci√≥n en Salud Mental', 'Trabajo Interdisciplinario',
                'Pr√°ctica Profesional I', 'Pr√°ctica Profesional II', 'Pr√°ctica Profesional III'
            ],
            'Tecnicatura Superior en Higiene y Seguridad en el Trabajo': [
                'Matem√°tica', 'F√≠sica', 'Qu√≠mica', 'Legislaci√≥n Laboral',
                'Higiene Industrial I', 'Higiene Industrial II', 'Seguridad Industrial I', 'Seguridad Industrial II',
                'Medicina del Trabajo', 'Toxicolog√≠a Laboral', 'Ergonom√≠a',
                'Protecci√≥n contra Incendios', 'Contaminaci√≥n Ambiental', 'Gesti√≥n de Residuos',
                'Capacitaci√≥n en Seguridad', 'Investigaci√≥n de Accidentes', 'Auditor√≠as de Seguridad',
                'Gesti√≥n de Riesgos', 'Pr√°ctica Profesional I', 'Pr√°ctica Profesional II'
            ]
        };

        // FUNCI√ìN para cargar materias
        function cargarMaterias(carreraSeleccionada) {
            console.log('üìö Carrera seleccionada:', carreraSeleccionada);
            
            // Limpiar opciones de materia
            materiaSelect.innerHTML = '';
            
            if (carreraSeleccionada && materiasPorCarrera[carreraSeleccionada]) {
                // Agregar opci√≥n vac√≠a
                const opcionVacia = document.createElement('option');
                opcionVacia.value = '';
                opcionVacia.textContent = 'Seleccione una materia';
                materiaSelect.appendChild(opcionVacia);
                
                // Agregar materias de la carrera seleccionada
                materiasPorCarrera[carreraSeleccionada].forEach(function(materia) {
                    const option = document.createElement('option');
                    option.value = materia;
                    option.textContent = materia;
                    materiaSelect.appendChild(option);
                });
                
                materiaSelect.disabled = false;
                console.log('‚úÖ Materias cargadas:', materiasPorCarrera[carreraSeleccionada].length);
            } else {
                // No hay carrera seleccionada o no tiene materias
                const opcionVacia = document.createElement('option');
                opcionVacia.value = '';
                opcionVacia.textContent = 'Primero seleccione una carrera';
                materiaSelect.appendChild(opcionVacia);
                materiaSelect.disabled = true;
                console.log('‚ö†Ô∏è No hay materias para:', carreraSeleccionada);
            }
        }
        
        // Event listener para cambio de carrera
        carreraSelect.addEventListener('change', function() {
            cargarMaterias(this.value);
        });
        
        // Inicializar estado de materia
        materiaSelect.disabled = true;
        
        // Si ya hay una carrera seleccionada al cargar
        if (carreraSelect.value) {
            cargarMaterias(carreraSelect.value);
        }
        
        console.log('‚úÖ Funcionalidad carrera-materia inicializada correctamente');
    }
});
</script>
{% endblock %}