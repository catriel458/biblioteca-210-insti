{% extends 'components/baseb.html' %}
{% load static %}
{% block extra_styles %}
    <link rel="stylesheet" href="{% static 'css/header.css' %}">
    <link rel="stylesheet" href="{% static 'css/manual_modal.css' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="{% static 'css/style_form.css' %}">
    <link rel="stylesheet" href="{% static 'css/botones.css' %}">
    <style>
        .loader { display: none; text-align: center; padding: 8px; color: #25898D; font-weight: 600; }
        .spinner { width: 22px; height: 22px; border: 3px solid #cce6e8; border-top-color: #25898D; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
{% endblock %}

{% block content %}
<header class="header-pantalla">
    <div class="header-pantalla">
        <h1 class="header-title">ALTA MATERIAL</h1>
        <a href="{% url 'home' %}" class="logo-link">
            <img src="{% static 'imagenes/Logo_inicio.png' %}" alt="Logo" class="cover-pic">
        </a>
    </div>
</header>
<div class="container-fluid">
    <form id="form_alta_material" action="{% url 'alta_libro' %}" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="row align-items-start">
            <div class="col-12 col-lg-10">
                <div class="row">
                    <div class="col-12 col-sm-6 col-lg-2 form-group mb-2">
                        <label for="tipo_material" class="text-input" style="color:#25898D;">Tipo de Material:</label>
                        <select class="form-control form-control-sm" id="tipo_material" name="tipo_material" required>
                            <option value="">Selecciona un tipo de material</option>
                            <option value="libro">LIBRO</option>
                            <option value="mapa">MAPA</option>
                            <option value="multimedia">MULTIMEDIA</option>
                            <option value="notebook">NOTEBOOK</option>
                            <option value="programa">PROGRAMA</option>
                            <option value="proyector">PROYECTOR</option>
                            <option value="varios">VARIOS</option>
                        </select>
                    </div>
                    <div class="col-12 col-lg-8 mb-2"></div>
                </div>
                <!-- Aqu√≠ se cargar√° din√°micamente el formulario -->
                <div id="formulario-especifico" class="mt-2 row"></div>
            </div>
            
            <!-- Columna derecha con manual y carga masiva -->
            <div class="col-12 col-lg-2 d-flex flex-column align-items-end mt-3 mt-lg-0">
                <div class="w-100 mb-2">
                    <button type="button" class="btn btn-dark btn-sm manual-button w-100" onclick="document.getElementById('manualModal').style.display='flex'">MANUAL</button>
                </div>
                
                <!-- Secci√≥n de carga masiva (solo visible al seleccionar material) -->
                <div id="upload_simple_container" class="w-100 mb-4" style="display: none;">
                    <div class="upload-box w-100">
                        <small class="text-muted">Para carga masiva, suba un archivo CSV o Excel (.csv, .xls, .xlsx):</small>
                        <label for="cargar_archivo" class="d-block my-3">
                            <div class="boton-redondeado">
                                <span>‚Üë</span>
                            </div>
                        <input type="file" id="cargar_archivo" name="csv_file" accept=".csv, .xls, .xlsx" style="display: none;">
                        </label>
                        <div id="nombre_archivo_carga_simple" style="text-align:center;font-size:0.92em;color:#444;margin-top:6px;margin-bottom:2px;word-break:break-all;"></div>
                        <div class="loader" id="upload-loader"><div class="spinner"></div></div>
                    </div>
                </div>
                
                <!-- Fila 4/5: Carga de Imagen -->
                <div id="upload_box_container" class="custom-upload-box-container" style="display: none; width: 100%;">
                    <div class="custom-upload-box w-100">
                        <button class="btn btn-sm custom-upload-btn w-100" type="button" onclick="document.getElementById('file_upload_input').click();">‚Üë</button>
                        <input type="file" id="file_upload_input" name="imagen" accept="image/*" style="display: none;">
                        <!-- Importante: agregar name="img" para que el backend reciba la URL de imagen -->
                        <input type="text" id="url_upload_input" name="img" class="form-control custom-upload-input mb-2" placeholder="O pegue un enlace de imagen aqu√≠...">
                        <!-- Mostrar nombre y preview de la imagen seleccionada -->
                        <div id="selected_image_name" style="text-align:center;font-size:0.92em;color:#444;margin-top:6px;margin-bottom:2px;word-break:break-all;"></div>
                        <img id="selected_image_preview" alt="Vista previa" style="display:none;max-width:100%;height:auto;border-radius:6px;margin-top:6px;" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones -->
        <div id="buttons-container" class="row bg-white px-0 mx-0" style="border:none; box-shadow:none; display: none;">
            <div class="col-12 d-flex justify-content-end gap-5">
              <!-- Los botones se cargan din√°micamente con cada formulario espec√≠fico -->
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block modals %}
  {% include 'modals/manual_modal.html' %}
  <div id="contenedor-modal-confirmacion"></div>
  {% include 'modals/alertas/vaciar_campos.html' %}
  {% include 'modals/alertas/reducir_ejemplares.html' %}
  {% include 'modals/alertas/confirmacion_csv.html' %}
  {% include 'modals/alertas/archivo_novalido.html' %}
  {% include 'modals/alertas/imagenlibro_novalido.html' %}
  {% include 'modals/alertas/error_seleccionado.html' %}
  {% include 'modals/alertas/archivovacio_cargamasiva.html' %}
  <div id="modal-backdrop" class="modal-backdrop"></div>
  <div class="modal fade" id="modal-exito-carga" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body" style="text-align:center; padding:2rem;">
          <h5 style="margin-bottom:1rem;">¬°Carga exitosa!</h5>
          <p style="margin-bottom:1.5rem;">El archivo fue procesado correctamente.</p>
          <button type="button" class="btn btn-success" id="btn-aceptar-exito">Aceptar</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="modal-cargando-csv" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body" style="text-align:center; padding:2rem;">
          <h5 style="margin-bottom:1rem;">Cargando</h5>
          <div class="loader" style="display:block"><div class="spinner"></div></div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/alertas.js' %}"></script>
<script>
// Script para el template principal (paste-2.txt - segundo template)
document.addEventListener("DOMContentLoaded", function () {
    const tipoMaterial = document.getElementById('tipo_material');
    const formularioEspecifico = document.getElementById('formulario-especifico');
    const buttonsContainer = document.getElementById('buttons-container');
    
    // Elementos de carga masiva e imagen
    const uploadSimple = document.getElementById('upload_simple_container');
    const uploadBox = document.getElementById('upload_box_container');
    const fileInput = document.getElementById('file_upload_input');
    const urlInput = document.getElementById('url_upload_input');
    const selectedName = document.getElementById('selected_image_name');
    const previewImg = document.getElementById('selected_image_preview');
    function setUploadLoaderVisible(visible) {
        var el = document.getElementById('upload-loader');
        if (el) el.style.display = visible ? 'block' : 'none';
        var fileInputControl = document.getElementById('cargar_archivo');
        if (fileInputControl) fileInputControl.disabled = !!visible;
    }

    // Helper: vincular bot√≥n CANCELAR de cada formulario espec√≠fico al modal de vaciar campos
    function wireCancelButton(container) {
        try {
            const cancelBtn = container ? container.querySelector('button[type="reset"]') : null;
            if (cancelBtn) {
                // Cambiar a bot√≥n normal y conectar al modal
                cancelBtn.type = 'button';
                cancelBtn.onclick = function() {
                    if (typeof mostrarModalAlerta === 'function') {
                        mostrarModalAlerta(vaciarCamposFormulario);
                    } else {
                        // Fallback sin modal
                        vaciarCamposFormulario();
                    }
                };
                console.log('‚úÖ Bot√≥n CANCELAR vinculado al modal de vaciar campos');
            } else {
                console.log('‚ÑπÔ∏è No se encontr√≥ bot√≥n CANCELAR en el contenedor actual');
            }
        } catch (e) {
            console.error('‚ùå Error al vincular bot√≥n CANCELAR:', e);
        }
    }

    // Ocultar carga masiva al cargar la p√°gina (estado inicial)
    if (uploadSimple) uploadSimple.style.display = 'none';
    if (uploadBox) uploadBox.style.display = 'none';

    // Manejo de selecci√≥n de imagen local
    if (fileInput) {
        fileInput.addEventListener('change', function () {
            const file = this.files && this.files[0] ? this.files[0] : null;
            if (file) {
                // Mostrar nombre
                if (selectedName) {
                    selectedName.textContent = file.name;
                }
                // Mostrar preview (solo en frontend)
                if (previewImg) {
                    const objectUrl = URL.createObjectURL(file);
                    previewImg.src = objectUrl;
                    previewImg.style.display = 'block';
                }
                // Limpiar URL manual si hab√≠a
                if (urlInput) {
                    urlInput.value = '';
                }
            } else {
                if (selectedName) selectedName.textContent = '';
                if (previewImg) {
                    previewImg.src = '';
                    previewImg.style.display = 'none';
                }
            }
        });
    }

    // Si se ingresa una URL manual, ocultar preview y limpiar selecci√≥n local
    if (urlInput) {
        urlInput.addEventListener('input', function () {
            const hasValue = this.value.trim().length > 0;
            if (hasValue) {
                if (selectedName) selectedName.textContent = '';
                if (fileInput) fileInput.value = '';
                if (previewImg) {
                    previewImg.src = '';
                    previewImg.style.display = 'none';
                }
            }
        });
    }

    // FUNCIONALIDAD PRINCIPAL
    tipoMaterial.addEventListener('change', function () {
        const tipo = this.value;
        console.log('üî• Tipo seleccionado:', tipo);
        
        if (tipo === '') {
            formularioEspecifico.innerHTML = '';
            buttonsContainer.style.display = 'none';
            // Ocultar carga masiva cuando no hay tipo seleccionado
            if (uploadSimple) uploadSimple.style.display = 'none';
            if (uploadBox) uploadBox.style.display = 'none';
            return;
        }
        
        if (tipo === 'libro') {
            console.log('üìö Cargando formulario de libro...');
            fetch('/formulario/libro/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    const tempForm = tempDiv.querySelector('#form_alta_material') || tempDiv.querySelector('form');
                    const formContent = tempForm ? tempForm.innerHTML : html;
                    formularioEspecifico.innerHTML = formContent;
                    buttonsContainer.style.display = 'flex';
                    
                    // üî• IMPORTANTE: Establecer el action correcto para libro
                    const form = document.getElementById('form_alta_material');
                    if (form) {
                        form.action = '/alta-libro/';
                        console.log('üîß Action del formulario libro establecido a:', form.action);
                    }
                    
                    // Mostrar el modal de confirmaci√≥n gen√©rico para libro
                    const contenedorModal = document.getElementById('contenedor-modal-confirmacion');
                    if (contenedorModal) {
                        contenedorModal.style.display = 'block';
                        console.log('üîß Modal de confirmaci√≥n gen√©rico mostrado para libro');
                    }
                    
                    // Solo mostrar carga masiva y URL para libros
                    if (uploadSimple) uploadSimple.style.display = 'block';
                    if (uploadBox) uploadBox.style.display = 'block';

                    // Vincular bot√≥n CANCELAR al modal de vaciar campos
                    wireCancelButton(formularioEspecifico);
                    
                    // üéØ CR√çTICO: Inicializar funcionalidad din√°mica DESPU√âS de cargar HTML
                    setTimeout(() => {
                        // Inicializar ejemplares din√°micos para libros
                        const cantidadInput = document.querySelector('input[name="cant_ejemplares"]');
                        if (cantidadInput) {
                            // Definir wrapper para compatibilidad con alertas.js
                            window.actualizarEjemplaresLibro = function() {
                                if (typeof window.updateRowsMaterial === 'function') {
                                    window.updateRowsMaterial('libro');
                                }
                            };
                            
                            // Generar ejemplares iniciales
                            window.actualizarEjemplaresLibro();
                            
                            // Guardar valor anterior para detectar reducci√≥n
                            const valorInicial = parseInt(cantidadInput.value || '1', 10);
                            cantidadInput.setAttribute('data-valor-anterior', valorInicial);
                            
                            // Manejar cambios: usar l√≥gica de reducci√≥n si est√° disponible
                            const manejarCambioCantidad = function() {
                                console.log('üîÑ Cantidad de ejemplares cambiada:', this.value);
                                if (typeof window.manejarReduccionEjemplaresLibro === 'function') {
                                    window.manejarReduccionEjemplaresLibro();
                                } else {
                                    // Fallback si no est√° la funci√≥n de alertas
                                    window.actualizarEjemplaresLibro();
                                }
                            };
                            cantidadInput.addEventListener('input', manejarCambioCantidad);
                            cantidadInput.addEventListener('change', manejarCambioCantidad);
                            
                            console.log('‚úÖ Funcionalidad din√°mica de libros inicializada');
                        } else {
                            console.warn('‚ö†Ô∏è Input de cantidad de ejemplares no encontrado');
                        }
                    }, 100); // Peque√±o delay para asegurar que el DOM est√© listo
                    
                    console.log('‚úÖ Formulario de libro cargado');
                })
                .catch(error => {
                    console.error('‚ùå Error cargando libro:', error);
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else if (tipo === 'programa') {
            console.log('üéì Cargando formulario de programa...');
            fetch('/formulario/programa/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    const tempForm = tempDiv.querySelector('#form_alta_material') || tempDiv.querySelector('form');
                    const formContent = tempForm ? tempForm.innerHTML : html;
                    formularioEspecifico.innerHTML = formContent;
                    buttonsContainer.style.display = 'flex';
                    
                    // üî• IMPORTANTE: Corregir el action despu√©s de cargar
                    const form = document.getElementById('form_alta_material');
                    if (form) {
                        form.action = '/alta-programa/';
                        console.log('üîß Action del formulario programa corregido a:', form.action);
                    }
                    
                    // üéØ CR√çTICO: Inicializar funcionalidad carrera-materia DESPU√âS de cargar HTML
                    setTimeout(() => {
                        initCarreraMateriaFunctionality();
                    }, 100); // Peque√±o delay para asegurar que el DOM est√© listo
                    
                    // No mostrar carga masiva ni URL para programas
                    if (uploadSimple) uploadSimple.style.display = 'none';
                    if (uploadBox) uploadBox.style.display = 'none';
                    // Vincular bot√≥n CANCELAR al modal de vaciar campos
                    wireCancelButton(formularioEspecifico);
                    console.log('‚úÖ Formulario de programa cargado');
                })
                .catch(error => {
                    console.error('‚ùå Error cargando programa:', error);
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        // ... resto de casos (mapa, multimedia, etc.)
        else if (tipo === 'mapa') {
            console.log('üó∫Ô∏è Cargando formulario de mapa...');
            fetch('/formulario/mapa/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    
                    // üî• IMPORTANTE: Establecer el action correcto para mapa
                    const form = document.getElementById('form_alta_material');
                    if (form) {
                        form.action = '/confirmar-alta-mapa/';
                        console.log('üîß Action del formulario mapa establecido a:', form.action);
                    }
                    
                    // üéØ CR√çTICO: Inicializar funcionalidad de mapas DESPU√âS de cargar HTML
                    setTimeout(() => {
                        // Inicializar arrays globales y renderizar tipos de mapa
                        if (typeof window.gruposTiposMapa === 'undefined') {
                            window.gruposTiposMapa = [];
                        }
                        if (typeof window.renderizarTiposMapa === 'function') {
                            window.renderizarTiposMapa();
                        }

                        // Modal de reducir ejemplares para MAPA (usa input-nueva-cant-mapa)
                        const cantidadMapaInput = document.getElementById('input-nueva-cant-mapa');
                        const contenedorEjemplaresMapa = document.getElementById('contenedor-ejemplares-mapa');
                        if (cantidadMapaInput) {
                            const valorInicialMapa = parseInt(cantidadMapaInput.value || '1', 10);
                            cantidadMapaInput.setAttribute('data-valor-anterior', valorInicialMapa);

                            const manejarCambioCantidadMapa = function() {
                                const prev = parseInt(cantidadMapaInput.getAttribute('data-valor-anterior') || valorInicialMapa, 10);
                                const nuevo = parseInt(cantidadMapaInput.value || '1', 10);
                                if (nuevo < prev) {
                                    mostrarModalReducirEjemplares(
                                        function() {
                                            cantidadMapaInput.setAttribute('data-valor-anterior', nuevo);
                                            if (typeof window.renderizarTiposMapa === 'function') {
                                                window.renderizarTiposMapa();
                                            } else if (contenedorEjemplaresMapa) {
                                                contenedorEjemplaresMapa.innerHTML = '';
                                            }
                                        },
                                        function() {
                                            cantidadMapaInput.value = prev;
                                        }
                                    );
                                } else {
                                    cantidadMapaInput.setAttribute('data-valor-anterior', nuevo);
                                    if (typeof window.renderizarTiposMapa === 'function') {
                                        window.renderizarTiposMapa();
                                    }
                                }
                            };

                            cantidadMapaInput.addEventListener('input', manejarCambioCantidadMapa);
                            cantidadMapaInput.addEventListener('change', manejarCambioCantidadMapa);
                        } else {
                            console.warn('‚ö†Ô∏è input-nueva-cant-mapa no encontrado');
                        }
                    }, 100); // Peque√±o delay para asegurar que el DOM est√© listo
                    
                    // No mostrar carga masiva ni URL para mapas
                    if (uploadSimple) uploadSimple.style.display = 'none';
                    if (uploadBox) uploadBox.style.display = 'none';
                    // Vincular bot√≥n CANCELAR al modal de vaciar campos
                    wireCancelButton(formularioEspecifico);
                    console.log('‚úÖ Formulario de mapa cargado');
                })
                .catch(error => {
                    console.error('‚ùå Error cargando mapa:', error);
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
                else if (tipo === 'multimedia') {
                    console.log('üíø Cargando formulario de multimedia...');
                    fetch('/formulario/multimedia/')
                        .then(response => {
                            if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                            return response.text();
                        })
                        .then(html => {
                    console.log('üìÑ HTML recibido, longitud:', html.length);
                    
                    // üîç DEBUGGING EXHAUSTIVO DEL HTML RECIBIDO
                    console.log('üîç Primeros 500 caracteres del HTML:', html.substring(0, 500));
                    console.log('üîç ¬øContiene form_alta_multimedia?', html.includes('form_alta_multimedia'));
                    console.log('üîç ¬øContiene id="form_alta_multimedia"?', html.includes('id="form_alta_multimedia"'));
                    
                    // üî• SOLUCI√ìN: Extraer solo el contenido interno del form para evitar formularios anidados
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    
                    // Buscar el formulario en el HTML temporal
                    const tempForm = tempDiv.querySelector('#form_alta_multimedia') || tempDiv.querySelector('form[data-form-id="multimedia"]');
                    
                    if (tempForm) {
                        // Extraer solo el contenido interno del formulario (sin el tag <form>)
                        const formContent = tempForm.innerHTML;
                        console.log('‚úÖ Contenido del formulario extra√≠do, longitud:', formContent.length);
                        
                        // Insertar el contenido en el formulario principal
                        formularioEspecifico.innerHTML = formContent;
                        
                        // Establecer el data-form-type para identificaci√≥n
                        formularioEspecifico.setAttribute('data-form-type', 'multimedia');
                        
                        console.log('üîç Contenido insertado en formularioEspecifico');
                    } else {
                        console.error('‚ùå No se encontr√≥ el formulario en el HTML recibido');
                        formularioEspecifico.innerHTML = html; // Fallback al m√©todo anterior
                    }
                    
                    buttonsContainer.style.display = 'flex';
                    
                    // üîç DEBUGGING DEL CONTENIDO INSERTADO
                    console.log('üîç Contenido de formularioEspecifico despu√©s de insertar:', formularioEspecifico.innerHTML.substring(0, 500));
                    console.log('üîç ¬øformularioEspecifico contiene form_alta_multimedia?', formularioEspecifico.innerHTML.includes('form_alta_multimedia'));
                    
                    // üî• IMPORTANTE: Usar setTimeout para asegurar que el DOM est√© completamente renderizado
                    setTimeout(() => {
                        // üî• NUEVA L√ìGICA: Buscar el contenedor con data-form-type="multimedia"
                        let multimediaContainer = formularioEspecifico.querySelector('[data-form-type="multimedia"]');
                        
                        // Si no se encuentra en formularioEspecifico, buscar en el propio formularioEspecifico
                        if (!multimediaContainer && formularioEspecifico.getAttribute('data-form-type') === 'multimedia') {
                            multimediaContainer = formularioEspecifico;
                        }
                        
                        console.log('üîç Contenedor multimedia encontrado:', !!multimediaContainer);
                        
                        if (multimediaContainer) {
                            // Configurar el formulario principal para multimedia
                            const mainForm = document.getElementById('form_alta_material');
                            if (mainForm) {
                                mainForm.action = '/alta-multimedia/';
                                console.log('‚úÖ‚úÖ‚úÖ FORMULARIO PRINCIPAL CONFIGURADO PARA MULTIMEDIA');
                                console.log('üîß Action del formulario establecido a:', mainForm.action);
                            }
                            
                            console.log('‚úÖ Contenedor multimedia configurado correctamente');
                            console.log('üîß Contenedor visible:', multimediaContainer.offsetParent !== null);
                            console.log('üîß Contenedor en DOM:', !!multimediaContainer.parentNode);
                        } else {
                            console.error('‚ùå‚ùå‚ùå No se encontr√≥ el contenedor multimedia despu√©s de cargar HTML');
                            // Debugging adicional
                            console.log('üîç Todos los elementos con data-form-type:');
                            const elementsWithFormType = document.querySelectorAll('[data-form-type]');
                            elementsWithFormType.forEach((el, index) => {
                                console.log(`üìã Elemento ${index}:`, el.getAttribute('data-form-type'), el.tagName, el);
                            });
                            
                            console.log('üîç Todos los elementos con ID en formularioEspecifico:');
                            const elementsWithId = formularioEspecifico.querySelectorAll('[id]');
                            elementsWithId.forEach((el, index) => {
                                console.log(`üÜî Elemento ${index}:`, el.id, el.tagName, el);
                            });
                        }
                    }, 200); // Aumentar timeout a 200ms para mejor compatibilidad
                    
                    // Ocultar el modal de confirmaci√≥n gen√©rico ya que multimedia tiene su propio modal
                    const contenedorModal = document.getElementById('contenedor-modal-confirmacion');
                    if (contenedorModal) {
                        contenedorModal.style.display = 'none';
                        console.log('üîß Modal de confirmaci√≥n gen√©rico ocultado para multimedia');
                    }
                    
                    // üéØ CR√çTICO: Inicializar funcionalidad carrera-materia DESPU√âS de cargar HTML
                    setTimeout(() => {
                        initCarreraMateriaFunctionality();
                            initMultimediaFunctionality(); // Inicializar funcionalidad del bot√≥n '+'
                        
                        // Verificar nuevamente el formulario despu√©s de la inicializaci√≥n
                        let formAfterInit = document.getElementById('form_alta_multimedia');
                        if (!formAfterInit) {
                            formAfterInit = formularioEspecifico.querySelector('#form_alta_multimedia') ||
                                          formularioEspecifico.querySelector('form[data-form-id="multimedia"]');
                        }
                        console.log('üîç Formulario despu√©s de inicializaci√≥n:', !!formAfterInit);
                        if (formAfterInit) {
                            console.log('‚úÖ Formulario disponible y listo para env√≠o');
                        }
                    }, 250); // Aumentar delay para asegurar que el DOM est√© completamente listo
                    
                    // No mostrar carga masiva ni URL para multimedia
                    if (uploadSimple) uploadSimple.style.display = 'none';
                    if (uploadBox) uploadBox.style.display = 'none';
                            console.log('‚úÖ Formulario de multimedia cargado');

                            // Definir globalmente la funci√≥n de cancelar con alerta de vaciar campos
                            window.cancelarFormularioMultimedia = function() {
                                try {
                                    if (typeof mostrarModalAlerta === 'function') {
                                        mostrarModalAlerta(function() {
                                            const form = document.getElementById('form_alta_multimedia') ||
                                                         formularioEspecifico.querySelector('#form_alta_multimedia') ||
                                                         formularioEspecifico.querySelector('form[data-form-id="multimedia"]');
                                            if (form) form.reset();
                                            const contTipos = document.getElementById('contenedor-tipos-multimedia') ||
                                                              formularioEspecifico.querySelector('#contenedor-tipos-multimedia');
                                            if (contTipos) contTipos.innerHTML = '';
                                            const contEjs = document.getElementById('contenedor-ejemplares-multimedia') ||
                                                            formularioEspecifico.querySelector('#contenedor-ejemplares-multimedia');
                                            if (contEjs) contEjs.innerHTML = '';
                                            if (window.gruposTiposMultimedia) window.gruposTiposMultimedia = [];
                                            console.log('‚úÖ Multimedia vaciado tras confirmar en alerta');
                                        });
                                    } else {
                                        // Fallback sin modal
                                        const form = document.getElementById('form_alta_multimedia');
                                        if (form) form.reset();
                                        const contTipos = document.getElementById('contenedor-tipos-multimedia');
                                        if (contTipos) contTipos.innerHTML = '';
                                        const contEjs = document.getElementById('contenedor-ejemplares-multimedia');
                                        if (contEjs) contEjs.innerHTML = '';
                                        if (window.gruposTiposMultimedia) window.gruposTiposMultimedia = [];
                                        console.warn('‚ö†Ô∏è mostrarModalAlerta no disponible; vaciado sin modal');
                                    }
                                } catch (e) {
                                    console.error('‚ùå Error en cancelarFormularioMultimedia:', e);
                                }
                            };
                        })
                        .catch(error => {
                            console.error('‚ùå Error cargando multimedia:', error);
                            formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                            buttonsContainer.style.display = 'none';
                        });
                }
        else if (tipo === 'notebook') {
            console.log('üíª Cargando formulario de notebook...');
            fetch('/formulario/notebook/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    
                    // üî• IMPORTANTE: Establecer el action correcto para notebook
                    const form = document.getElementById('form_alta_material');
                    if (form) {
                        form.action = '{% url "confirmacion_alta_notebook" %}';
                        console.log('üîß Action del formulario notebook establecido a:', form.action);
                    }
                    
                    // Ocultar el modal de confirmaci√≥n gen√©rico ya que notebook tiene su propio modal
                    const contenedorModal = document.getElementById('contenedor-modal-confirmacion');
                    if (contenedorModal) {
                        contenedorModal.style.display = 'none';
                        console.log('üîß Modal de confirmaci√≥n gen√©rico ocultado para notebook');
                    }
                    
                    // No mostrar carga masiva ni URL para notebook
                    if (uploadSimple) uploadSimple.style.display = 'none';
                    if (uploadBox) uploadBox.style.display = 'none';

                    // Vincular bot√≥n CANCELAR al modal de vaciar campos
                    wireCancelButton(formularioEspecifico);
                    
                    // üéØ CR√çTICO: Inicializar funcionalidad din√°mica DESPU√âS de cargar HTML
                    setTimeout(() => {
                        initNotebookDynamicFunctionality();
                    }, 100); // Peque√±o delay para asegurar que el DOM est√© listo
                    
                    console.log('‚úÖ Formulario de notebook cargado');
                })
                .catch(error => {
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else if (tipo === 'proyector') {
            console.log('üìΩÔ∏è Cargando formulario de proyector...');
            fetch('/formulario/proyector/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    // No mostrar carga masiva ni URL para proyector
                    if (uploadSimple) uploadSimple.style.display = 'none';
                    if (uploadBox) uploadBox.style.display = 'none';

                    // Vincular bot√≥n CANCELAR al modal de vaciar campos
                    wireCancelButton(formularioEspecifico);
                    
                    // Configurar la acci√≥n del formulario para proyector
                    const form = document.getElementById('form_alta_material');
                    if (form) {
                        form.action = '{% url "confirmacion_alta_proyector" %}';
                        console.log('‚úÖ Acci√≥n del formulario configurada para proyector:', form.action);
                    }
                    
                    // üéØ CR√çTICO: Inicializar funcionalidad din√°mica DESPU√âS de cargar HTML
                    setTimeout(() => {
                        initProyectorDynamicFunctionality();
                    }, 100); // Peque√±o delay para asegurar que el DOM est√© listo
                    
                    console.log('‚úÖ Formulario de proyector cargado');
                })
                .catch(error => {
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else if (tipo === 'varios') {
            console.log('üì¶ Cargando formulario de varios...');
            fetch('/formulario/varios/')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el formulario.');
                    return response.text();
                })
                .then(html => {
                    formularioEspecifico.innerHTML = html;
                    buttonsContainer.style.display = 'flex';
                    // No mostrar carga masiva ni URL para varios
                    if (uploadSimple) uploadSimple.style.display = 'none';
                    if (uploadBox) uploadBox.style.display = 'none';

                    // Vincular bot√≥n CANCELAR al modal de vaciar campos
                    wireCancelButton(formularioEspecifico);
                    
                    // üéØ CR√çTICO: Inicializar funcionalidad carrera-materia DESPU√âS de cargar HTML
                    setTimeout(() => {
                        initCarreraMateriaFunctionality();
                        initVariosFunctionality(); // Inicializar funcionalidad del bot√≥n '+' para varios
                        
                        // üî• AGREGAR EVENT LISTENER DE SUBMIT PARA VARIOS
                        const form = document.getElementById('form_alta_material');
                        if (form) {
                            // Verificar si ya tiene el event listener para evitar duplicados
                            if (!form.hasAttribute('data-varios-submit-listener')) {
                                form.addEventListener('submit', function(e) {
                                    console.log('üöÄ SUBMIT VARIOS - Interceptando env√≠o del formulario');
                                    e.preventDefault(); // Prevenir env√≠o autom√°tico
                                    
                                    // Llamar a prepararEnvioFormulario para serializar los datos
                                    if (typeof prepararEnvioFormulario === 'function') {
                                        console.log('üì§ Llamando a prepararEnvioFormulario...');
                                        prepararEnvioFormulario();
                                    } else {
                                        console.error('‚ùå Funci√≥n prepararEnvioFormulario no encontrada');
                                    }
                                    
                                    // Ahora enviar el formulario normalmente
                                    console.log('üì§ Enviando formulario de varios...');
                                    // Remover temporalmente el event listener para evitar loop infinito
                                    form.removeAttribute('data-varios-submit-listener');
                                    form.submit();
                                });
                                
                                // Marcar que ya tiene el event listener
                                form.setAttribute('data-varios-submit-listener', 'true');
                                console.log('‚úÖ Event listener de submit agregado al formulario de varios');
                            } else {
                                console.log('‚ÑπÔ∏è Event listener de submit ya existe para varios');
                            }
                            // === VARIOS: manejar reducci√≥n en la cantidad EST√ÅTICA (grupo 0) ===
                            if (typeof window.gruposTiposVariosNuevo === 'undefined') {
                                window.gruposTiposVariosNuevo = [];
                            }
                            const tipoStatic = formularioEspecifico.querySelector('#tipo-varios') || document.getElementById('tipo-varios');
                            const cantStatic = formularioEspecifico.querySelector('#cant_ejemplares') || document.getElementById('cant_ejemplares');
                            const hiddenJson = formularioEspecifico.querySelector('#gruposTiposVariosNuevo') || document.getElementById('gruposTiposVariosNuevo');

                            const syncStaticGroup = function() {
                                const tipo = (tipoStatic?.value || '').trim();
                                const cantidad = parseInt(cantStatic?.value) || 1;
                                window.gruposTiposVariosNuevo[0] = { tipo, cantidad };
                                if (hiddenJson) hiddenJson.value = JSON.stringify(window.gruposTiposVariosNuevo);
                            };

                            // Inicializar estado y listeners
                            syncStaticGroup();
                            if (tipoStatic) {
                                tipoStatic.addEventListener('input', syncStaticGroup);
                            }
                            if (cantStatic) {
                                const inicial = parseInt(cantStatic.getAttribute('data-valor-anterior') || cantStatic.value || '1', 10);
                                cantStatic.setAttribute('data-valor-anterior', String(inicial));
                                const manejarReduccionStatic = function() {
                                    const prev = parseInt(cantStatic.getAttribute('data-valor-anterior') || '1', 10);
                                    const nuevo = parseInt(cantStatic.value || '1', 10);
                                    const aplicar = function() {
                                        cantStatic.setAttribute('data-valor-anterior', String(nuevo));
                                        syncStaticGroup();
                                    };
                                    if (nuevo < prev) {
                                        if (typeof mostrarModalReducirEjemplares === 'function') {
                                            mostrarModalReducirEjemplares(aplicar, function() { cantStatic.value = String(prev); });
                                        } else {
                                            if (confirm('Reducir la cantidad eliminar√° datos de ejemplares adicionales. ¬øConfirmar?')) {
                                                aplicar();
                                            } else {
                                                cantStatic.value = String(prev);
                                            }
                                        }
                                    } else {
                                        aplicar();
                                    }
                                };
                                cantStatic.addEventListener('input', manejarReduccionStatic);
                                cantStatic.addEventListener('change', manejarReduccionStatic);
                            }
                        }
                    }, 100); // Peque√±o delay para asegurar que el DOM est√© listo
                    
                    // Configurar la acci√≥n del formulario para varios
                    const form = document.getElementById('form_alta_material');
                    if (form) {
                        form.action = '{% url "confirmacion_alta_varios" %}';
                        console.log('‚úÖ Acci√≥n del formulario configurada para varios:', form.action);
                    }
                    console.log('‚úÖ Formulario de varios cargado');
                })
                .catch(error => {
                    formularioEspecifico.innerHTML = `<p class="text-danger">Error al cargar el formulario: ${error.message}</p>`;
                    buttonsContainer.style.display = 'none';
                });
        } 
        else {
            console.log('‚ùå Sin selecci√≥n o tipo no reconocido');
            formularioEspecifico.innerHTML = '';
            buttonsContainer.style.display = 'none';
            if (uploadSimple) uploadSimple.style.display = 'none';
            if (uploadBox) uploadBox.style.display = 'none';
        }
    });

// Funci√≥n para inicializar la funcionalidad din√°mica del proyector
function initProyectorDynamicFunctionality() {
    console.log('üéØ Inicializando funcionalidad din√°mica del proyector...');
    
    const cantEjemplaresProyector = document.getElementById('cant_ejemplares');
    const contenedorEjemplaresProyector = document.getElementById('contenedor-ejemplares-proyector');
    
    if (cantEjemplaresProyector && contenedorEjemplaresProyector) {
        console.log('‚úÖ Elementos encontrados para proyector...');
        
        // Funci√≥n para generar campos din√°micos id√©nticos a notebook
        function generarCamposProyector() {
            const cantidad = parseInt(cantEjemplaresProyector.value) || 1;
            let html = '';
            
            for (let i = 1; i <= cantidad; i++) {
                html += `
                <!-- L√≠nea punteada -->
                <div style="
                    background: repeating-linear-gradient(
                        to right,
                        #8B1D69 0px,
                        #8B1D69 10px,
                        transparent 10px,
                        transparent 30px
                    );
                    height: 3px;
                    margin: 25px 0;
                    width: 100%;
                "></div>
                <div class="row mb-2">
                    <div class="col-md-3">
                        <label for="num_registro_${i}" style="font-size: 14px;">N¬∞ de registro<span style="color: #dc3545; font-weight: bold;">*</span>:</label>
                        <input type="text" class="form-control" id="num_registro_${i}" name="num_registro_${i}" required placeholder="N¬∞ de registro...">
                    </div>
                    <div class="col-md-3">
                        <label for="modelo_pro_${i}" style="font-size: 14px;">Modelo:</label>
                                <input type="text" class="form-control" id="modelo_pro_${i}" name="modelo_pro_${i}" placeholder="Modelo..." />
                    </div>
                </div>`;
            }
            contenedorEjemplaresProyector.innerHTML = html;
        }
        // Inicializar valor anterior
        const valorInicial = parseInt(cantEjemplaresProyector.value || '1', 10);
        cantEjemplaresProyector.setAttribute('data-valor-anterior', valorInicial);

        // Handler con alerta para reducci√≥n
        const manejarCambioCantidadProyector = function() {
            const prev = parseInt(cantEjemplaresProyector.getAttribute('data-valor-anterior') || valorInicial, 10);
            const nuevo = parseInt(cantEjemplaresProyector.value || '1', 10);
            if (nuevo < prev) {
                mostrarModalReducirEjemplares(
                    function() {
                        cantEjemplaresProyector.setAttribute('data-valor-anterior', nuevo);
                        generarCamposProyector();
                    },
                    function() {
                        cantEjemplaresProyector.value = prev;
                    }
                );
            } else {
                cantEjemplaresProyector.setAttribute('data-valor-anterior', nuevo);
                generarCamposProyector();
            }
        };

        // Event listeners para cambios din√°micos con alerta
        cantEjemplaresProyector.addEventListener('input', manejarCambioCantidadProyector);
        cantEjemplaresProyector.addEventListener('change', manejarCambioCantidadProyector);

        // Generar campos iniciales
        generarCamposProyector();
        
        console.log('‚úÖ Funcionalidad din√°mica del proyector inicializada correctamente');
    } else {
        console.error('‚ùå No se encontraron los elementos necesarios para la funcionalidad din√°mica');
        console.log('cantEjemplaresProyector:', cantEjemplaresProyector);
        console.log('contenedorEjemplaresProyector:', contenedorEjemplaresProyector);
    }
}

// Funci√≥n para inicializar la funcionalidad din√°mica del notebook
function initNotebookDynamicFunctionality() {
    console.log('üíª Inicializando funcionalidad din√°mica del notebook...');
    
    const cantEjemplaresNotebook = document.getElementById('cant_ejemplares');
    const contenedorEjemplaresNotebook = document.getElementById('contenedor-ejemplares-notebook');
    
    if (cantEjemplaresNotebook && contenedorEjemplaresNotebook) {
        console.log('‚úÖ Elementos encontrados, configurando eventos...');
        // Inicializar valor anterior
        const valorInicial = parseInt(cantEjemplaresNotebook.value || '1', 10);
        cantEjemplaresNotebook.setAttribute('data-valor-anterior', valorInicial);

        // Handler con alerta para reducci√≥n
        const manejarCambioCantidadNotebook = function () {
            const prev = parseInt(cantEjemplaresNotebook.getAttribute('data-valor-anterior') || valorInicial, 10);
            const nuevo = parseInt(cantEjemplaresNotebook.value || '1', 10);
            if (nuevo < prev) {
                mostrarModalReducirEjemplares(
                    function() {
                        cantEjemplaresNotebook.setAttribute('data-valor-anterior', nuevo);
                        if (typeof window.updateRowsMaterial === 'function') {
                            window.updateRowsMaterial('notebook');
                        }
                    },
                    function() {
                        cantEjemplaresNotebook.value = prev;
                    }
                );
            } else {
                cantEjemplaresNotebook.setAttribute('data-valor-anterior', nuevo);
                if (typeof window.updateRowsMaterial === 'function') {
                    window.updateRowsMaterial('notebook');
                }
            }
        };

        cantEjemplaresNotebook.addEventListener('input', manejarCambioCantidadNotebook);
        cantEjemplaresNotebook.addEventListener('change', manejarCambioCantidadNotebook);

        // Llamar inicialmente para generar campos si ya hay un valor
        if (cantEjemplaresNotebook.value && cantEjemplaresNotebook.value > 0) {
            console.log('üîÑ Generando campos iniciales para cantidad:', cantEjemplaresNotebook.value);
            if (typeof window.updateRowsMaterial === 'function') {
                window.updateRowsMaterial('notebook');
            }
        }
        
        console.log('‚úÖ Funcionalidad din√°mica del notebook inicializada correctamente');
    } else {
        console.error('‚ùå No se encontraron los elementos necesarios para la funcionalidad din√°mica del notebook');
        console.log('cantEjemplaresNotebook:', cantEjemplaresNotebook);
        console.log('contenedorEjemplaresNotebook:', contenedorEjemplaresNotebook);
    }
}

// FUNCIONALIDAD AGREGADA: Mostrar nombre del archivo seleccionado y abrir confirmaci√≥n CSV
    const cargarArchivo = document.getElementById('cargar_archivo');
    const nombreArchivo = document.getElementById('nombre_archivo_carga_simple');
    
    if (cargarArchivo && nombreArchivo) {
        cargarArchivo.addEventListener('change', function() {
            const file = this.files && this.files[0] ? this.files[0] : null;
            if (file) {
                nombreArchivo.textContent = file.name;
                // Mostrar modal de confirmaci√≥n CSV/Excel con validaciones dentro
                if (typeof mostrarModalCSV === 'function') {
                    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || '';
                    mostrarModalCSV(
                        file.name,
                        function onConfirm() {
                            try {
                                setUploadLoaderVisible(true);
                                var loadingModal = new bootstrap.Modal(document.getElementById('modal-cargando-csv'), { backdrop: 'static', keyboard: false });
                                loadingModal.show();
                                const fd = new FormData();
                                fd.append('csv_file', file);
                                fetch('/cargar-csv/', {
                                    method: 'POST',
                                    headers: {
                                        'X-CSRFToken': csrfToken,
                                    },
                                    body: fd,
                                    credentials: 'same-origin',
                                })
                                .then(async (resp) => {
                                    const text = await resp.text();
                                    const status = resp.status;
                                    // Si el backend indica archivo no v√°lido
                                    if (text && text.includes('El archivo no es un CSV')) {
                                        if (typeof mostrarModalArchivoNoValido === 'function') {
                                            mostrarModalArchivoNoValido();
                                        }
                                        return;
                                    }

                                    // √âxito: 200-399 (aceptar redirects tambi√©n)
                                    if (status >= 200 && status < 400) {
                                        var modal = new bootstrap.Modal(document.getElementById('modal-exito-carga'), { backdrop: 'static', keyboard: false });
                                        modal.show();
                                        var btn = document.getElementById('btn-aceptar-exito');
                                        if(btn){ btn.onclick = function(){ window.location.href = 'http://127.0.0.1:8000/alta/'; }; }
                                        return;
                                    }

                                    throw new Error('Error subiendo CSV');
                                })
                                .catch((err) => {
                                    console.error('‚ùå Error al subir CSV:', err);
                                    if (typeof mostrarModalErrorSeleccionado === 'function') {
                                        mostrarModalErrorSeleccionado();
                                    }
                                })
                                .finally(function(){ setUploadLoaderVisible(false); try { loadingModal.hide(); } catch(e){} });
                            } catch (e) {
                                setUploadLoaderVisible(false);
                                try { var _m = bootstrap.Modal.getInstance(document.getElementById('modal-cargando-csv')); if(_m) _m.hide(); } catch(ex){}
                                console.error('‚ùå Excepci√≥n al preparar upload CSV:', e);
                                if (typeof mostrarModalErrorSeleccionado === 'function') {
                                    mostrarModalErrorSeleccionado();
                                }
                            }
                        },
                        function onCancel() {
                            // Si se cancela, limpiar la selecci√≥n visible
                            nombreArchivo.textContent = '';
                            cargarArchivo.value = '';
                        },
                        file
                    );
                } else {
                    console.warn('mostrarModalCSV no est√° disponible');
                }
            } else {
                nombreArchivo.textContent = '';
            }
        });
    }

    // üéØ FUNCI√ìN PARA INICIALIZAR CARRERA-MATERIA (para programa y multimedia)
    function initCarreraMateriaFunctionality() {
        // Buscar elementos por ambos posibles IDs (para compatibilidad con diferentes formularios)
        const carreraSelect = document.getElementById('id_carrera') || document.getElementById('carrera');
        const materiaSelect = document.getElementById('id_materia') || document.getElementById('materia');
        
        console.log('üéØ Inicializando carrera-materia...', !!carreraSelect, !!materiaSelect);
        
        if (!carreraSelect || !materiaSelect) {
            console.log('‚ö†Ô∏è Elementos carrera-materia no encontrados');
            return;
        }
        
        // Materias por carrera - ID√âNTICO al primer archivo
        const materiasPorCarrera = {
            'Profesorado de Educaci√≥n Inicial': [
                "An√°lisis del Mundo Contempor√°neo",
                "Ateneo de Naturaleza y Sociedad",
                "Ateneo de Matem√°tica",
                "Ateneo de Nuevas Expresiones Est√©ticas",
                "Ateneo de Pr√°cticas del Lenguaje y la Literatura",
                "Corporeidad y Motricidad",
                "Cultura, Comunicaci√≥n y Educaci√≥n",
                "Did√°ctica de la Matem√°tica",
                "Did√°ctica de las Ciencias Naturales",
                "Did√°ctica de las Ciencias Sociales",
                "Did√°ctica de las Pr√°cticas del Lenguaje y la Literatura",
                "Did√°ctica General",
                "Did√°ctica y Curriculum de Nivel Inicial",
                "Dimensi√≥n √âtico-Pol√≠tica de la Praxis Docente",
                "Educaci√≥n en y para la Salud",
                "Educaci√≥n F√≠sica Escolar",
                "Educaci√≥n Musical",
                "Educaci√≥n Pl√°stica",
                "Educaci√≥n Temprana",
                "Filosof√≠a",
                "Historia y Prospectiva de la Educaci√≥n",
                "Juego y Desarrollo Infantil",
                "Medios Audiovisuales, TICs y Educaci√≥n",
                "Pedagog√≠a",
                "Pol√≠tica, Legislaci√≥n y Administraci√≥n del Trabajo Escolar",
                "Pr√°ctica Docente 1",
                "Pr√°ctica Docente 2",
                "Pr√°ctica Docente 3",
                "Pr√°ctica Docente 4",
                "Psicolog√≠a del Desarrollo y el Aprendizaje 1",
                "Psicolog√≠a del Desarrollo y el Aprendizaje 2",
                "Psicolog√≠a Social e Institucional",
                "Reflexi√≥n Filos√≥fica de la Educaci√≥n",
                "Taller de Ciencias Naturales",
                "Taller de Ciencias Sociales",
                "Taller de Definici√≥n Institucional",
                "Taller de Lectura, Escritura y Oralidad (LEO)",
                "Taller de Literatura Infantil",
                "Taller de la Matem√°tica",
                "Taller de Materiales y Objetos L√∫dicos",
                "Taller de Pensamiento L√≥gico Matem√°tico",
                "Teor√≠as Sociopol√≠ticas y Educaci√≥n",
                "Trayectos Formativos Opcionales"
            ],
            'Profesorado de Educaci√≥n Primaria': [
                "An√°lisis del Mundo Contempor√°neo",
                "Arte y Educaci√≥n",
                "Ateneo de Ciencias Naturales",
                "Ateneo de Ciencias Sociales",
                "Ateneo de Matem√°tica",
                "Ateneo de Pr√°cticas del Lenguaje y la Literatura",
                "Configuraciones Culturales del Sujeto Educativo de Primaria",
                "Corporeidad y Motricidad",
                "Cultura, Comunicaci√≥n y Educaci√≥n",
                "Did√°ctica de la Matem√°tica 1",
                "Did√°ctica de la Matem√°tica 2",
                "Did√°ctica de las Ciencias Naturales 1",
                "Did√°ctica de las Ciencias Naturales 2",
                "Did√°ctica de las Ciencias Sociales 1",
                "Did√°ctica de las Ciencias Sociales 2",
                "Did√°ctica de Pr√°cticas del Lenguaje y la Literatura 1",
                "Did√°ctica de Pr√°cticas del Lenguaje y la Literatura 2",
                "Did√°ctica General",
                "Did√°ctica y Curriculum de Nivel Primario",
                "Dimensi√≥n √âtico-Pol√≠tica de la Praxis Docente",
                "Educaci√≥n Art√≠stica",
                "Educaci√≥n F√≠sica Escolar",
                "Filosof√≠a",
                "Historia y Prospectiva de la Educaci√≥n",
                "Medios Audiovisuales, TICs y Educaci√≥n",
                "Pedagog√≠a",
                "Pedagog√≠a Cr√≠tica de las Diferencias",
                "Pol√≠tica, Legislaci√≥n y Administraci√≥n del Trabajo Escolar",
                "Pr√°ctica Docente 1",
                "Pr√°ctica Docente 2",
                "Pr√°ctica Docente 3",
                "Pr√°ctica Docente 4",
                "Psicolog√≠a del Desarrollo y el Aprendizaje 1",
                "Psicolog√≠a del Desarrollo y el Aprendizaje 2",
                "Psicolog√≠a Social e Institucional",
                "Reflexi√≥n Filos√≥fica de la Educaci√≥n",
                "Taller de Definici√≥n Institucional",
                "Taller de Lectura, Escritura y Oralidad (LEO)",
                "Taller de Pensamiento L√≥gico Matem√°tico",
                "Teor√≠as Sociopol√≠ticas y Educaci√≥n",
                "Trayectos Formativos Opcionales"
            ],
            'Profesorado de Educaci√≥n Secundaria en Geograf√≠a': [
                "Antropolog√≠a",
                "Cartograf√≠a",
                "Cartograf√≠a Digital",
                "Cultura Digital y Educaci√≥n",
                "Derechos, Interculturalidad y Ciudadan√≠a",
                "Did√°ctica de la Geograf√≠a",
                "Did√°ctica de las Ciencias Sociales",
                "Did√°ctica y Curriculum",
                "Econom√≠a Pol√≠tica",
                "Educaci√≥n Sexual Integral (ESI)",
                "Educaci√≥n y Transformaciones Sociales Contempor√°neas",
                "Ense√±anza de la Geograf√≠a",
                "Espacio de Opci√≥n Institucional (EOI)",
                "Geograf√≠a Ambiental",
                "Geograf√≠a Ambiental de Am√©rica Latina",
                "Geograf√≠a Ambiental de Argentina",
                "Geograf√≠a Cultural",
                "Geograf√≠a de G√©nero",
                "Geograf√≠a Econ√≥mica y Social Argentina",
                "Geograf√≠a Pol√≠tica y Geopol√≠tica",
                "Geograf√≠a Rural",
                "Geograf√≠a Social",
                "Geograf√≠a Social de Am√©rica Latina",
                "Geograf√≠a Urbana",
                "Historia de los Modelos Econ√≥micos de Argentina",
                "Historia Social General",
                "Introducci√≥n a las Ciencias Sociales y a la Geograf√≠a",
                "Organizaci√≥n Econ√≥mica del Espacio",
                "Pedagog√≠a",
                "Pr√°ctica Docente 1",
                "Pr√°ctica Docente 2",
                "Pr√°ctica Docente 3",
                "Pr√°ctica Docente 4",
                "Problemas Ambientales Locales/Regionales: La Investigaci√≥n en el Aula",
                "Problemas Filos√≥ficos de la Educaci√≥n",
                "Pol√≠tica Educativa Argentina",
                "Psicolog√≠a del Aprendizaje",
                "Reflexi√≥n Filos√≥fico-Pol√≠tica de la Pr√°ctica Docente",
                "Sociolog√≠a",
                "Teor√≠a y Metodolog√≠a en Geograf√≠a",
                "Trayectorias Educativas de J√≥venes y Adultos",
                "Unidades Curriculares Optativas"
            ],
            'Profesorado de Educaci√≥n Secundaria en Ciencias Pol√≠ticas': [
                "An√°lisis de las Instituciones Educativas",
                "Antropolog√≠a",
                "Cultura Digital y Educaci√≥n",
                "Derecho",
                "Derechos Humanos y Ciudadan√≠a",
                "Derechos, Interculturalidad y Ciudadan√≠a",
                "Did√°ctica de la Ciencia Pol√≠tica",
                "Did√°ctica de las Ciencias Sociales",
                "Did√°ctica y Curriculum",
                "Econom√≠a Pol√≠tica",
                "Educaci√≥n y Transformaciones Sociales Contempor√°neas",
                "Educaci√≥n Sexual Integral (ESI)",
                "Espacio de Opci√≥n Institucional (EOI)",
                "Estado, Administraci√≥n y Pol√≠ticas P√∫blicas",
                "Estado y Pol√≠tica de G√©nero",
                "Fundamentos de Ciencia Pol√≠tica",
                "Geograf√≠a",
                "Historia Argentina",
                "Historia Latinoamericana",
                "Historia Mundial",
                "Investigaci√≥n en la Ense√±anza de la Ciencia Pol√≠tica",
                "Opini√≥n P√∫blica, Medios y Pol√≠tica",
                "Pedagog√≠a",
                "Pensamiento Pol√≠tico Pedag√≥gico Latinoamericano",
                "Pol√≠tica Educativa Argentina",
                "Pr√°ctica Docente 1",
                "Pr√°ctica Docente 2",
                "Pr√°ctica Docente 3",
                "Pr√°ctica Docente 4",
                "Problemas Filos√≥ficos de la Educaci√≥n",
                "Problem√°tica y Pol√≠tica Ambiental",
                "Psicolog√≠a del Aprendizaje",
                "Reflexi√≥n Filos√≥fico-Pol√≠tica de la Pr√°ctica Docente",
                "Sistemas Pol√≠ticos Comparados",
                "Sociolog√≠a",
                "Teor√≠a de las Relaciones Internacionales y Pol√≠tica Internacional",
                "Teor√≠a Pol√≠tica 1",
                "Teor√≠a Pol√≠tica 2",
                "Teor√≠a Pol√≠tica 3",
                "Teor√≠a y Derecho Constitucional",
                "Unidades Curriculares Optativas"
            ],
            'Tecnicatura Superior en An√°lisis de Sistemas': [
                "√Ålgebra",
                "Algoritmos y estructuras de datos 1",
                "Algoritmos y estructuras de datos 2",
                "Algoritmos y estructuras de datos 3",
                "An√°lisis Matem√°tico 1",
                "An√°lisis Matem√°tico 2",
                "Arquitectura de Computadores",
                "Aspectos legales de la Profesi√≥n",
                "Base de Datos",
                "Ciencia, Tecnolog√≠a y Sociedad",
                "Estad√≠stica",
                "Ingenier√≠a de Software 1",
                "Ingenier√≠a de Software 2",
                "Ingl√©s 1",
                "Ingl√©s 2",
                "Ingl√©s 3",
                "Pr√°cticas Profesionalizantes 1",
                "Pr√°cticas Profesionalizantes 2",
                "Pr√°cticas Profesionalizantes 3",
                "Redes y Comunicaciones",
                "Seminario de actualizaci√≥n",
                "Sistemas Operativos",
                "Sistemas y Organizaciones"
            ],
            'Tecnicatura Superior en Enfermer√≠a': [
                "Aspectos Bio√©ticos y Legales de la Profesi√≥n",
                "Biolog√≠a Humana",
                "Comunicaci√≥n en Ciencias de la Salud",
                "Condiciones y Medio Ambiente del Trabajo",
                "Cuidados de la Salud Centrados en la Comunidad y la Familia",
                "Enfermer√≠a Comunitaria y Pr√°cticas Educativas en Salud",
                "Enfermer√≠a del Adulto y del Adulto Mayor I",
                "Enfermer√≠a del Adulto y el Adulto Mayor II",
                "Enfermer√≠a en Emergencias y Cat√°strofes",
                "Enfermer√≠a en Salud Mental",
                "Enfermer√≠a Materno Infantil",
                "Farmacolog√≠a en Enfermer√≠a",
                "Fundamentos del Cuidado",
                "Ingl√©s",
                "Introducci√≥n a la Metodolog√≠a de Investigaci√≥n en Salud",
                "Nutrici√≥n y Dietoterapia",
                "Organizaci√≥n y Gesti√≥n de Servicios de Enfermer√≠a",
                "Pr√°cticas Profesionalizantes 1",
                "Pr√°cticas Profesionalizantes 2",
                "Pr√°cticas Profesionalizantes 3",
                "Psicolog√≠a",
                "Salud P√∫blica 1",
                "Salud P√∫blica 2",
                "Teor√≠as Socioculturales de la Salud"
            ],
            'Tecnicatura Superior en Acompa√±amiento Terap√©utico': [
                "Acompa√±amiento Terap√©utico del Adulto y Adulto Mayor",
                "Acompa√±amiento Terap√©utico en la Ni√±ez y Adolescencia",
                "Acompa√±amiento Terap√©utico",
                "Contextualizaci√≥n del Campo Profesional del Acompa√±amiento Terap√©utico",
                "√âtica",
                "Fundamentos de Psicolog√≠a General y de Intervenci√≥n Sociocomunitaria",
                "Ingl√©s",
                "Intervenci√≥n Comunitaria y Recursos Sociales",
                "Investigaci√≥n en Salud",
                "Modalidades de Intervenci√≥n en el Acompa√±amiento Terap√©utico",
                "Modelo de Ocupaci√≥n Humana",
                "Organizaci√≥n y Gesti√≥n de los Servicios de Salud Mental",
                "Pr√°cticas Profesionalizantes I",
                "Pr√°cticas Profesionalizantes II",
                "Pr√°cticas Profesionalizantes III",
                "Principios M√©dicos y de Psicofarmacolog√≠a",
                "Psicofarmacolog√≠a",
                "Psicolog√≠a de los Ciclos Vitales",
                "Psicolog√≠a de Grupos",
                "Psicopatolog√≠a",
                "Salud P√∫blica y Salud Mental",
                "Sistemas Familiares"
            ],
            'Tecnicatura Superior en Higiene y Seguridad en el Trabajo': [
                "Administraci√≥n de las Organizaciones",
                "Capacitaci√≥n de Personal",
                "Comunicaci√≥n y Administraci√≥n de Medios",
                "Control de la Contaminaci√≥n",
                "Derecho del Trabajo",
                "Ergonom√≠a",
                "Estad√≠stica",
                "F√≠sica 1",
                "F√≠sica 2",
                "Higiene Laboral y Medio Ambiente 1",
                "Higiene Laboral y Medio Ambiente 2",
                "Ingl√©s T√©cnico",
                "Medicina del Trabajo 1",
                "Medicina del Trabajo 2",
                "Medios de Representaci√≥n",
                "Pr√°ctica Profesionalizante 1",
                "Pr√°ctica Profesionalizante 2",
                "Pr√°ctica Profesionalizante 3",
                "Psicolog√≠a Laboral",
                "Qu√≠mica 1",
                "Qu√≠mica 2",
                "Seguridad 1",
                "Seguridad 2",
                "Seguridad 3"
            ]
        };
        
        // Funci√≥n para cargar materias seg√∫n la carrera seleccionada
        function cargarMaterias(carreraSeleccionada) {
            console.log('üìö Carrera seleccionada:', carreraSeleccionada);
            
            // Limpiar opciones de materia
            materiaSelect.innerHTML = '';
            
            if (carreraSeleccionada && materiasPorCarrera[carreraSeleccionada]) {
                // Agregar opci√≥n vac√≠a
                const opcionVacia = document.createElement('option');
                opcionVacia.value = '';
                opcionVacia.textContent = 'Seleccione una materia';
                materiaSelect.appendChild(opcionVacia);
                
                // Agregar materias de la carrera seleccionada
                materiasPorCarrera[carreraSeleccionada].forEach(function(materia) {
                    const option = document.createElement('option');
                    option.value = materia;
                    option.textContent = materia;
                    materiaSelect.appendChild(option);
                });
                
                materiaSelect.disabled = false;
                console.log('‚úÖ Materias cargadas:', materiasPorCarrera[carreraSeleccionada].length);
            } else {
                // No hay carrera seleccionada o no tiene materias
                const opcionVacia = document.createElement('option');
                opcionVacia.value = '';
                opcionVacia.textContent = 'Primero seleccione una carrera';
                materiaSelect.appendChild(opcionVacia);
                materiaSelect.disabled = true;
                console.log('‚ö†Ô∏è No hay materias para:', carreraSeleccionada);
            }
        }
        
        // Event listener para cambio de carrera
        carreraSelect.addEventListener('change', function() {
            cargarMaterias(this.value);
        });
        
        // Inicializar estado de materia
        materiaSelect.disabled = true;
        
        // Si ya hay una carrera seleccionada al cargar (por ejemplo, por validaci√≥n de errores)
        if (carreraSelect.value) {
            cargarMaterias(carreraSelect.value);
        }
        function cargarMaterias(carreraSeleccionada) {
            console.log('üìö Carrera seleccionada:', carreraSeleccionada);
            
            // Limpiar opciones de materia
            materiaSelect.innerHTML = '';
            
            if (carreraSeleccionada && materiasPorCarrera[carreraSeleccionada]) {
                // Agregar opci√≥n vac√≠a
                const opcionVacia = document.createElement('option');
                opcionVacia.value = '';
                opcionVacia.textContent = 'Seleccione una materia';
                materiaSelect.appendChild(opcionVacia);
                
                // Agregar materias de la carrera seleccionada
                materiasPorCarrera[carreraSeleccionada].forEach(function(materia) {
                    const option = document.createElement('option');
                    option.value = materia;
                    option.textContent = materia;
                    materiaSelect.appendChild(option);
                });
                
                materiaSelect.disabled = false;
                console.log('‚úÖ Materias cargadas:', materiasPorCarrera[carreraSeleccionada].length);
            } else {
                // No hay carrera seleccionada o no tiene materias
                const opcionVacia = document.createElement('option');
                opcionVacia.value = '';
                opcionVacia.textContent = 'Primero seleccione una carrera';
                materiaSelect.appendChild(opcionVacia);
                materiaSelect.disabled = true;
                console.log('‚ö†Ô∏è No hay materias para:', carreraSeleccionada);
            }
        }
        
        // Event listener para cambio de carrera
        carreraSelect.addEventListener('change', function() {
            cargarMaterias(this.value);
        });
        
        // Inicializar estado de materia
        materiaSelect.disabled = true;
        
        // Si ya hay una carrera seleccionada al cargar
        if (carreraSelect.value) {
            cargarMaterias(carreraSelect.value);
        }
        
        console.log('‚úÖ Funcionalidad carrera-materia inicializada correctamente');
    }

    // üéØ FUNCI√ìN PARA INICIALIZAR FUNCIONALIDAD MULTIMEDIA
    function initMultimediaFunctionality() {
        console.log('üöÄ Inicializando funcionalidad multimedia...');
        
        // Inicializar gruposTiposMultimedia si no existe
        if (!window.gruposTiposMultimedia) {
            window.gruposTiposMultimedia = [];
        }
        
        // Event listener para el bot√≥n de agregar multimedia
        const btnAgregarMultimedia = document.getElementById('btn-agregar-multimedia');
        console.log('üîç Bot√≥n encontrado:', btnAgregarMultimedia);
        
        if (btnAgregarMultimedia) {
            // Remover event listeners previos para evitar duplicados
            btnAgregarMultimedia.replaceWith(btnAgregarMultimedia.cloneNode(true));
            const newBtn = document.getElementById('btn-agregar-multimedia');
            
            newBtn.addEventListener('click', function() {
                console.log('‚ûï Bot√≥n clickeado, ejecutando agregarNuevoMultimedia()');
                agregarNuevoMultimedia();
            });
            console.log('‚úÖ Event listener agregado correctamente al bot√≥n +');
        } else {
            console.error('‚ùå No se encontr√≥ el bot√≥n btn-agregar-multimedia');
        }
    }

    // üéØ FUNCI√ìN PARA AGREGAR NUEVO GRUPO DE MULTIMEDIA
    function agregarNuevoMultimedia() {
        console.log('üîÑ Ejecutando agregarNuevoMultimedia()');
        const contenedor = document.getElementById('contenedor-tipos-multimedia');
        console.log('üì¶ Contenedor encontrado:', contenedor);
        
        if (!contenedor) {
            console.error('‚ùå No se encontr√≥ el contenedor contenedor-tipos-multimedia');
            return;
        }
        
        const index = window.gruposTiposMultimedia.length;
        console.log('üî¢ √çndice actual:', index);
        
        // Crear nuevo grupo
        const nuevoGrupo = {
            url: '',
            titulo: ''
        };
        
        window.gruposTiposMultimedia.push(nuevoGrupo);
        
        // Crear HTML para el nuevo grupo con la estructura exacta especificada
        const grupoHTML = `
            <div class="grupo-multimedia mb-3" data-index="${index}">
                <div class="row">
                    <div class="col-md-3">
                        <label for="ingresar_enlace_${index}" style="font-size: 14px;">Ingresar enlace (URL)</label>
                        <div class="input-group">
                            <input type="url" class="form-control form-control-sm" 
                                   id="ingresar_enlace_${index}" 
                                   name="ingresar_enlace_${index}" 
                                   placeholder="URL del contenido multimedia">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="titulo_contenido_${index}" style="font-size: 14px;">Titulo del contenido <span class="text-danger">*</span></label>
                        <input type="text" class="form-control form-control-sm" 
                               id="titulo_contenido_${index}" 
                               name="titulo_contenido_${index}" 
                               required>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="boton-eliminar" 
                                onclick="eliminarMultimedia(${index})" 
                                title="Eliminar este contenido multimedia">√ó</button>
                    </div>
                </div>
            </div>
        `;
        
        contenedor.insertAdjacentHTML('beforeend', grupoHTML);
        
        // Agregar event listeners para actualizar autom√°ticamente los datos (Multimedia)
        const urlInput = document.getElementById(`ingresar_enlace_${index}`);
        const tituloInput = document.getElementById(`titulo_contenido_${index}`);

        console.log(`üîç Elementos multimedia encontrados para √≠ndice ${index}:`, {
            urlInput: !!urlInput,
            tituloInput: !!tituloInput,
            estadoArray: window.gruposTiposMultimedia,
            longitudArray: window.gruposTiposMultimedia.length
        });

        if (urlInput && tituloInput && window.gruposTiposMultimedia[index]) {
            urlInput.addEventListener('input', function() {
                window.gruposTiposMultimedia[index].url = this.value.trim();
                console.log(`üîÑ URL actualizada para grupo ${index}:`, this.value);
            });
            tituloInput.addEventListener('input', function() {
                window.gruposTiposMultimedia[index].titulo = this.value.trim();
                console.log(`üîÑ T√≠tulo actualizado para grupo ${index}:`, this.value);
            });
            console.log(`‚úÖ Event listeners multimedia agregados para grupo ${index}`);
        } else {
            console.warn(`‚ö†Ô∏è Inputs multimedia no hallados para grupo ${index} o estado no inicializado`);
        }
        
        console.log('‚úÖ Nuevo grupo agregado exitosamente con event listeners');
    }

    // üéØ FUNCI√ìN PARA ELIMINAR MULTIMEDIA
    function eliminarMultimedia(index) {
        console.log('üóëÔ∏è Solicitar eliminaci√≥n multimedia √≠ndice:', index);
        const ejecutarEliminacion = function() {
            // Eliminar del array si existe
            if (Array.isArray(window.gruposTiposMultimedia)) {
                window.gruposTiposMultimedia.splice(index, 1);
            }
            // Eliminar del DOM
            const grupo = document.querySelector(`[data-index="${index}"]`);
            if (grupo) {
                grupo.remove();
            }
            // Actualizar √≠ndices
            actualizarIndicesMultimedia();
            console.log('‚úÖ Multimedia eliminado y √≠ndices actualizados');
        };
        
        if (typeof mostrarModalAlerta === 'function') {
            mostrarModalAlerta(ejecutarEliminacion);
        } else {
            if (confirm('¬øEliminar este contenido multimedia?')) ejecutarEliminacion();
        }
    }

    // üéØ FUNCI√ìN PARA ACTUALIZAR √çNDICES
    function actualizarIndicesMultimedia() {
        const grupos = document.querySelectorAll('.grupo-multimedia');
        grupos.forEach((grupo, nuevoIndex) => {
            grupo.setAttribute('data-index', nuevoIndex);
            
            // Actualizar IDs y names de los inputs
            const inputUrl = grupo.querySelector('input[type="url"]');
            const inputTitulo = grupo.querySelector('input[type="text"]');
            const labelUrl = grupo.querySelector('label[for*="ingresar_enlace"]');
            const labelTitulo = grupo.querySelector('label[for*="titulo_contenido"]');
            
            if (inputUrl) {
                inputUrl.id = `ingresar_enlace_${nuevoIndex}`;
                inputUrl.name = `ingresar_enlace_${nuevoIndex}`;
            }
            if (inputTitulo) {
                inputTitulo.id = `titulo_contenido_${nuevoIndex}`;
                inputTitulo.name = `titulo_contenido_${nuevoIndex}`;
            }
            if (labelUrl) {
                labelUrl.setAttribute('for', `ingresar_enlace_${nuevoIndex}`);
            }
            if (labelTitulo) {
                labelTitulo.setAttribute('for', `titulo_contenido_${nuevoIndex}`);
            }
            
            // Actualizar el bot√≥n de eliminar
            const btnEliminar = grupo.querySelector('button');
            if (btnEliminar) {
                btnEliminar.setAttribute('onclick', `eliminarMultimedia(${nuevoIndex})`);
            }
        });
    }

    // Hacer las funciones globales para que puedan ser llamadas desde onclick
    window.eliminarMultimedia = eliminarMultimedia;
    window.actualizarIndicesMultimedia = actualizarIndicesMultimedia;

    // üéØ FUNCI√ìN PARA INICIALIZAR FUNCIONALIDAD VARIOS
    function initVariosFunctionality() {
        console.log('üöÄ Inicializando funcionalidad varios...');
        
        // Inicializar gruposTiposVariosNuevo si no existe
        if (!window.gruposTiposVariosNuevo) {
            window.gruposTiposVariosNuevo = [];
        }
        
        // Agregar event listeners para el formulario principal
        const tipoVariosPrincipal = document.getElementById('tipo-varios');
        const cantEjemplaresPrincipal = document.getElementById('cant_ejemplares');
        
        console.log('üîç Elementos principales encontrados:', {
            tipoVariosPrincipal: tipoVariosPrincipal,
            cantEjemplaresPrincipal: cantEjemplaresPrincipal
        });
        
        if (tipoVariosPrincipal && cantEjemplaresPrincipal) {
            // Asegurar que el primer elemento del array sea el formulario principal
            if (window.gruposTiposVariosNuevo.length === 0) {
                window.gruposTiposVariosNuevo.push({
                    tipo: tipoVariosPrincipal.value || '',
                    cantidad: parseInt(cantEjemplaresPrincipal.value) || 1
                });
                console.log('‚úÖ Inicializado formulario principal en gruposTiposVariosNuevo[0]:', window.gruposTiposVariosNuevo[0]);
            }
            
            tipoVariosPrincipal.addEventListener('input', function() {
                window.gruposTiposVariosNuevo[0].tipo = this.value;
                console.log('üîÑ Actualizado tipo principal:', this.value);
                console.log('üìä Estado actual gruposTiposVariosNuevo:', window.gruposTiposVariosNuevo);
            });
            
            cantEjemplaresPrincipal.addEventListener('input', function() {
                window.gruposTiposVariosNuevo[0].cantidad = parseInt(this.value) || 1;
                console.log('üîÑ Actualizada cantidad principal:', this.value);
                console.log('üìä Estado actual gruposTiposVariosNuevo:', window.gruposTiposVariosNuevo);
            });
            
            console.log('‚úÖ Event listeners agregados al formulario principal');
        } else {
            console.error('‚ùå No se encontraron los elementos principales del formulario');
        }
        
        // Event listener para el bot√≥n de agregar varios
        const btnAgregarVarios = document.getElementById('btn-agregar-varios');
        console.log('üîç Bot√≥n encontrado:', btnAgregarVarios);
        
        if (btnAgregarVarios) {
            // Remover event listeners previos para evitar duplicados
            btnAgregarVarios.replaceWith(btnAgregarVarios.cloneNode(true));
            const newBtn = document.getElementById('btn-agregar-varios');
            
            newBtn.addEventListener('click', function() {
                console.log('‚ûï Bot√≥n clickeado, ejecutando agregarNuevoVarios()');
                agregarNuevoVarios();
            });
            console.log('‚úÖ Event listener agregado correctamente al bot√≥n +');
        } else {
            console.error('‚ùå No se encontr√≥ el bot√≥n btn-agregar-varios');
        }
    }

    // üéØ FUNCI√ìN PARA AGREGAR NUEVO GRUPO DE VARIOS
    function agregarNuevoVarios() {
        console.log('üîÑ Ejecutando agregarNuevoVarios()');
        const contenedor = document.getElementById('contenedor-tipos-varios-dinamicos');
        console.log('üì¶ Contenedor encontrado:', contenedor);
        
        if (!contenedor) {
            console.error('‚ùå No se encontr√≥ el contenedor contenedor-tipos-varios-dinamicos');
            return;
        }
        
        const index = window.gruposTiposVariosNuevo.length;
        console.log('üî¢ √çndice actual:', index);
        
        // Crear nuevo grupo
        const nuevoGrupo = {
            tipo: '',
            cantidad: 1
        };
        
        window.gruposTiposVariosNuevo.push(nuevoGrupo);
        
        // Crear HTML para el nuevo grupo con la estructura exacta especificada
        const grupoHTML = `
            <div class="grupo-varios mb-3" data-index="${index}">
                <div class="row">
                    <div class="col-md-3"></div> <!-- Espacio vac√≠o para alinear con "Sede" -->
                    <div class="col-md-3">
                        <label for="tipo_varios_${index}" style="font-size: 14px;">Tipo a registrar <span class="text-danger">*</span></label>
                        <input type="text" class="form-control form-control-sm" 
                               id="tipo_varios_${index}" 
                               name="tipo_varios_${index}" 
                               required>
                    </div>
                    <div class="col-md-3">
                        <label for="cant_ejemplares_${index}" style="font-size: 14px;">Cantidad <span class="text-danger">*</span></label>
                        <input type="number" class="form-control form-control-sm" 
                               id="cant_ejemplares_${index}" 
                               name="cant_ejemplares_${index}" 
                               min="1" 
                               value="1" 
                               data-valor-anterior="1"
                               required>
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                         <button type="button" class="boton-eliminar" 
                                 onclick="eliminarVarios(${index})" 
                                 title="Eliminar este tipo de material">√ó</button>
                     </div>
                </div>
            </div>
        `;
        
        contenedor.insertAdjacentHTML('beforeend', grupoHTML);
        
        // Agregar event listeners para actualizar autom√°ticamente los datos
        const tipoInput = document.getElementById(`tipo_varios_${index}`);
        const cantidadInput = document.getElementById(`cant_ejemplares_${index}`);
        
        console.log(`üîç Elementos din√°micos encontrados para √≠ndice ${index}:`, {
            tipoInput: tipoInput,
            cantidadInput: cantidadInput,
            estadoArray: window.gruposTiposVariosNuevo,
            longitudArray: window.gruposTiposVariosNuevo.length
        });
        
        if (tipoInput && cantidadInput) {
            tipoInput.addEventListener('input', function() {
                if (window.gruposTiposVariosNuevo[index]) {
                    window.gruposTiposVariosNuevo[index].tipo = this.value;
                    console.log(`üîÑ Actualizado tipo del grupo ${index}:`, this.value);
                    console.log('üìä Estado completo gruposTiposVariosNuevo:', window.gruposTiposVariosNuevo);
                } else {
                    console.error(`‚ùå No existe gruposTiposVariosNuevo[${index}]`);
                }
            });
            
            const manejarCambioCantidad = function() {
                const prevAttr = parseInt(cantidadInput.getAttribute('data-valor-anterior'));
                const prev = Number.isFinite(prevAttr) ? prevAttr : (window.gruposTiposVariosNuevo[index]?.cantidad || 1);
                const nueva = parseInt(cantidadInput.value) || 1;
                const aplicar = function() {
                    cantidadInput.setAttribute('data-valor-anterior', nueva);
                    if (window.gruposTiposVariosNuevo[index]) {
                        window.gruposTiposVariosNuevo[index].cantidad = nueva;
                    }
                    console.log(`‚úÖ Cantidad confirmada para grupo ${index}:`, nueva);
                };
                if (nueva < prev) {
                    if (typeof mostrarModalReducirEjemplares === 'function') {
                        mostrarModalReducirEjemplares(
                            aplicar,
                            function() { cantidadInput.value = prev; }
                        );
                    } else {
                        if (confirm('Reducir la cantidad eliminar√° datos de ejemplares adicionales. ¬øConfirmar?')) {
                            aplicar();
                        } else {
                            cantidadInput.value = prev;
                        }
                    }
                } else {
                    aplicar();
                }
            };
            cantidadInput.addEventListener('input', manejarCambioCantidad);
            cantidadInput.addEventListener('change', manejarCambioCantidad);
            
            console.log(`‚úÖ Event listeners agregados para grupo ${index}`);
        } else {
            console.error(`‚ùå No se encontraron los inputs para el grupo ${index}`);
        }
        
        console.log('‚úÖ Nuevo grupo agregado exitosamente con event listeners');
    }

    // üéØ FUNCI√ìN PARA ELIMINAR VARIOS
    function eliminarVarios(index) {
        console.log('üóëÔ∏è Solicitar eliminaci√≥n de tipo VARIOS √≠ndice:', index);
        const ejecutar = function() {
            // Eliminar del array
            if (Array.isArray(window.gruposTiposVariosNuevo)) {
                window.gruposTiposVariosNuevo.splice(index, 1);
            }
            // Eliminar del DOM
            const grupo = document.querySelector(`[data-index="${index}"]`);
            if (grupo) {
                grupo.remove();
            }
            // Actualizar √≠ndices
            actualizarIndicesVarios();
            console.log('‚úÖ Tipo VARIOS eliminado y reindexado');
        };
        if (typeof mostrarModalAlerta === 'function') {
            mostrarModalAlerta(ejecutar);
        } else {
            if (confirm('¬øEliminar este tipo de material?')) ejecutar();
        }
    }

    // üéØ FUNCI√ìN PARA ACTUALIZAR √çNDICES
    function actualizarIndicesVarios() {
        const grupos = document.querySelectorAll('.grupo-varios');
        grupos.forEach((grupo, nuevoIndex) => {
            grupo.setAttribute('data-index', nuevoIndex);
            
            // Actualizar IDs y names de los inputs
            const inputTipo = grupo.querySelector('input[type="text"]');
            const inputCantidad = grupo.querySelector('input[type="number"]');
            const labelTipo = grupo.querySelector('label[for*="tipo_varios"]');
            const labelCantidad = grupo.querySelector('label[for*="cant_ejemplares"]');
            
            if (inputTipo) {
                inputTipo.id = `tipo_varios_${nuevoIndex}`;
                inputTipo.name = `tipo_varios_${nuevoIndex}`;
            }
            if (inputCantidad) {
                inputCantidad.id = `cant_ejemplares_${nuevoIndex}`;
                inputCantidad.name = `cant_ejemplares_${nuevoIndex}`;
            }
            if (labelTipo) {
                labelTipo.setAttribute('for', `tipo_varios_${nuevoIndex}`);
            }
            if (labelCantidad) {
                labelCantidad.setAttribute('for', `cant_ejemplares_${nuevoIndex}`);
            }
            
            // Actualizar el bot√≥n de eliminar
            const btnEliminar = grupo.querySelector('button');
            if (btnEliminar) {
                btnEliminar.setAttribute('onclick', `eliminarVarios(${nuevoIndex})`);
            }
        });
    }

    // Hacer las funciones globales para que puedan ser llamadas desde onclick
    window.eliminarVarios = eliminarVarios;
    window.actualizarIndicesVarios = actualizarIndicesVarios;
});

// ===== FUNCIONES GLOBALES PARA PREPARAR ENV√çO DE FORMULARIOS =====

// Funci√≥n global para preparar env√≠o de formulario de mapas
window.prepararEnvioFormulario = function() {
    const tipoMaterial = document.getElementById('tipo_material').value;
    
    if (tipoMaterial === 'mapa') {
        // Serializar los datos de gruposTiposMapa
        const gruposTiposMapaInput = document.getElementById('gruposTiposMapa');
        if (gruposTiposMapaInput && window.gruposTiposMapa) {
            gruposTiposMapaInput.value = JSON.stringify(window.gruposTiposMapa);
        }
        
        // Agregar campos ocultos para cada tipo de grupo
        if (window.gruposTiposMapa) {
            window.gruposTiposMapa.forEach((grupo, idx) => {
                const tipoInput = document.createElement('input');
                tipoInput.type = 'hidden';
                tipoInput.name = `tipo_grupo_${idx}`;
                tipoInput.value = grupo.tipo;
                document.getElementById('form_alta_material').appendChild(tipoInput);
            });
        }
        
        console.log('üì§ Datos de mapa preparados para env√≠o:', {
            gruposTiposMapa: window.gruposTiposMapa,
            sede: document.getElementById('sede-mapa')?.value
        });
    }
    else if (tipoMaterial === 'multimedia') {
        console.log('üì§ Preparando datos de multimedia din√°micos...');
        
        // Recopilar datos de multimedia desde los inputs del DOM
        const gruposMultimedia = [];
        
        // Buscar en el contenedor correcto donde se agregan los elementos din√°micos
        const contenedor = document.getElementById('contenedor-tipos-multimedia');
        
        if (contenedor) {
            const grupos = contenedor.querySelectorAll('.grupo-multimedia');
            console.log(`üì¶ Encontrados ${grupos.length} grupos multimedia din√°micos`);
            
            // SIEMPRE agregar primero los datos principales del formulario si tienen contenido
            const urlPrincipal = document.getElementById('ingresar_enlace');
            const tituloPrincipal = document.getElementById('titulo_contenido');
            
            if (urlPrincipal && tituloPrincipal && (urlPrincipal.value.trim() || tituloPrincipal.value.trim())) {
                console.log('üìã Agregando datos principales del formulario PRIMERO');
                gruposMultimedia.push({
                    url: urlPrincipal.value.trim() || '',
                    titulo: tituloPrincipal.value.trim() || ''
                });
            }
            
            // LUEGO agregar los elementos din√°micos si existen
            if (grupos.length > 0) {
                console.log('üìã Agregando elementos din√°micos DESPU√âS del formulario principal');
                
                grupos.forEach((grupo, index) => {
                    console.log(`üîç Procesando grupo ${index}:`, grupo);
                    
                    // Obtener el √≠ndice real del data-index
                    const dataIndex = grupo.getAttribute('data-index');
                    console.log(`üìä Data-index del grupo: ${dataIndex}`);
                    
                    const urlInput = grupo.querySelector(`input[name="ingresar_enlace_${dataIndex}"]`);
                    const tituloInput = grupo.querySelector(`input[name="titulo_contenido_${dataIndex}"]`);
                    
                    console.log(`üìã Grupo din√°mico ${index} (data-index: ${dataIndex}):`, {
                        urlInput: urlInput ? urlInput.value : 'no encontrado',
                        tituloInput: tituloInput ? tituloInput.value : 'no encontrado',
                        urlSelector: `input[name="ingresar_enlace_${dataIndex}"]`,
                        tituloSelector: `input[name="titulo_contenido_${dataIndex}"]`
                    });
                    
                    if (urlInput && tituloInput && (urlInput.value.trim() || tituloInput.value.trim())) {
                        gruposMultimedia.push({
                            url: urlInput.value.trim() || '',
                            titulo: tituloInput.value.trim() || ''
                        });
                        console.log(`‚úÖ Datos agregados del grupo ${dataIndex}`);
                    }
                });
            }
        } else {
            console.log('‚ùå No se encontr√≥ el contenedor contenedor-tipos-multimedia');
        }
        
        // Actualizar window.gruposTiposMultimedia
        window.gruposTiposMultimedia = gruposMultimedia;
        
        // Serializar los datos si existe el input hidden
        const gruposTiposMultimediaInput = document.getElementById('gruposMultimedia');
        if (gruposTiposMultimediaInput) {
            gruposTiposMultimediaInput.value = JSON.stringify(window.gruposTiposMultimedia);
            console.log('üì§ Datos serializados en input hidden:', gruposTiposMultimediaInput.value);
        } else {
            console.log('‚ùå No se encontr√≥ el input hidden gruposMultimedia');
        }
        
        console.log('üì§ Datos de multimedia preparados:', {
            gruposTiposMultimedia: window.gruposTiposMultimedia,
            totalElementos: gruposMultimedia.length
        });
    }
    else if (tipoMaterial === 'varios') {
        console.log('üî• === PREPARANDO ENV√çO DE VARIOS ===');
        console.log('üìä Estado inicial del array gruposTiposVariosNuevo:', window.gruposTiposVariosNuevo);
        console.log('üìä Longitud del array:', window.gruposTiposVariosNuevo ? window.gruposTiposVariosNuevo.length : 'undefined');
        
        // Verificar elementos en el DOM
        const contenedor = document.getElementById('contenedor-tipos-varios-dinamicos');
        const gruposDinamicos = contenedor ? contenedor.querySelectorAll('.grupo-varios') : [];
        console.log('üîç Grupos din√°micos en DOM:', gruposDinamicos.length);
        
        // Verificar cada elemento del array
        if (window.gruposTiposVariosNuevo && window.gruposTiposVariosNuevo.length > 0) {
            window.gruposTiposVariosNuevo.forEach((elemento, index) => {
                console.log(`üìã Elemento ${index}:`, elemento);
            });
        } else {
            console.error('‚ùå Array gruposTiposVariosNuevo est√° vac√≠o o no existe');
        }
        
        // üî• VERIFICACI√ìN DETALLADA DEL INPUT HIDDEN
        const gruposTiposVariosInput = document.getElementById('gruposTiposVariosNuevo');
        console.log('üîç Input hidden encontrado:', gruposTiposVariosInput);
        console.log('üîç Valor actual del input hidden ANTES de serializar:', gruposTiposVariosInput ? gruposTiposVariosInput.value : 'NO ENCONTRADO');
        
        // CORRECCI√ìN DEFINITIVA PARA VARIOS: Los datos ya se actualizan autom√°ticamente
        console.log('üì§ Datos de varios preparados autom√°ticamente:', {
            gruposTiposVariosNuevo: window.gruposTiposVariosNuevo,
            totalElementos: window.gruposTiposVariosNuevo ? window.gruposTiposVariosNuevo.length : 0,
            sede: document.getElementById('sede-varios')?.value
        });
        
        // Serializar los datos actualizados autom√°ticamente
        if (gruposTiposVariosInput && window.gruposTiposVariosNuevo) {
            const jsonString = JSON.stringify(window.gruposTiposVariosNuevo);
            gruposTiposVariosInput.value = jsonString;
            console.log('üì§ JSON serializado:', jsonString);
            console.log('üì§ Longitud del JSON:', jsonString.length);
            console.log('üì§ Valor final del input hidden:', gruposTiposVariosInput.value);
            console.log('üì§ ¬øEl input tiene el valor correcto?', gruposTiposVariosInput.value === jsonString);
        } else {
            console.error('‚ùå No se pudo serializar:');
            console.error('  - Input hidden encontrado:', !!gruposTiposVariosInput);
            console.error('  - Array existe:', !!window.gruposTiposVariosNuevo);
            console.error('  - Array tiene elementos:', window.gruposTiposVariosNuevo ? window.gruposTiposVariosNuevo.length : 0);
        }
    }
};

// üöÄ FUNCI√ìN GLOBAL PARA ENVIAR FORMULARIO MULTIMEDIA V3 - SIN DEPENDENCIA DEL TAG FORM
window.enviarFormularioMultimediaV3 = function() {
    console.log('üöÄüöÄüöÄ BOT√ìN GUARDAR CLICKEADO - FUNCI√ìN GLOBAL V3');
    console.log('üîç === NUEVA ESTRATEGIA SIN TAG FORM ===');
    
    try {
        // IMPORTANTE: Preparar los datos de multimedia din√°micos antes de enviar
        if (typeof prepararEnvioFormulario === 'function') {
            console.log('üì§ Preparando datos de multimedia din√°micos...');
            prepararEnvioFormulario();
        } else {
            console.warn('‚ö†Ô∏è Funci√≥n prepararEnvioFormulario no encontrada');
        }
        
        // Buscar el contenedor del formulario multimedia
        const contenedor = document.querySelector('[data-form-type="multimedia"]');
        if (!contenedor) {
            console.error('‚ùå‚ùå‚ùå CONTENEDOR NO ENCONTRADO - [data-form-type="multimedia"]');
            alert('Error: No se pudo encontrar el contenedor multimedia');
            return;
        }
        
        console.log('‚úÖ Contenedor encontrado:', contenedor);
        
        // Recolectar todos los campos de entrada
        const campos = contenedor.querySelectorAll('input, select, textarea');
        console.log('üîç Campos encontrados:', campos.length);
        
        // Crear FormData manualmente
        const formData = new FormData();
        
        // Agregar CSRF token del formulario principal
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        formData.append('csrfmiddlewaretoken', csrfToken);
        console.log('üîê CSRF token agregado:', csrfToken);
        
        // üîç NUEVA VALIDACI√ìN CON PESTA√ëAS DE ALERTA INDIVIDUALES
        console.log('üîç Iniciando validaci√≥n personalizada con pesta√±as de alerta...');
        let primerCampoInvalido = null;
        let hayErrores = false;
        let erroresEncontrados = [];
        
        // Funci√≥n para validar un campo individual
        function validarCampo(campo, nombreCampo) {
            if (!campo) {
                console.warn(`‚ö†Ô∏è Campo ${nombreCampo} no encontrado en el DOM`);
                return false;
            }
            
            const valor = campo.value ? campo.value.trim() : '';
            if (valor === '' || valor === null) {
                hayErrores = true;
                erroresEncontrados.push(nombreCampo);
                if (!primerCampoInvalido) primerCampoInvalido = campo;
                
                campo.setCustomValidity(`Por favor complete el campo ${nombreCampo}`);
                
                console.log(`‚ùå Campo inv√°lido: ${nombreCampo}`);
                return false;
            } else {
                campo.setCustomValidity('');
                console.log(`‚úÖ Campo v√°lido: ${nombreCampo}`);
                return true;
            }
        }
        
        // Validar campos principales obligatorios
        console.log('üîç Validando campos principales...');
        const profesor = contenedor.querySelector('[name="profesor"]');
        const carrera = contenedor.querySelector('[name="carrera"]');
        const materia = contenedor.querySelector('[name="materia"]');
        const tituloContenido = contenedor.querySelector('[name="titulo_contenido"]');
        const enlaceContenido = contenedor.querySelector('[name="enlace_contenido_multimedia"]');
        
        validarCampo(profesor, 'Profesor/a');
        validarCampo(carrera, 'Carrera');
        validarCampo(materia, 'Materia');
        validarCampo(tituloContenido, 'T√≠tulo del contenido');
        validarCampo(enlaceContenido, 'Enlace del contenido multimedia');
        
        // Validar todos los inputs din√°micos de "T√≠tulo del contenido"
        console.log('üîç Validando inputs din√°micos de t√≠tulo del contenido...');
        const inputsDinamicos = contenedor.querySelectorAll('input[name^="titulo_contenido_"]');
        console.log(`üìã Encontrados ${inputsDinamicos.length} inputs din√°micos de t√≠tulo`);
        
        inputsDinamicos.forEach((input, index) => {
            const nombreCampo = 'T√≠tulo del contenido';
            validarCampo(input, nombreCampo);
            console.log(`üîç Validando input din√°mico: ${input.name} - ${nombreCampo}`);
        });
        
        // Si hay errores, mostrar el primer campo inv√°lido y detener
        if (hayErrores) {
            console.log('‚ùå Formulario no v√°lido. Errores encontrados:', erroresEncontrados);
            
            if (primerCampoInvalido) {
                console.log('üéØ Enfocando primer campo inv√°lido:', primerCampoInvalido.name);
                primerCampoInvalido.focus();
                
                // Usar reportValidity para mostrar la pesta√±a de alerta individual
                if (primerCampoInvalido.reportValidity) {
                    primerCampoInvalido.reportValidity();
                } else {
                    // Fallback para navegadores que no soportan reportValidity
                    const mensajeError = `Por favor complete los siguientes campos obligatorios: ${erroresEncontrados.join(', ')}`;
                    alert(mensajeError);
                }
            }
            return;
        }
        
        // Recolectar datos solo si la validaci√≥n es exitosa
        campos.forEach(campo => {
            const valor = campo.value.trim();
            
            // Agregar al FormData si tiene nombre
            if (campo.name) {
                formData.append(campo.name, valor);
                console.log(`üìã ${campo.name}: ${valor}`);
            }
        });
        
        console.log('‚úÖ Todos los campos requeridos est√°n completos');
        console.log('üì§üì§üì§ ENVIANDO DATOS A /alta-multimedia/');
        
        // Crear un formulario temporal para env√≠o tradicional (permite modal de confirmaci√≥n)
        const tempForm = document.createElement('form');
        tempForm.method = 'POST';
        tempForm.action = '/alta-multimedia/';
        tempForm.style.display = 'none';
        
        // Agregar todos los datos del FormData al formulario temporal
        for (let [key, value] of formData.entries()) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = value;
            tempForm.appendChild(input);
        }
        
        // Agregar al DOM y enviar
        document.body.appendChild(tempForm);
        console.log('üì§üì§üì§ ENVIANDO FORMULARIO TRADICIONAL PARA MODAL DE CONFIRMACI√ìN');
        tempForm.submit();
        
    } catch (error) {
        console.error('üí•üí•üí• ERROR EN enviarFormularioMultimediaV3:', error);
        alert('Error al procesar el formulario: ' + error.message);
    }
};
</script>

<!-- Scripts necesarios para funcionalidad de formularios din√°micos -->
<script src="{% static 'js/form_altas.js' %}"></script>
<!-- <script src="{% static 'js/confirmacion_alta_material.js' %}"></script> -->
{% endblock %}