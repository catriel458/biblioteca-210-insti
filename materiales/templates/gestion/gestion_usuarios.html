{% extends 'components/baseb.html' %}
{% load static %}

{% block title %}Gestión de Usuarios | Biblioteca Digital{% endblock %}

{% block extra_css %}
<style>
    .user-card {
        transition: all 0.3s ease;
        border: 1px solid #e0e0e0;
    }
    
    .user-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .perfil-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    
    .perfil-estudiante { background-color: #000000 !important; }
    .perfil-bibliotecaria { background-color: #000000 !important; }
    .perfil-docente { background-color: #000000 !important; }
    
    .status-active { color: #4caf50; }
    .status-inactive { color: #f44336; }
    
    .search-container {
        position: relative;
    }
    
    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    
    .search-result-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
    }
    
    .search-result-item:hover {
        background-color: #f5f5f5;
    }
    
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .btn-action {
        margin: 0 2px;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .table-responsive {
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Token CSRF para AJAX -->
{% csrf_token %}

<div class="container-fluid">
    <div class="row">
            <!-- Estadísticas -->
            <div class="row mb-4">
                <div class="col-md-2">
                    <div class="card stats-card text-center">
                        <div class="card-body">
                            <h4 class="mb-1">{{ total_usuarios }}</h4>
                            <small>Total Usuarios</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-success text-white text-center">
                        <div class="card-body">
                            <h4 class="mb-1">{{ usuarios_activos }}</h4>
                            <small>Activos</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-danger text-white text-center">
                        <div class="card-body">
                            <h4 class="mb-1">{{ usuarios_inactivos }}</h4>
                            <small>Inactivos</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-info text-white text-center">
                        <div class="card-body">
                            <h4 class="mb-1">{{ estudiantes }}</h4>
                            <small>Estudiantes</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-warning text-white text-center">
                        <div class="card-body">
                            <h4 class="mb-1">{{ bibliotecarias }}</h4>
                            <small>Bibliotecarias</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-secondary text-white text-center">
                        <div class="card-body">
                            <h4 class="mb-1">{{ docentes }}</h4>
                            <small>Docentes</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Controles -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="search-container">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" 
                                           class="form-control" 
                                           id="buscarUsuario" 
                                           placeholder="Buscar por DNI, nombre, apellido o email...">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button type="button" 
                                    class="btn btn-primary" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#modalCrearUsuario">
                                <i class="fas fa-plus me-1"></i>Crear Usuario
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tabla de usuarios -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="tablaUsuarios">
                            <thead class="table-dark">
                                <tr>
                                    <th>DNI</th>
                                    <th>Nombre Completo</th>
                                    <th>Email</th>
                                    <th>Perfil</th>
                                    <th>Estado</th>
                                    <th>Fecha Registro</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="cuerpoTablaUsuarios">
                                {% for usuario in usuarios %}
                                <tr data-usuario-id="{{ usuario.id }}">
                                    <td><strong>{{ usuario.dni }}</strong></td>
                                    <td>{{ usuario.nombre }} {{ usuario.apellido }}</td>
                                    <td>{{ usuario.email }}</td>
                                    <td>
                                        <span class="badge perfil-{{ usuario.perfil }}">
                                            {{ usuario.get_perfil_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if usuario.is_active %}
                                            <i class="fas fa-check-circle status-active"></i> Activo
                                        {% else %}
                                            <i class="fas fa-times-circle status-inactive"></i> Inactivo
                                        {% endif %}
                                    </td>
                                    <td>{{ usuario.fecha_registro|date:"d/m/Y" }}</td>
                                    <td>
                                        <button type="button" 
                                                class="btn btn-sm btn-outline-primary btn-action"
                                                onclick="editarUsuario({{ usuario.id }})"
                                                title="Editar usuario">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" 
                                                class="btn btn-sm btn-outline-danger btn-action"
                                                onclick="confirmarEliminarUsuario({{ usuario.id }}, '{{ usuario.nombre }} {{ usuario.apellido }}')"
                                                title="Eliminar usuario">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        <i class="fas fa-users fa-3x mb-3"></i>
                                        <p>No hay usuarios registrados</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear Usuario -->
<div class="modal fade" id="modalCrearUsuario" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>Crear Nuevo Usuario
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="formCrearUsuario">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="crear_dni" class="form-label">DNI *</label>
                            <input type="text" class="form-control" id="crear_dni" name="dni" required maxlength="8">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="crear_perfil" class="form-label">Perfil *</label>
                            <select class="form-select" id="crear_perfil" name="perfil" required>
                                <option value="">Seleccionar perfil</option>
                                <option value="estudiante">Estudiante</option>
                                <option value="docente">Docente</option>
                                <option value="bibliotecaria">Bibliotecaria</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="crear_nombre" class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="crear_nombre" name="nombre" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="crear_apellido" class="form-label">Apellido *</label>
                            <input type="text" class="form-control" id="crear_apellido" name="apellido" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="crear_email" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="crear_email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="crear_password" class="form-label">Contraseña *</label>
                        <input type="password" class="form-control" id="crear_password" name="password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Crear Usuario
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Usuario -->
<div class="modal fade" id="modalEditarUsuario" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-edit me-2"></i>Editar Usuario
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="formEditarUsuario">
                {% csrf_token %}
                <input type="hidden" id="editar_usuario_id" name="usuario_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editar_dni" class="form-label">DNI</label>
                            <input type="text" class="form-control" id="editar_dni" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editar_perfil" class="form-label">Perfil *</label>
                            <select class="form-select" id="editar_perfil" name="perfil" required>
                                <option value="estudiante">Estudiante</option>
                                <option value="docente">Docente</option>
                                <option value="bibliotecaria">Bibliotecaria</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editar_nombre" class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="editar_nombre" name="nombre" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editar_apellido" class="form-label">Apellido *</label>
                            <input type="text" class="form-control" id="editar_apellido" name="apellido" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editar_email" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="editar_email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editar_is_active" name="is_active">
                            <label class="form-check-label" for="editar_is_active">
                                Usuario activo
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editar_nueva_password" class="form-label">Nueva Contraseña (opcional)</label>
                        <input type="password" class="form-control" id="editar_nueva_password" name="nueva_password">
                        <div class="form-text">Dejar en blanco para mantener la contraseña actual</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Confirmar Eliminación -->
<div class="modal fade" id="modalEliminarUsuario" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro que desea eliminar al usuario <strong id="nombreUsuarioEliminar"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Esta acción no se puede deshacer.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">
                    <i class="fas fa-trash me-1"></i>Eliminar Usuario
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    let usuarioIdEliminar = null;
    let timeoutBusqueda = null;
    
    // Debug: Verificar si jQuery y los elementos existen
    console.log('jQuery cargado:', typeof $ !== 'undefined');
    console.log('Input buscarUsuario encontrado:', $('#buscarUsuario').length);
    console.log('Tabla cuerpoTablaUsuarios encontrada:', $('#cuerpoTablaUsuarios').length);
    console.log('Filas con data-usuario-id:', $('#cuerpoTablaUsuarios tr[data-usuario-id]').length);
    
    // Obtener token CSRF
    function getCSRFToken() {
        return $('[name=csrfmiddlewaretoken]').val();
    }
    
    // Filtro de búsqueda dinámico (tiempo real)
    $('#buscarUsuario').on('input', function() {
        console.log('Evento input disparado'); // Debug
        const query = $(this).val().toLowerCase().trim();
        console.log('Query:', query); // Debug
        const filas = $('#cuerpoTablaUsuarios tr[data-usuario-id]');
        console.log('Filas encontradas:', filas.length); // Debug
        
        filas.each(function() {
            const fila = $(this);
            const dni = fila.find('td:nth-child(1)').text().toLowerCase();
            const nombre = fila.find('td:nth-child(2)').text().toLowerCase();
            const email = fila.find('td:nth-child(3)').text().toLowerCase();
            
            console.log('Procesando fila - DNI:', dni, 'Nombre:', nombre, 'Email:', email); // Debug
            
            // Buscar en DNI, nombre completo y email
            const coincide = query === '' || 
                           dni.includes(query) || 
                           nombre.includes(query) || 
                           email.includes(query);
            
            console.log('Coincide:', coincide); // Debug
            
            if (coincide) {
                fila.show();
            } else {
                fila.hide();
            }
        });
    });
    
    // Función para mostrar mensaje cuando no hay resultados
    function mostrarMensajeNoResultados(filasVisibles, query) {
        const tbody = $('#cuerpoTablaUsuarios');
        const mensajeExistente = tbody.find('.no-resultados');
        
        // Remover mensaje anterior si existe
        mensajeExistente.remove();
        
        // Si no hay filas visibles y hay una búsqueda activa
        if (filasVisibles === 0 && query !== '') {
            const mensajeNoResultados = `
                <tr class="no-resultados">
                    <td colspan="7" class="text-center text-muted py-4">
                        <i class="fas fa-search fa-3x mb-3"></i>
                        <p class="mb-0">No se encontraron usuarios que coincidan con "<strong>${query}</strong>"</p>
                        <small class="text-muted">Intenta con otro término de búsqueda</small>
                    </td>
                </tr>
            `;
            tbody.append(mensajeNoResultados);
        }
    }
    
    // Crear usuario
    $('#formCrearUsuario').on('submit', function(e) {
        e.preventDefault();
        
        console.log('Formulario de crear usuario enviado');
        
        const formData = new FormData(this);
        
        // Debug: mostrar datos del formulario
        console.log('Datos del formulario:');
        for (let [key, value] of formData.entries()) {
            console.log(key, value);
        }
        
        const csrfToken = getCSRFToken();
        console.log('CSRF Token:', csrfToken);
        
        $.ajax({
            url: '{% url "crear_usuario" %}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': csrfToken
            },
            beforeSend: function(xhr) {
                console.log('Enviando petición AJAX...');
                console.log('URL:', '{% url "crear_usuario" %}');
                console.log('Headers:', xhr.getAllResponseHeaders());
            },
            success: function(response) {
                console.log('Respuesta del servidor:', response);
                if (response.success) {
                    $('#modalCrearUsuario').modal('hide');
                    $('#formCrearUsuario')[0].reset();
                    mostrarMensaje(response.message, 'success');
                    console.log('Usuario creado exitosamente, recargando página...');
                    // Recargar la página inmediatamente para mostrar el nuevo usuario
                    location.reload();
                } else {
                    console.log('Error en la respuesta:', response.error);
                    mostrarMensaje(response.error || 'Error desconocido', 'error');
                }
            },
            error: function(xhr) {
                console.error('Error completo:', xhr);
                console.error('Status:', xhr.status);
                console.error('Response Text:', xhr.responseText);
                
                let errorMessage = 'Error al crear el usuario';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                } else if (xhr.status === 403) {
                    errorMessage = 'No tienes permisos para realizar esta acción';
                } else if (xhr.status === 500) {
                    errorMessage = 'Error interno del servidor';
                }
                
                mostrarMensaje(errorMessage, 'error');
            }
        });
    });
    
    // Editar usuario
    $('#formEditarUsuario').on('submit', function(e) {
        e.preventDefault();
        
        const usuarioId = $('#editar_usuario_id').val();
        const formData = new FormData(this);
        
        $.ajax({
            url: `/gestion/usuarios/editar/${usuarioId}/`,
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': getCSRFToken()
            },
            success: function(response) {
                if (response.success) {
                    $('#modalEditarUsuario').modal('hide');
                    mostrarMensaje(response.message, 'success');
                    // Recargar la página para mostrar los cambios
                    setTimeout(() => location.reload(), 1500);
                } else {
                    mostrarMensaje(response.error, 'error');
                }
            },
            error: function(xhr) {
                console.error('Error:', xhr.responseText);
                mostrarMensaje('Error al editar el usuario', 'error');
            }
        });
    });
    
    // Confirmar eliminación
    $('#btnConfirmarEliminar').on('click', function() {
        if (usuarioIdEliminar) {
            $.ajax({
                url: `/gestion/usuarios/eliminar/${usuarioIdEliminar}/`,
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                },
                success: function(response) {
                    if (response.success) {
                        $('#modalEliminarUsuario').modal('hide');
                        mostrarMensaje(response.message, 'success');
                        // Recargar la página para mostrar los cambios
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        mostrarMensaje(response.error, 'error');
                    }
                },
                error: function(xhr) {
                    console.error('Error:', xhr.responseText);
                    mostrarMensaje('Error al eliminar el usuario', 'error');
                }
            });
        }
    });
    
    // Función para mostrar mensajes
    function mostrarMensaje(mensaje, tipo) {
        const alertClass = tipo === 'success' ? 'alert-success' : 'alert-danger';
        const icon = tipo === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
        
        const alert = $(`
            <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                <i class="fas ${icon} me-2"></i>
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        $('body').append(alert);
        
        setTimeout(() => {
            alert.alert('close');
        }, 5000);
    }
});

// Función global para editar usuario
function editarUsuario(usuarioId) {
    $.ajax({
        url: `/gestion/usuarios/editar/${usuarioId}/`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const usuario = response.usuario;
                
                $('#editar_usuario_id').val(usuario.id);
                $('#editar_dni').val(usuario.dni);
                $('#editar_nombre').val(usuario.nombre);
                $('#editar_apellido').val(usuario.apellido);
                $('#editar_email').val(usuario.email);
                $('#editar_perfil').val(usuario.perfil);
                $('#editar_is_active').prop('checked', usuario.is_active);
                $('#editar_nueva_password').val('');
                
                $('#modalEditarUsuario').modal('show');
            } else {
                mostrarMensaje(response.error, 'error');
            }
        },
        error: function(xhr) {
            console.error('Error:', xhr.responseText);
            mostrarMensaje('Error al cargar los datos del usuario', 'error');
        }
    });
}

// Función global para confirmar eliminación
function confirmarEliminarUsuario(usuarioId, nombreUsuario) {
    usuarioIdEliminar = usuarioId;
    $('#nombreUsuarioEliminar').text(nombreUsuario);
    $('#modalEliminarUsuario').modal('show');
}
</script>
{% endblock %}